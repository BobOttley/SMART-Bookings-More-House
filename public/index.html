<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Booking Admin - SMART CRM</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --blazer-navy: #091825;
      --award-gold: #FF9F1C;
      --sport-blue: #034674;
      --text-primary: #2C3E50;
      --white: #FFFFFF;
      --light-grey: #F8FAFC;
      --border-grey: #E5E7EB;
      --success: #10B981;
      --danger: #EF4444;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: #FAFBFC;
      min-height: 100vh;
      color: var(--text-primary);
    }

    .header {
      background: var(--blazer-navy);
      color: white;
      padding: 2rem;
      border-bottom: 3px solid var(--award-gold);
      text-align: center;
      position: relative;
    }

    .header h1 {
      font-family: 'Playfair Display', serif;
      font-size: 2.5rem;
    }

    .header p {
      margin-top: 0.5rem;
      color: rgba(255, 255, 255, 0.8);
    }

    /* Tab Container */
    .container {
      max-width: 98%;
      margin: 0 auto;
      padding: 0 0.1rem;
    }

    .tabs {
      display: flex;
      gap: 0.5rem;
      border-bottom: 2px solid var(--border-grey);
      margin-top: 2rem;
      background: white;
      border-radius: 8px 8px 0 0;
      padding: 0.5rem 0.5rem 0;
    }

    .tab-btn {
      background: transparent;
      border: none;
      padding: 1rem 2rem;
      font-size: 1.3rem;
      font-weight: 600;
      color: #6B7280;
      cursor: pointer;
      border-radius: 6px 6px 0 0;
      transition: all 0.2s ease;
      font-family: 'Inter', sans-serif;
      letter-spacing: 0.3px;
      position: relative;
      text-transform: uppercase;
      flex: 1;
      text-align: center;
      min-width: 0;
    }

    .tab-btn:hover {
      background: rgba(9, 24, 37, 0.05);
      color: var(--blazer-navy);
    }

    .tab-btn.active {
      background: var(--blazer-navy);
      color: white;
    }

    .tab-btn.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--award-gold);
    }

    .tab-btn.dragging {
      opacity: 0.5;
      cursor: move;
    }

    .tab-btn.drag-over {
      border-left: 3px solid var(--award-gold);
    }

    /* Settings Sub-tabs */
    .settings-subtab-btn {
      background: transparent;
      border: none;
      padding: 0.75rem 1.5rem;
      font-size: 0.875rem;
      font-weight: 600;
      color: #6B7280;
      cursor: pointer;
      border-radius: 6px 6px 0 0;
      transition: all 0.2s ease;
      font-family: 'Inter', sans-serif;
      position: relative;
    }

    .settings-subtab-btn:hover {
      background: rgba(9, 24, 37, 0.05);
      color: var(--blazer-navy);
    }

    .settings-subtab-btn.active {
      background: var(--blazer-navy);
      color: white;
    }

    .settings-subtab-btn.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--award-gold);
    }

    .settings-subtab-btn.dragging {
      opacity: 0.5;
      cursor: move;
    }

    .settings-subtab-btn.drag-over {
      border-left: 3px solid var(--award-gold);
    }

    .settings-subtab-content {
      display: none;
    }

    .settings-subtab-content.active {
      display: block;
    }

    /* Tab Content */
    .tab-content {
      background: white;
      min-height: calc(100vh - 300px);
      border-radius: 0 0 8px 8px;
      border: 1px solid var(--border-grey);
      border-top: none;
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .card {
      background: white;
      border-radius: 8px;
      padding: 2rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      margin-bottom: 2rem;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--light-grey);
    }

    .card-header h2 {
      font-size: 0.875rem;
      color: var(--blazer-navy);
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .btn-primary {
      background: var(--blazer-navy);
      color: white;
    }

    .btn-primary:hover {
      background: var(--award-gold);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-warning {
      background: #F59E0B;
      color: white;
    }

    .btn-secondary {
      background: #6B7280;
      color: white;
    }

    .btn-secondary:hover {
      background: #4B5563;
    }

    .btn-sm {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: var(--light-grey);
    }

    th, td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid var(--border-grey);
      font-size: 0.875rem;
    }

    th {
      font-weight: 600;
      color: var(--blazer-navy);
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.5px;
    }

    tbody tr:hover {
      background: var(--light-grey);
    }

    .badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .badge-confirmed {
      background: #D1FAE5;
      color: #065F46;
    }

    .badge-pending {
      background: #FEF3C7;
      color: #92400E;
    }

    .badge-cancelled {
      background: #FEE2E2;
      color: #991B1B;
    }

    .badge-published {
      background: #DBEAFE;
      color: #1E40AF;
    }

    .badge-declined {
      background: #FEE2E2;
      color: #991B1B;
    }

    .badge-warning {
      background: #FEF3C7;
      color: #92400E;
    }

    .badge-info {
      background: #DBEAFE;
      color: #1E40AF;
    }

    .badge-no-show {
      background: #FED7AA;
      color: #9A3412;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid var(--border-grey);
      border-radius: 6px;
      font-size: 1rem;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--award-gold);
      box-shadow: 0 0 0 3px rgba(255, 159, 28, 0.1);
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 8px;
      padding: 2rem;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--light-grey);
    }

    .modal-header h3 {
      font-size: 1.25rem;
      color: var(--blazer-navy);
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 0.875rem;
      cursor: pointer;
      color: #6B7280;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      border-left: 4px solid var(--award-gold);
    }

    .stat-card h3 {
      font-size: 0.875rem;
      color: #6B7280;
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-card p {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--blazer-navy);
    }

    .empty-state {
      text-align: center;
      padding: 3rem;
      color: #6B7280;
      font-size: 0.95rem;
    }

    .empty-state p {
      margin-top: 1rem;
    }

    /* Powered by branding */
    .powered-by {
      position: absolute;
      bottom: 15px;
      left: 30px;
      font-size: 0.7rem;
      font-style: normal;
      color: white;
      opacity: 0.9;
    }

    .bsmart-text {
      color: var(--award-gold);
      font-weight: 600;
    }

    .smart-text {
      color: var(--award-gold);
    }

    /* Footer Badge */
    .footer-badge {
      text-align: center;
      padding: 2rem;
      font-size: 0.7rem;
      font-style: normal;
      color: #9CA3AF;
      opacity: 0.9;
    }

    .footer-badge span {
      color: var(--award-gold);
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1><span class="smart-text">SMART</span> Booking System</h1>
    <p>Manage open days, private tours, and bookings</p>
    <div class="powered-by">Powered by <span class="bsmart-text">bSMART</span> ai</div>
  </div>

  <div class="container">
    <div class="tabs">
      <button class="tab-btn active" data-tab="dashboard"><span class="smart-text">SMART</span> Dashboard</button>
      <button class="tab-btn" data-tab="archive"><span class="smart-text">SMART</span> Archive</button>
      <button class="tab-btn" data-tab="events"><span class="smart-text">SMART</span> Events & Tours</button>
      <button class="tab-btn" data-tab="guides"><span class="smart-text">SMART</span> Tour Guides</button>
      <button class="tab-btn" data-tab="form-builder"><span class="smart-text">SMART</span> Form Builder</button>
      <button class="tab-btn" data-tab="survey-analytics"><span class="smart-text">SMART</span> Survey Analytics</button>
      <button class="tab-btn" data-tab="settings"><span class="smart-text">SMART</span> Settings</button>
    </div>

    <!-- Dashboard Tab -->
    <div class="tab-content active" id="dashboard-tab">
      <!-- Summary Stats -->
      <div id="dashboard-summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;"></div>

      <!-- Unified Draggable Bookings List -->
      <div class="card" style="border-left: 4px solid var(--award-gold);">
        <div style="padding: 1rem 1.5rem; background: #f8fafc; border-bottom: 3px solid var(--award-gold);">
          <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
            <h2 style="margin: 0; font-size: 1.25rem; color: var(--blazer-navy);">All Bookings</h2>
            <div style="flex: 1; max-width: 500px;">
              <input
                type="text"
                id="booking-search"
                placeholder="ðŸ” Search by family name, student name, or email..."
                style="width: 100%; padding: 0.75rem 1rem; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 0.875rem; transition: all 0.2s; font-family: 'Inter', sans-serif;"
                oninput="filterBookings(this.value)"
                onfocus="this.style.borderColor='var(--award-gold)'; this.style.boxShadow='0 0 0 3px rgba(255, 159, 28, 0.1)';"
                onblur="this.style.borderColor='#E5E7EB'; this.style.boxShadow='none';"
              >
            </div>
          </div>
        </div>
        <div id="dashboard-unified-list" style="max-height: 75vh; overflow-y: auto;"></div>
      </div>
    </div>

    <!-- Archive Tab -->
    <div class="tab-content" id="archive-tab">
      <!-- Summary Stats -->
      <div id="archive-summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;"></div>

      <!-- Unified Draggable Archive List -->
      <div class="card" style="border-left: 4px solid #6B7280;">
        <div style="padding: 1rem 1.5rem; background: #f8fafc; border-bottom: 3px solid #6B7280;">
          <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
            <h2 style="margin: 0; font-size: 1.25rem; color: var(--blazer-navy);">Archived Events & Tours</h2>
            <div style="flex: 1; max-width: 500px;">
              <input
                type="text"
                id="archive-search"
                placeholder="ðŸ” Search archived bookings..."
                style="width: 100%; padding: 0.75rem 1rem; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 0.875rem; transition: all 0.2s; font-family: 'Inter', sans-serif;"
                oninput="filterArchive(this.value)"
                onfocus="this.style.borderColor='#6B7280'; this.style.boxShadow='0 0 0 3px rgba(107, 114, 128, 0.1)';"
                onblur="this.style.borderColor='#E5E7EB'; this.style.boxShadow='none';"
              >
            </div>
          </div>
        </div>
        <div id="archive-unified-list" style="max-height: 75vh; overflow-y: auto;"></div>
      </div>
    </div>

    <!-- Events Tab -->
    <div class="tab-content" id="events-tab">
      <div class="card">
        <div class="card-header">
          <h2>Events & Tours</h2>
          <button class="btn btn-primary" onclick="showCreateEventModal()">Create Event</button>
        </div>
        <div id="events-list"></div>
      </div>
    </div>

    <!-- Tour Guides Tab -->
    <div class="tab-content" id="guides-tab">
      <div class="card">
        <div class="card-header">
          <h2>Tour Guides</h2>
          <div style="display: flex; gap: 1rem;">
            <button class="btn btn-primary" onclick="showPrintGuideAssignmentsModal()" style="background: #034674;">Print Assignments</button>
            <button class="btn btn-primary" onclick="showCreateGuideModal()">Add Guide</button>
          </div>
        </div>
        <div id="guides-list"></div>
      </div>
    </div>

    <!-- Form Builder Tab -->
    <div class="tab-content" id="form-builder-tab">
      <div class="card">
        <div class="card-header">
          <h2>Enquiry Form Builder</h2>
          <p style="color: #6B7280; margin-top: 0.5rem;">Customise the enquiry form shown to parents when they don't use the Personalised Prospectus App</p>
        </div>
        <div class="card-body">
          <div id="form-builder-container"></div>
        </div>
      </div>
    </div>

    <!-- Survey Analytics Tab -->
    <div class="tab-content" id="survey-analytics-tab">
      <iframe src="feedback-dashboard.html" style="width: 100%; height: calc(100vh - 120px); border: none;"></iframe>
    </div>

    <!-- Settings Tab -->
    <div class="tab-content" id="settings-tab">
      <div style="background: white; border-bottom: 2px solid var(--border-grey); padding: 1rem 1rem 0;">
        <div class="tabs" style="border: none; padding: 0;">
          <button class="settings-subtab-btn active" data-subtab="survey-questions"><span class="smart-text">SMART</span> Survey Questions</button>
          <button class="settings-subtab-btn" data-subtab="tour-feedback"><span class="smart-text">SMART</span> Tour Feedback</button>
          <button class="settings-subtab-btn" data-subtab="email-templates"><span class="smart-text">SMART</span> Email Templates</button>
          <button class="settings-subtab-btn" data-subtab="email-config"><span class="smart-text">SMART</span> Email Configuration</button>
          <button class="settings-subtab-btn" data-subtab="email-timing"><span class="smart-text">SMART</span> Email Timing</button>
          <button class="settings-subtab-btn" data-subtab="booking-settings"><span class="smart-text">SMART</span> Booking Settings</button>
          <button class="settings-subtab-btn" data-subtab="prospectus"><span class="smart-text">SMART</span> Prospectus Integration</button>
          <button class="settings-subtab-btn" data-subtab="branding"><span class="smart-text">SMART</span> Branding</button>
        </div>
      </div>

      <!-- Survey Questions Sub-tab -->
      <div class="settings-subtab-content active" id="survey-questions-subtab">
        <iframe src="feedback-settings.html?v=9999" style="width: 100%; height: calc(100vh - 180px); border: none;"></iframe>
      </div>

      <!-- Tour Feedback Sub-tab -->
      <div class="settings-subtab-content" id="tour-feedback-subtab">
        <iframe src="tour-feedback-settings.html?v=9999" style="width: 100%; height: calc(100vh - 180px); border: none;"></iframe>
      </div>

      <!-- Email Templates Sub-tab -->
      <div class="settings-subtab-content" id="email-templates-subtab">
        <div class="card" style="margin: 1.5rem; border-radius: 0;">
          <div class="card-header">
            <h2>Email Templates</h2>
            <button class="btn btn-primary" onclick="showCreateEmailTemplateModal()">Create Template</button>
          </div>
          <div id="email-templates-list"></div>
        </div>
      </div>

      <!-- Email Configuration Sub-tab -->
      <div class="settings-subtab-content" id="email-config-subtab">
        <div class="card" style="margin: 1.5rem; border-radius: 0;">
          <div class="card-header">
            <h2>Email Configuration</h2>
          </div>
          <div id="email-settings-alert" style="display: none; margin-bottom: 1.5rem;"></div>

          <form id="email-settings-form">
            <div class="form-group">
              <label class="form-label">SMTP Host *</label>
              <input type="text" class="form-input" name="smtp_host" placeholder="smtp.gmail.com or smtp.office365.com" required>
              <small style="display: block; margin-top: 0.5rem; color: #6B7280;">
                Google: smtp.gmail.com | Microsoft: smtp.office365.com
              </small>
            </div>

            <div class="form-group">
              <label class="form-label">SMTP Port *</label>
              <input type="number" class="form-input" name="smtp_port" placeholder="587" required>
              <small style="display: block; margin-top: 0.5rem; color: #6B7280;">
                Use 587 for TLS (recommended) or 465 for SSL
              </small>
            </div>

            <div class="form-group">
              <label class="form-label">Email Username *</label>
              <input type="email" class="form-input" name="smtp_username" placeholder="booking@yourschool.com" required>
              <small style="display: block; margin-top: 0.5rem; color: #6B7280;">
                The email address you'll send from
              </small>
            </div>

            <div class="form-group">
              <label class="form-label">Email Password *</label>
              <input type="password" class="form-input" name="smtp_password" placeholder="Enter email password" required>
              <small style="display: block; margin-top: 0.5rem; color: #6B7280;">
                For Google Workspace or Microsoft 365, you can use your regular password
              </small>
            </div>

            <div class="form-group">
              <label class="form-label">From Email *</label>
              <input type="email" class="form-input" name="smtp_from_email" placeholder="booking@yourschool.com" required>
              <small style="display: block; margin-top: 0.5rem; color: #6B7280;">
                Email address that appears as sender
              </small>
            </div>

            <div class="form-group">
              <label class="form-label">From Name *</label>
              <input type="text" class="form-input" name="smtp_from_name" placeholder="School Bookings" required>
              <small style="display: block; margin-top: 0.5rem; color: #6B7280;">
                Display name for sender (e.g., "More House School Bookings")
              </small>
            </div>

            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" name="smtp_use_tls" checked style="width: 18px; height: 18px;">
                <span class="form-label" style="margin: 0;">Use TLS (Recommended)</span>
              </label>
              <small style="display: block; margin-top: 0.5rem; margin-left: 24px; color: #6B7280;">
                Keep this checked for secure email transmission
              </small>
            </div>

            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
              <button type="submit" class="btn btn-primary" style="flex: 1;">
                Save Email Settings
              </button>
              <button type="button" class="btn btn-secondary" onclick="testEmailSettings()" style="flex: 1;">
                Send Test Email
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Email Timing Sub-tab -->
      <div class="settings-subtab-content" id="email-timing-subtab">
        <div class="card" style="margin: 1.5rem; border-radius: 0;">
          <div class="card-header">
            <h2>Email Reminder Timing</h2>
          </div>

          <form id="email-timing-form">
            <h3 style="font-size: 1.1rem; color: var(--blazer-navy); margin-bottom: 1.5rem; font-weight: 600;">
              Parent Email Reminders
            </h3>

            <div class="form-group">
              <label class="form-label">First Reminder (Days Before Event) *</label>
              <input type="number" class="form-input" name="reminder_days_before_1" placeholder="7" min="0" max="365" required>
              <small style="display: block; margin-top: 0.5rem; color: #6B7280;">
                How many days before the event should the first reminder be sent? (e.g., 7 days)
              </small>
            </div>

            <div class="form-group">
              <label class="form-label">Second Reminder (Days Before Event) *</label>
              <input type="number" class="form-input" name="reminder_days_before_2" placeholder="1" min="0" max="365" required>
              <small style="display: block; margin-top: 0.5rem; color: #6B7280;">
                How many days before the event should the second reminder be sent? (e.g., 1 day)
              </small>
            </div>

            <div class="form-group">
              <label class="form-label">Follow-up Email (Days After Event) *</label>
              <input type="number" class="form-input" name="followup_days_after" placeholder="1" min="0" max="365" required>
              <small style="display: block; margin-top: 0.5rem; color: #6B7280;">
                How many days after the event should the follow-up email be sent? (e.g., 1 day)
              </small>
            </div>

            <div style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid var(--border-grey);">
              <h3 style="font-size: 1.1rem; color: var(--blazer-navy); margin-bottom: 1.5rem; font-weight: 600;">
                Tour Guide Reminder Timing
              </h3>

              <div class="form-group">
                <label class="form-label">First Reminder to Guide (Days Before Tour) *</label>
                <input type="number" class="form-input" name="guide_reminder_days_before_1" placeholder="3" min="0" max="365" required>
                <small style="display: block; margin-top: 0.5rem; color: #6B7280;">
                  How many days before the tour should the first reminder be sent to the tour guide? (e.g., 3 days)
                </small>
              </div>

              <div class="form-group">
                <label class="form-label">Final Reminder to Guide (Days Before Tour) *</label>
                <input type="number" class="form-input" name="guide_reminder_days_before_2" placeholder="1" min="0" max="365" required>
                <small style="display: block; margin-top: 0.5rem; color: #6B7280;">
                  How many days before the tour should the final reminder be sent to the tour guide? (e.g., 1 day)
                </small>
              </div>
            </div>

            <button type="submit" class="btn btn-primary" style="margin-top: 2rem;">
              Save Timing Settings
            </button>
          </form>
        </div>
      </div>

      <!-- Booking Settings Sub-tab -->
      <div class="settings-subtab-content" id="booking-settings-subtab">
        <div class="card" style="margin: 1.5rem; border-radius: 0;">
          <div class="card-header">
            <h2>Booking Settings</h2>
          </div>
          <div id="settings-form"></div>
        </div>
      </div>

      <!-- Prospectus Integration Sub-tab -->
      <div class="settings-subtab-content" id="prospectus-subtab">
        <div class="card" style="margin: 1.5rem; border-radius: 0;">
          <div class="card-header">
            <h2>Prospectus Integration</h2>
          </div>
          <div id="prospectus-form"></div>
        </div>
      </div>

      <!-- Branding Sub-tab -->
      <div class="settings-subtab-content" id="branding-subtab">
        <div class="card" style="margin: 1.5rem; border-radius: 0;">
          <div class="card-header">
            <h2>Branding</h2>
          </div>
          <div id="branding-form"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Event Modal -->
  <div class="modal" id="createEventModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Create Event</h3>
        <button class="close-btn" onclick="closeModal('createEventModal')">&times;</button>
      </div>
      <form id="createEventForm">
        <div class="form-group">
          <label class="form-label">Event Type</label>
          <select class="form-select" name="event_type" required>
            <option value="open_day">Open Day</option>
            <option value="private_tour">Private Tour</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Title</label>
          <input type="text" class="form-input" name="title" required>
        </div>
        <div class="form-group">
          <label class="form-label">Description</label>
          <textarea class="form-textarea" name="description"></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Event Date</label>
          <input type="date" class="form-input" name="event_date" required>
        </div>
        <div class="form-group">
          <label class="form-label">Start Time</label>
          <input type="time" class="form-input" name="start_time" required>
        </div>
        <div class="form-group">
          <label class="form-label">End Time</label>
          <input type="time" class="form-input" name="end_time" required>
        </div>
        <div class="form-group">
          <label class="form-label">Location</label>
          <input type="text" class="form-input" name="location">
        </div>
        <div class="form-group">
          <label class="form-label">Max Capacity</label>
          <input type="number" class="form-input" name="max_capacity" value="50" required>
        </div>
        <button type="submit" class="btn btn-primary">Create Event</button>
      </form>
    </div>
  </div>

  <!-- Edit Event Modal -->
  <div class="modal" id="editEventModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Edit Event</h3>
        <button class="close-btn" onclick="closeModal('editEventModal')">&times;</button>
      </div>
      <form id="editEventForm">
        <input type="hidden" id="edit-event-id">
        <div class="form-group">
          <label class="form-label">Event Type</label>
          <select class="form-select" id="edit-event-type" required>
            <option value="open_day">Open Day</option>
            <option value="private_tour">Private Tour</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Title *</label>
          <input type="text" class="form-input" id="edit-event-title" required>
        </div>
        <div class="form-group">
          <label class="form-label">Description</label>
          <textarea class="form-textarea" id="edit-event-description"></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Event Date *</label>
          <input type="date" class="form-input" id="edit-event-date" required>
        </div>
        <div class="form-group">
          <label class="form-label">Start Time *</label>
          <input type="time" class="form-input" id="edit-event-start-time" required>
        </div>
        <div class="form-group">
          <label class="form-label">End Time *</label>
          <input type="time" class="form-input" id="edit-event-end-time" required>
        </div>
        <div class="form-group">
          <label class="form-label">Location</label>
          <input type="text" class="form-input" id="edit-event-location">
        </div>
        <div class="form-group">
          <label class="form-label">Max Capacity</label>
          <input type="number" class="form-input" id="edit-event-max-capacity" required>
        </div>
        <div class="form-group">
          <label class="form-label">Status</label>
          <select class="form-select" id="edit-event-status" required>
            <option value="published">Published</option>
            <option value="draft">Draft</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </div>
        <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1.5rem;">
          <button type="button" class="btn btn-secondary" onclick="closeModal('editEventModal')">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Create Guide Modal -->
  <div class="modal" id="createGuideModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add Tour Guide</h3>
        <button class="close-btn" onclick="closeModal('createGuideModal')">&times;</button>
      </div>
      <form id="createGuideForm">
        <div class="form-group">
          <label class="form-label">Name</label>
          <input type="text" class="form-input" name="name" required>
        </div>
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" class="form-input" name="email">
        </div>
        <div class="form-group">
          <label class="form-label">Phone</label>
          <input type="tel" class="form-input" name="phone">
        </div>
        <div class="form-group">
          <label class="form-label">Type</label>
          <select class="form-select" name="type" required>
            <option value="staff">Staff</option>
            <option value="student">Student</option>
          </select>
        </div>
        <button type="submit" class="btn btn-primary">Add Guide</button>
      </form>
    </div>
  </div>

  <!-- Edit Tour Guide Modal -->
  <div class="modal" id="editGuideModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Edit Tour Guide</h3>
        <button class="close-btn" onclick="closeModal('editGuideModal')">&times;</button>
      </div>
      <form id="editGuideForm">
        <input type="hidden" id="edit-guide-id">
        <div class="form-group">
          <label class="form-label">Name</label>
          <input type="text" class="form-input" id="edit-guide-name" required>
        </div>
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" class="form-input" id="edit-guide-email">
        </div>
        <div class="form-group">
          <label class="form-label">Phone</label>
          <input type="tel" class="form-input" id="edit-guide-phone">
        </div>
        <div class="form-group">
          <label class="form-label">Type</label>
          <select class="form-select" id="edit-guide-type" required>
            <option value="staff">Staff</option>
            <option value="student">Student</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">
            <input type="checkbox" id="edit-guide-active" style="width: auto; margin-right: 0.5rem;">
            Active
          </label>
        </div>
        <button type="submit" class="btn btn-primary">Save Changes</button>
      </form>
    </div>
  </div>

  <!-- Schedule Tour Modal -->
  <div class="modal" id="scheduleTourModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Schedule Tour: <span id="schedule-parent-name"></span></h3>
        <button class="close-btn" onclick="closeModal('scheduleTourModal')">&times;</button>
      </div>

      <!-- Parent's Request Information -->
      <div id="parent-request-info" style="display: none; background: #F0F9FF; border: 2px solid #3B82F6; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
        <h4 style="color: #1E40AF; margin-bottom: 0.75rem; font-size: 0.95rem;">Parent's Request</h4>
        <div id="request-details" style="font-size: 0.875rem; color: #1E3A8A;"></div>
      </div>

      <form id="scheduleTourForm">
        <input type="hidden" id="schedule-booking-id">
        <div class="form-group">
          <label class="form-label">Tour Date</label>
          <input type="date" class="form-input" id="schedule-date" required>
        </div>
        <div class="form-group">
          <label class="form-label">Tour Time</label>
          <input type="time" class="form-input" id="schedule-time" required>
        </div>
        <div class="form-group">
          <label class="form-label">Assign Tour Guide (Optional)</label>
          <select class="form-select" id="schedule-guide">
            <option value="">No guide assigned</option>
          </select>
        </div>
        <button type="submit" class="btn btn-success">Confirm & Schedule Tour</button>
      </form>
    </div>
  </div>

  <!-- Decline Tour Modal -->
  <div class="modal" id="declineTourModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Decline Tour: <span id="decline-parent-name"></span></h3>
        <button class="close-btn" onclick="closeModal('declineTourModal')">&times;</button>
      </div>
      <form id="declineTourForm">
        <input type="hidden" id="decline-booking-id">
        <div class="form-group">
          <label class="form-label">Reason for Declining</label>
          <textarea class="form-input" id="decline-reason" rows="3" placeholder="e.g., Requested date not available"></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Offer Alternative Dates</label>
          <div id="alternative-dates-container">
            <div class="alternative-date-row" style="display: flex; gap: 10px; margin-bottom: 10px;">
              <input type="date" class="form-input alt-date" style="flex: 1;">
              <input type="time" class="form-input alt-time" style="flex: 1;">
            </div>
          </div>
          <button type="button" class="btn btn-sm" onclick="addAlternativeDateRow()" style="background: var(--sport-blue); color: white; margin-top: 5px;">+ Add Another Date</button>
        </div>
        <button type="submit" class="btn btn-danger">Decline Tour</button>
      </form>
    </div>
  </div>

  <!-- Assign Guide Modal -->
  <div class="modal" id="assignGuideModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Assign Tour Guide: <span id="assign-student-name"></span></h3>
        <button class="close-btn" onclick="closeModal('assignGuideModal')">&times;</button>
      </div>
      <form id="assignGuideForm" onsubmit="event.preventDefault(); submitAssignGuide();">
        <input type="hidden" id="assign-booking-id">
        <div class="form-group">
          <label class="form-label">Select Tour Guide *</label>
          <select class="form-select" id="assign-guide-select" required>
            <option value="">Select a tour guide</option>
          </select>
        </div>
        <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1.5rem;">
          <button type="button" class="btn btn-secondary" onclick="closeModal('assignGuideModal')">Cancel</button>
          <button type="submit" class="btn btn-primary" style="background: #034674;">Assign Guide</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Print Guide Assignments Modal -->
  <div class="modal" id="printGuideAssignmentsModal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3>Print Guide Assignments</h3>
        <button class="close-btn" onclick="closeModal('printGuideAssignmentsModal')">&times;</button>
      </div>
      <form id="printGuideAssignmentsForm" onsubmit="event.preventDefault(); printGuideAssignments();">
        <div class="form-group">
          <label class="form-label">Select Open Day Event *</label>
          <select class="form-select" id="print-event-select" required>
            <option value="">Select an event</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Filter by Guide (Optional)</label>
          <select class="form-select" id="print-guide-select">
            <option value="">All Guides</option>
          </select>
        </div>
        <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1.5rem;">
          <button type="button" class="btn btn-secondary" onclick="closeModal('printGuideAssignmentsModal')">Cancel</button>
          <button type="submit" class="btn btn-primary" style="background: #034674;">Generate Print View</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Booking Modal -->
  <div class="modal" id="editBookingModal">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h3>Edit Booking: <span id="edit-booking-reference"></span></h3>
        <button class="close-btn" onclick="closeModal('editBookingModal')">&times;</button>
      </div>
      <form id="editBookingForm">
        <input type="hidden" id="edit-booking-id">

        <h4 style="color: var(--blazer-navy); margin-top: 0; margin-bottom: 1rem;">Parent Information</h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div class="form-group">
            <label class="form-label">Parent First Name *</label>
            <input type="text" class="form-input" id="edit-parent-first-name" required>
          </div>
          <div class="form-group">
            <label class="form-label">Parent Last Name *</label>
            <input type="text" class="form-input" id="edit-parent-last-name" required>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Email Address *</label>
          <input type="email" class="form-input" id="edit-email" required>
        </div>

        <div class="form-group">
          <label class="form-label">Phone Number *</label>
          <input type="tel" class="form-input" id="edit-phone" required>
        </div>

        <h4 style="color: var(--blazer-navy); margin-top: 1.5rem; margin-bottom: 1rem;">Student Information</h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div class="form-group">
            <label class="form-label">Student First Name *</label>
            <input type="text" class="form-input" id="edit-student-first-name" required>
          </div>
          <div class="form-group">
            <label class="form-label">Student Last Name</label>
            <input type="text" class="form-input" id="edit-student-last-name">
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Age Group</label>
          <input type="text" class="form-input" id="edit-age-group" readonly style="background-color: #F3F4F6; cursor: not-allowed;">
        </div>

        <h4 style="color: var(--blazer-navy); margin-top: 1.5rem; margin-bottom: 1rem;">Booking Details</h4>
        <div class="form-group">
          <label class="form-label">Number of Attendees *</label>
          <input type="number" class="form-input" id="edit-num-attendees" min="1" required>
        </div>

        <div class="form-group">
          <label class="form-label">Assigned Tour Guide</label>
          <select class="form-select" id="edit-assigned-guide">
            <option value="">No guide assigned</option>
          </select>
          <small style="color: #6B7280; display: block; margin-top: 0.5rem;">
            Changing the tour guide will notify both the old and new guides via email
          </small>
        </div>
        <input type="hidden" id="edit-original-guide-id">

        <div class="form-group">
          <label class="form-label">Special Requirements</label>
          <textarea class="form-input" id="edit-special-requirements" rows="4" placeholder="Any special requirements or notes..."></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Preferred Language</label>
          <input type="text" class="form-input" id="edit-preferred-language" placeholder="e.g., English, Spanish">
        </div>

        <h4 style="color: var(--blazer-navy); margin-top: 1.5rem; margin-bottom: 1rem; padding-top: 1.5rem; border-top: 2px solid var(--border-grey);">
          Conversion Outcome
        </h4>
        <div class="form-group">
          <label class="form-label">Status</label>
          <select class="form-select" id="edit-outcome-status">
            <option value="">No status set</option>
            <option value="interested">Interested</option>
            <option value="applied">Applied</option>
            <option value="enrolled">Enrolled</option>
            <option value="declined">Declined</option>
          </select>
          <small style="color: #6B7280; display: block; margin-top: 0.5rem;">
            Track where this family is in the enrollment funnel
          </small>
        </div>

        <div class="form-group" id="enrollment-year-group" style="display: none;">
          <label class="form-label">Enrollment Year</label>
          <input type="text" class="form-input" id="edit-enrollment-year" placeholder="e.g., 2025/2026">
          <small style="color: #6B7280; display: block; margin-top: 0.5rem;">
            Which academic year will they be enrolling for?
          </small>
        </div>

        <div class="form-group">
          <label class="form-label">Outcome Notes</label>
          <textarea class="form-input" id="edit-outcome-notes" rows="3" placeholder="Additional notes about this family's journey..."></textarea>
        </div>

        <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1.5rem;">
          <button type="button" class="btn btn-secondary" onclick="closeModal('editBookingModal')">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Create/Edit Email Template Modal -->
  <div class="modal" id="emailTemplateModal">
    <div class="modal-content" style="max-width: 900px;">
      <div class="modal-header">
        <h3 id="emailTemplateModalTitle">Create Email Template</h3>
        <button class="close-btn" onclick="closeModal('emailTemplateModal')">&times;</button>
      </div>
      <form id="emailTemplateForm">
        <input type="hidden" id="template-id">

        <div class="form-group">
          <label class="form-label">Template Name *</label>
          <input type="text" class="form-input" id="template-name" placeholder="e.g. Tour Confirmation Email" required>
        </div>

        <div class="form-group">
          <label class="form-label">Booking Type *</label>
          <select class="form-select" id="template-booking-type" required>
            <option value="">Select booking type...</option>
            <option value="open_day">Open Day</option>
            <option value="private_tour">Private Tour</option>
            <option value="taster_day">Taster Day</option>
            <option value="both">Both (Open Day & Private Tour)</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Template Type *</label>
          <select class="form-select" id="template-type" required>
            <option value="">Select type...</option>
            <option value="booking_confirmation">Booking Confirmation</option>
            <option value="tour_scheduled">Tour Scheduled</option>
            <option value="tour_declined">Tour Declined</option>
            <option value="tour_reminder">Tour Reminder</option>
            <option value="no_show">No Show Follow Up</option>
            <option value="follow_up">Follow Up</option>
            <option value="custom">Custom</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Email Subject *</label>
          <input type="text" class="form-input" id="template-subject" placeholder="e.g. Your Tour at {{school_name}}" required>
        </div>

        <div class="form-group">
          <label class="form-label">Email Body (HTML supported) *</label>
          <textarea class="form-textarea" id="template-body" rows="12" placeholder="Use {{variable_name}} for personalization" required></textarea>
          <small style="color: #6B7280; display: block; margin-top: 0.5rem;">
            Available variables: {{parent_name}}, {{student_name}}, {{tour_date}}, {{tour_time}}, {{tour_guide}}, {{school_name}}, {{booking_type}}, {{num_attendees}}
          </small>
        </div>

        <div class="form-group">
          <label class="form-label">
            <input type="checkbox" id="template-active" checked> Active
          </label>
        </div>

        <div style="border-top: 2px solid var(--border-grey); padding-top: 1.5rem; margin-top: 1.5rem;">
          <h4 style="color: var(--blazer-navy); margin-bottom: 1rem;">Automation Settings (Optional)</h4>

          <div class="form-group">
            <label class="form-label">
              <input type="checkbox" id="enable-automation"> Enable Automatic Sending
            </label>
          </div>

          <div id="automation-settings" style="display: none; margin-top: 1rem;">
            <div class="form-group">
              <label class="form-label">Trigger Event</label>
              <select class="form-select" id="automation-trigger">
                <option value="">Select trigger...</option>
                <option value="on_booking">When booking is made</option>
                <option value="on_schedule">When tour is scheduled</option>
                <option value="on_decline">When tour is declined</option>
                <option value="on_check_in">When checked in</option>
                <option value="on_feedback_submitted">When guide feedback is received</option>
                <option value="on_no_show">When marked as no-show</option>
                <option value="before_tour">Before tour date</option>
                <option value="after_tour">After tour date</option>
              </select>
            </div>

            <div class="form-group" id="timing-group" style="display: none;">
              <label class="form-label">Send</label>
              <div style="display: flex; gap: 0.5rem; align-items: center;">
                <input type="number" class="form-input" id="automation-days" min="1" value="1" style="width: 80px;">
                <span>days</span>
                <select class="form-select" id="automation-timing" style="width: auto;">
                  <option value="before">before</option>
                  <option value="after">after</option>
                </select>
                <span>the tour</span>
              </div>
            </div>
          </div>
        </div>

        <button type="submit" class="btn btn-primary" style="margin-top: 1.5rem;">Save Template</button>
      </form>
    </div>
  </div>

  <script>
    // ============================================================================
    // AUTHENTICATION CHECK
    // ============================================================================

    // Check if user is authenticated before loading the page
    async function checkAuth() {
      try {
        const response = await fetch('/api/admin/check-auth', {
          credentials: 'include'
        });
        const data = await response.json();

        if (!data.authenticated) {
          console.log('[BOOKING APP] Not authenticated, redirecting to login...');
          window.location.href = '/login.html';
          return false;
        }

        console.log('[BOOKING APP] Authenticated as:', data.email);
        return true;
      } catch (error) {
        console.error('[BOOKING APP] Auth check failed:', error);
        window.location.href = '/login.html';
        return false;
      }
    }

    // Version: 2025-11-10-18:07 - Fixed onclick handlers and email test
    console.log('ðŸš€ Booking App v2025-11-10-18:07 loaded');

    // Run auth check immediately
    checkAuth().then(authenticated => {
      if (!authenticated) {
        return; // Stop execution if not authenticated
      }

      // Continue with page initialization
      init();
    });

    // ============================================================================
    // MAIN INITIALIZATION
    // ============================================================================

    function init() {
      // Configuration
      const SCHOOL_ID = 2; // More House School - change this for different schools
      const API_URL = window.location.origin;

    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tabName = btn.dataset.tab;

        // Remove active class
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

        // Add active class
        btn.classList.add('active');
        document.getElementById(`${tabName}-tab`).classList.add('active');

        // Load data for tab
        loadTabData(tabName);
      });
    });

    // Settings sub-tab switching
    document.querySelectorAll('.settings-subtab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const subtabName = btn.dataset.subtab;

        // Remove active class from all sub-tabs
        document.querySelectorAll('.settings-subtab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.settings-subtab-content').forEach(c => c.classList.remove('active'));

        // Add active class to clicked sub-tab
        btn.classList.add('active');
        document.getElementById(`${subtabName}-subtab`).classList.add('active');

        // Load data for specific sub-tabs
        if (subtabName === 'prospectus' && currentSettings) {
          renderProspectusSettings(currentSettings);
        } else if (subtabName === 'branding' && currentSettings) {
          renderBrandingSettings(currentSettings);
        }
      });
    });

    // ====================
    // DRAG AND DROP FOR TABS
    // ====================

    let draggedElement = null;

    // Make main tabs draggable
    function initializeDraggableTabs() {
      const tabContainer = document.querySelector('.tabs');
      const tabs = tabContainer.querySelectorAll('.tab-btn');

      tabs.forEach(tab => {
        tab.setAttribute('draggable', 'true');

        tab.addEventListener('dragstart', (e) => {
          draggedElement = tab;
          tab.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
        });

        tab.addEventListener('dragend', (e) => {
          tab.classList.remove('dragging');
          document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('drag-over'));
        });

        tab.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';

          if (draggedElement !== tab) {
            tab.classList.add('drag-over');
          }
        });

        tab.addEventListener('dragleave', (e) => {
          tab.classList.remove('drag-over');
        });

        tab.addEventListener('drop', (e) => {
          e.preventDefault();
          tab.classList.remove('drag-over');

          if (draggedElement !== tab) {
            const allTabs = [...tabContainer.querySelectorAll('.tab-btn')];
            const draggedIndex = allTabs.indexOf(draggedElement);
            const targetIndex = allTabs.indexOf(tab);

            if (draggedIndex < targetIndex) {
              tab.parentNode.insertBefore(draggedElement, tab.nextSibling);
            } else {
              tab.parentNode.insertBefore(draggedElement, tab);
            }

            // Save tab order to localStorage
            saveTabOrder();
          }
        });
      });
    }

    // Make settings sub-tabs draggable
    function initializeDraggableSubTabs() {
      const subtabContainer = document.querySelector('#settings-tab .tabs');
      if (!subtabContainer) return;

      const subtabs = subtabContainer.querySelectorAll('.settings-subtab-btn');

      subtabs.forEach(subtab => {
        subtab.setAttribute('draggable', 'true');

        subtab.addEventListener('dragstart', (e) => {
          draggedElement = subtab;
          subtab.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
        });

        subtab.addEventListener('dragend', (e) => {
          subtab.classList.remove('dragging');
          document.querySelectorAll('.settings-subtab-btn').forEach(t => t.classList.remove('drag-over'));
        });

        subtab.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';

          if (draggedElement !== subtab) {
            subtab.classList.add('drag-over');
          }
        });

        subtab.addEventListener('dragleave', (e) => {
          subtab.classList.remove('drag-over');
        });

        subtab.addEventListener('drop', (e) => {
          e.preventDefault();
          subtab.classList.remove('drag-over');

          if (draggedElement !== subtab) {
            const allSubtabs = [...subtabContainer.querySelectorAll('.settings-subtab-btn')];
            const draggedIndex = allSubtabs.indexOf(draggedElement);
            const targetIndex = allSubtabs.indexOf(subtab);

            if (draggedIndex < targetIndex) {
              subtab.parentNode.insertBefore(draggedElement, subtab.nextSibling);
            } else {
              subtab.parentNode.insertBefore(draggedElement, subtab);
            }

            // Save subtab order to localStorage
            saveSubTabOrder();
          }
        });
      });
    }

    // Save tab order to localStorage
    function saveTabOrder() {
      const tabs = document.querySelectorAll('.tab-btn');
      const order = Array.from(tabs).map(tab => tab.dataset.tab);
      localStorage.setItem('tabOrder', JSON.stringify(order));
    }

    // Save sub-tab order to localStorage
    function saveSubTabOrder() {
      const subtabs = document.querySelectorAll('.settings-subtab-btn');
      const order = Array.from(subtabs).map(subtab => subtab.dataset.subtab);
      localStorage.setItem('subtabOrder', JSON.stringify(order));
    }

    // Restore tab order from localStorage
    function restoreTabOrder() {
      const savedOrder = localStorage.getItem('tabOrder');
      if (!savedOrder) return;

      const order = JSON.parse(savedOrder);
      const tabContainer = document.querySelector('.tabs');
      const tabs = tabContainer.querySelectorAll('.tab-btn');

      order.forEach(tabName => {
        const tab = Array.from(tabs).find(t => t.dataset.tab === tabName);
        if (tab) {
          tabContainer.appendChild(tab);
        }
      });
    }

    // Restore sub-tab order from localStorage
    function restoreSubTabOrder() {
      const savedOrder = localStorage.getItem('subtabOrder');
      if (!savedOrder) return;

      const order = JSON.parse(savedOrder);
      const subtabContainer = document.querySelector('#settings-tab .tabs');
      if (!subtabContainer) return;

      const subtabs = subtabContainer.querySelectorAll('.settings-subtab-btn');

      order.forEach(subtabName => {
        const subtab = Array.from(subtabs).find(t => t.dataset.subtab === subtabName);
        if (subtab) {
          subtabContainer.appendChild(subtab);
        }
      });
    }

    // Initialize drag and drop on page load
    restoreTabOrder();
    initializeDraggableTabs();

    // Initialize sub-tabs when settings tab is shown
    document.querySelectorAll('[data-tab="settings"]').forEach(btn => {
      btn.addEventListener('click', () => {
        setTimeout(() => {
          restoreSubTabOrder();
          initializeDraggableSubTabs();
        }, 100);
      });
    });

    // Modal functions
    function showCreateEventModal() {
      document.getElementById('createEventModal').classList.add('show');
    }

    function showCreateGuideModal() {
      document.getElementById('createGuideModal').classList.add('show');
    }

    function showCreateEmailTemplateModal() {
      document.getElementById('emailTemplateForm').reset();
      document.getElementById('template-id').value = '';
      document.getElementById('emailTemplateModalTitle').textContent = 'Create Email Template';
      document.getElementById('automation-settings').style.display = 'none';
      document.getElementById('timing-group').style.display = 'none';
      document.getElementById('emailTemplateModal').classList.add('show');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('show');
    }

    // Load data based on tab
    function loadTabData(tab) {
      switch(tab) {
        case 'dashboard':
          loadDashboard();
          break;
        case 'archive':
          loadArchive();
          break;
        case 'events':
          loadEvents();
          break;
        case 'guides':
          loadGuides();
          break;
        case 'form-builder':
          loadFormBuilder();
          break;
        case 'survey-analytics':
          // Survey analytics loads via iframe, no data loading needed
          break;
        case 'settings':
          // Load email templates for the email-templates sub-tab
          loadEmailTemplates();
          loadSettings();
          loadEmailSettings();
          break;
      }
    }

    // Dashboard
    async function loadDashboard() {
      try {
        // Fetch both bookings and events in parallel
        const [bookingsRes, eventsRes] = await Promise.all([
          fetch(`${API_URL}/api/bookings?schoolId=${SCHOOL_ID}`),
          fetch(`${API_URL}/api/events?schoolId=${SCHOOL_ID}`)
        ]);

        const bookingsData = await bookingsRes.json();
        const eventsData = await eventsRes.json();

        renderDashboardBookings(bookingsData.bookings || [], eventsData.events || []);
      } catch (error) {
        console.error('Dashboard load error:', error);
      }
    }

    function renderDashboardBookings(bookings, events) {
      console.log('[DASHBOARD] renderDashboardBookings called with', bookings.length, 'bookings and', events.length, 'events');

      // Filter out archived items
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      // Filter events - only show future/current events
      const activeEvents = events.filter(e => {
        const eventDate = new Date(e.event_date);
        eventDate.setHours(0, 0, 0, 0);
        return eventDate >= today;
      });

      // Filter bookings - exclude declined/cancelled and completed private tours/taster days with past dates
      const activeBookings = bookings.filter(b => {
        // Exclude declined and cancelled
        if (b.status === 'declined' || b.status === 'cancelled') return false;

        // For private tours and taster days, check if scheduled date has passed
        if ((b.booking_type === 'private_tour' || b.booking_type === 'taster_day') && b.scheduled_date) {
          const scheduledDate = new Date(b.scheduled_date);
          scheduledDate.setHours(0, 0, 0, 0);
          // Keep if future or no-show (even if past)
          return scheduledDate >= today || b.no_show_at;
        }

        return true;
      });

      console.log('[DASHBOARD] Filtered to', activeEvents.length, 'active events and', activeBookings.length, 'active bookings');

      // Save the state of currently open sections and expanded booking details before re-rendering
      const openSections = new Set();
      const openBookingDetails = new Set();

      // Save open dashboard sections (events, private tour, and taster day categories)
      document.querySelectorAll('[id^="dashboard-"]').forEach(el => {
        if (el.style.display === 'block' && (el.id.includes('event-') || el.id.includes('private-') || el.id.includes('taster-'))) {
          openSections.add(el.id);
        }
      });

      // Save expanded booking details
      document.querySelectorAll('[id^="booking-"][id$="-details"]').forEach(el => {
        if (el.style.display === 'block') {
          openBookingDetails.add(el.id);
        }
      });

      if (bookings.length === 0) {
        // Show summary with zero stats
        document.getElementById('dashboard-summary').innerHTML = `
          <div class="card" style="padding: 1rem; text-align: center;">
            <h3 style="margin: 0 0 0.5rem 0; font-size: 1.25rem; color: var(--primary-color);">0</h3>
            <p style="margin: 0; color: #666;">Total Bookings</p>
          </div>
          <div class="card" style="padding: 1rem; text-align: center;">
            <h3 style="margin: 0 0 0.5rem 0; font-size: 1.25rem; color: #f39c12;">0</h3>
            <p style="margin: 0; color: #666;">Pending</p>
          </div>
          <div class="card" style="padding: 1rem; text-align: center;">
            <h3 style="margin: 0 0 0.5rem 0; font-size: 1.25rem; color: #27ae60;">0</h3>
            <p style="margin: 0; color: #666;">Confirmed</p>
          </div>
          <div class="card" style="padding: 1rem; text-align: center;">
            <h3 style="margin: 0 0 0.5rem 0; font-size: 1.25rem; color: #3498db;">0</h3>
            <p style="margin: 0; color: #666;">Checked In</p>
          </div>
        `;

        // Still show upcoming events even with no bookings
        renderDashboardOpenDayBookings([], events);
        document.getElementById('dashboard-private-tours-list').innerHTML = '<div class="empty-state"><p>No private tour bookings yet</p></div>';
        return;
      }

      // Separate bookings by type (using filtered activeBookings)
      const openDayBookings = activeBookings.filter(b => b.booking_type === 'open_day');
      const tasterDayBookings = activeBookings.filter(b => b.booking_type === 'taster_day');
      const privateTourBookings = activeBookings.filter(b => b.booking_type === 'private_tour');

      // Calculate summary stats (using activeBookings only)
      const totalBookings = activeBookings.length;
      const pendingCount = activeBookings.filter(b => b.status === 'pending').length;
      const confirmedCount = activeBookings.filter(b => b.status === 'confirmed').length;
      const checkedInCount = activeBookings.filter(b => b.checked_in_at).length;

      // Render summary stats
      document.getElementById('dashboard-summary').innerHTML = `
        <div class="card" style="padding: 1rem; text-align: center;">
          <h3 style="margin: 0 0 0.5rem 0; font-size: 1.25rem; color: var(--primary-color);">${totalBookings}</h3>
          <p style="margin: 0; color: #666;">Total Bookings</p>
        </div>
        <div class="card" style="padding: 1rem; text-align: center;">
          <h3 style="margin: 0 0 0.5rem 0; font-size: 1.25rem; color: #f39c12;">${pendingCount}</h3>
          <p style="margin: 0; color: #666;">Pending</p>
        </div>
        <div class="card" style="padding: 1rem; text-align: center;">
          <h3 style="margin: 0 0 0.5rem 0; font-size: 1.25rem; color: #27ae60;">${confirmedCount}</h3>
          <p style="margin: 0; color: #666;">Confirmed</p>
        </div>
        <div class="card" style="padding: 1rem; text-align: center;">
          <h3 style="margin: 0 0 0.5rem 0; font-size: 1.25rem; color: #3498db;">${checkedInCount}</h3>
          <p style="margin: 0; color: #666;">Checked In</p>
        </div>
      `;

      // Render unified bookings list with drag-and-drop (using filtered activeEvents)
      renderUnifiedDashboardBookings(openDayBookings, tasterDayBookings, privateTourBookings, activeEvents);

      // Restore the state of previously open sections
      openSections.forEach(sectionId => {
        const element = document.getElementById(sectionId);
        const toggle = document.getElementById(sectionId + '-toggle');
        if (element) {
          element.style.display = 'block';
          if (toggle) toggle.textContent = 'â–²';
        }
      });

      // Restore the state of previously expanded booking details
      openBookingDetails.forEach(detailsId => {
        const element = document.getElementById(detailsId);
        const toggle = document.getElementById(detailsId.replace('-details', '-toggle'));
        if (element) {
          element.style.display = 'block';
          if (toggle) toggle.textContent = 'â–²';
        }
      });
    }

    // Unified drag-and-drop bookings renderer
    function renderUnifiedDashboardBookings(openDayBookings, tasterDayBookings, privateTourBookings, events) {
      const container = document.getElementById('dashboard-unified-list');

      // Create events map
      const eventsMap = {};
      (events || []).forEach(e => {
        eventsMap[e.id] = e;
      });

      // Create unified booking items array with metadata
      const unifiedItems = [];

      // Add Open Day events as groups
      const openDayEvents = Object.values(eventsMap).filter(e => e.event_type === 'open_day');
      openDayEvents.forEach(event => {
        const eventBookings = openDayBookings.filter(b => b.event_id === event.id);

        unifiedItems.push({
          type: 'open_day',
          id: `event-${event.id}`,
          event: event,
          bookings: eventBookings,
          sortKey: event.event_date || '9999-12-31'
        });
      });

      // Add Taster Day events as groups
      const tasterDayEvents = Object.values(eventsMap).filter(e => e.event_type === 'taster_day');
      tasterDayEvents.forEach(event => {
        const eventBookings = tasterDayBookings.filter(b => b.event_id === event.id);

        unifiedItems.push({
          type: 'taster_day',
          id: `event-${event.id}`,
          event: event,
          bookings: eventBookings,
          sortKey: event.event_date || '9999-12-31'
        });
      });

      // Add standalone Taster Day bookings (those without event_id) grouped by status
      const standaloneTasterDays = tasterDayBookings.filter(b => !b.event_id);
      const tasterPending = standaloneTasterDays.filter(b => b.status === 'pending');
      const tasterScheduled = standaloneTasterDays.filter(b => b.status === 'confirmed' && b.scheduled_date && !b.checked_in_at);
      const tasterCompleted = standaloneTasterDays.filter(b => b.checked_in_at);
      const tasterOther = standaloneTasterDays.filter(b => !b.checked_in_at && b.status !== 'pending' && !(b.status === 'confirmed' && b.scheduled_date));

      unifiedItems.push({
        type: 'taster_day_pending',
        id: 'taster-pending',
        bookings: tasterPending,
        sortKey: '0000-00-01' // Sort to top, just after private tour pending
      });

      unifiedItems.push({
        type: 'taster_day_scheduled',
        id: 'taster-scheduled',
        bookings: tasterScheduled,
        sortKey: tasterScheduled.length > 0 ? (tasterScheduled[0].scheduled_date || '5000-00-01') : '5000-00-01'
      });

      unifiedItems.push({
        type: 'taster_day_completed',
        id: 'taster-completed',
        bookings: tasterCompleted,
        sortKey: '9999-00-01'
      });

      unifiedItems.push({
        type: 'taster_day_other',
        id: 'taster-other',
        bookings: tasterOther,
        sortKey: '9999-99-98'
      });

      // Add Private Tour groups (always show even if empty)
      const pending = privateTourBookings.filter(b => b.status === 'pending');
      const scheduled = privateTourBookings.filter(b => b.status === 'confirmed' && b.scheduled_date && !b.checked_in_at);
      const completed = privateTourBookings.filter(b => b.checked_in_at);
      const other = privateTourBookings.filter(b => !b.checked_in_at && b.status !== 'pending' && !(b.status === 'confirmed' && b.scheduled_date));

      unifiedItems.push({
        type: 'private_tour_pending',
        id: 'private-pending',
        bookings: pending,
        sortKey: '0000-00-00' // Sort to top by default
      });

      unifiedItems.push({
        type: 'private_tour_scheduled',
        id: 'private-scheduled',
        bookings: scheduled,
        sortKey: scheduled.length > 0 ? (scheduled[0].scheduled_date || '5000-00-00') : '5000-00-00'
      });

      unifiedItems.push({
        type: 'private_tour_completed',
        id: 'private-completed',
        bookings: completed,
        sortKey: '9999-00-00'
      });

      unifiedItems.push({
        type: 'private_tour_other',
        id: 'private-other',
        bookings: other,
        sortKey: '9999-99-99'
      });

      // Load custom sort order from localStorage
      const savedOrder = localStorage.getItem('dashboard_booking_order');
      if (savedOrder) {
        try {
          const orderArray = JSON.parse(savedOrder);
          unifiedItems.sort((a, b) => {
            const aIndex = orderArray.indexOf(a.id);
            const bIndex = orderArray.indexOf(b.id);
            if (aIndex === -1 && bIndex === -1) return a.sortKey.localeCompare(b.sortKey);
            if (aIndex === -1) return 1;
            if (bIndex === -1) return -1;
            return aIndex - bIndex;
          });
        } catch (e) {
          // If parsing fails, use default sort
          unifiedItems.sort((a, b) => a.sortKey.localeCompare(b.sortKey));
        }
      } else {
        // Default sort by sortKey
        unifiedItems.sort((a, b) => a.sortKey.localeCompare(b.sortKey));
      }

      // Render unified list
      container.innerHTML = unifiedItems.map(item => {
        return renderUnifiedBookingItem(item);
      }).join('');

      // Add drag-and-drop event listeners
      addDragAndDropListeners();

      // Check for booking URL parameter and auto-expand/scroll to that booking
      handleBookingURLParameter();
    }

    function renderUnifiedBookingItem(item) {
      if (item.type === 'open_day') {
        const event = item.event;
        const eventBookings = item.bookings;
        const pendingCount = eventBookings.filter(b => b.status === 'pending').length;
        const confirmedCount = eventBookings.filter(b => b.status === 'confirmed').length;
        const checkedInCount = eventBookings.filter(b => b.checked_in_at).length;
        const totalCount = eventBookings.length;

        const maxCapacity = event.max_capacity || null;
        const totalConfirmed = confirmedCount + checkedInCount;
        const availableSpaces = maxCapacity ? maxCapacity - totalConfirmed : null;

        let spacesColor = '#27ae60';
        if (availableSpaces !== null && maxCapacity) {
          const percentFull = (totalConfirmed / maxCapacity) * 100;
          if (percentFull >= 90) {
            spacesColor = '#e74c3c';
          } else if (percentFull >= 70) {
            spacesColor = '#f39c12';
          }
        }

        return `
          <div class="draggable-booking-group" draggable="true" data-item-id="${item.id}" style="border-bottom: 1px solid #e0e0e0; padding: 1rem; cursor: move; background: white;">
            <div style="display: flex; justify-content: space-between; align-items: center; ${eventBookings.length > 0 ? 'cursor: pointer;' : ''}" ${eventBookings.length > 0 ? `onclick="toggleEventBookings('dashboard-${item.id}')"` : ''}>
              <div style="display: flex; align-items: center; gap: 0.75rem;">
                <span style="font-size: 1.25rem;">â‹®â‹®</span>
                <div>
                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span style="background: var(--award-gold); color: white; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.75rem; font-weight: 600;">OPEN DAY</span>
                    <h3 style="margin: 0; font-size: 1.05rem;">${event.title}</h3>
                  </div>
                  <p style="margin: 0.25rem 0 0 0; color: #666; font-size: 0.875rem;">
                    ${event.event_date ? new Date(event.event_date).toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) : 'Date not set'}
                  </p>
                </div>
              </div>
              <div style="display: flex; gap: 0.75rem; align-items: center;">
                <span style="background: #e0e0e0; color: #333; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.875rem; font-weight: 600;">${pendingCount} pending</span>
                <span style="background: #e0e0e0; color: #333; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.875rem; font-weight: 600;">${confirmedCount} confirmed</span>
                <span style="background: #e0e0e0; color: #333; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.875rem; font-weight: 600;">${checkedInCount} checked in</span>
                ${availableSpaces !== null ? `
                  <span style="background: ${spacesColor}; color: white; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.875rem; font-weight: 600;">
                    ${availableSpaces} / ${maxCapacity} spaces
                  </span>
                ` : ''}
                <span style="background: #e0e0e0; color: #333; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.875rem; font-weight: 600;">${totalCount} total</span>
                ${eventBookings.length > 0 ? `<span id="dashboard-${item.id}-toggle" style="font-size: 1.05rem;">â–¼</span>` : ''}
              </div>
            </div>
            ${eventBookings.length > 0 ? `
              <div id="dashboard-${item.id}" style="display: none; margin-top: 1rem;">
                ${eventBookings.map((b, idx) => renderBookingRow(b, idx)).join('')}
              </div>
            ` : ''}
          </div>
        `;
      } else if (item.type === 'taster_day') {
        const event = item.event;
        const eventBookings = item.bookings;
        const pendingCount = eventBookings.filter(b => b.status === 'pending').length;
        const confirmedCount = eventBookings.filter(b => b.status === 'confirmed').length;
        const checkedInCount = eventBookings.filter(b => b.checked_in_at).length;
        const totalCount = eventBookings.length;

        const maxCapacity = event.max_capacity || null;
        const totalConfirmed = confirmedCount + checkedInCount;
        const availableSpaces = maxCapacity ? maxCapacity - totalConfirmed : null;

        let spacesColor = '#27ae60';
        if (availableSpaces !== null && maxCapacity) {
          const percentFull = (totalConfirmed / maxCapacity) * 100;
          if (percentFull >= 90) {
            spacesColor = '#e74c3c';
          } else if (percentFull >= 70) {
            spacesColor = '#f39c12';
          }
        }

        return `
          <div class="draggable-booking-group" draggable="true" data-item-id="${item.id}" style="border-bottom: 1px solid #e0e0e0; padding: 1rem; cursor: move; background: white;">
            <div style="display: flex; justify-content: space-between; align-items: center; ${eventBookings.length > 0 ? 'cursor: pointer;' : ''}" ${eventBookings.length > 0 ? `onclick="toggleEventBookings('dashboard-${item.id}')"` : ''}>
              <div style="display: flex; align-items: center; gap: 0.75rem;">
                <span style="font-size: 1.25rem;">â‹®â‹®</span>
                <div>
                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span style="background: #9b59b6; color: white; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.75rem; font-weight: 600;">TASTER DAY</span>
                    <h3 style="margin: 0; font-size: 1.05rem;">${event.title}</h3>
                  </div>
                  <p style="margin: 0.25rem 0 0 0; color: #666; font-size: 0.875rem;">
                    ${event.event_date ? new Date(event.event_date).toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) : 'Date not set'}
                  </p>
                </div>
              </div>
              <div style="display: flex; gap: 0.75rem; align-items: center;">
                <span style="background: #e0e0e0; color: #333; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.875rem; font-weight: 600;">${pendingCount} pending</span>
                <span style="background: #e0e0e0; color: #333; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.875rem; font-weight: 600;">${confirmedCount} confirmed</span>
                <span style="background: #e0e0e0; color: #333; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.875rem; font-weight: 600;">${checkedInCount} checked in</span>
                ${availableSpaces !== null ? `
                  <span style="background: ${spacesColor}; color: white; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.875rem; font-weight: 600;">
                    ${availableSpaces} / ${maxCapacity} spaces
                  </span>
                ` : ''}
                <span style="background: #e0e0e0; color: #333; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.875rem; font-weight: 600;">${totalCount} total</span>
                ${eventBookings.length > 0 ? `<span id="dashboard-${item.id}-toggle" style="font-size: 1.05rem;">â–¼</span>` : ''}
              </div>
            </div>
            ${eventBookings.length > 0 ? `
              <div id="dashboard-${item.id}" style="display: none; margin-top: 1rem;">
                ${eventBookings.map((b, idx) => renderBookingRow(b, idx)).join('')}
              </div>
            ` : ''}
          </div>
        `;
      } else if (item.type === 'private_tour_pending') {
        return `
          <div class="draggable-booking-group" draggable="true" data-item-id="${item.id}" style="border-bottom: 1px solid #e0e0e0; padding: 1rem; cursor: move; background: white;">
            <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleEventBookings('dashboard-${item.id}')">
              <div style="display: flex; align-items: center; gap: 0.75rem;">
                <span style="font-size: 1.25rem;">â‹®â‹®</span>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <span style="background: #3498db; color: white; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.75rem; font-weight: 600;">PRIVATE TOUR</span>
                  <h3 style="margin: 0;">Pending Tour Requests</h3>
                  <span style="background: #e0e0e0; color: #333; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.875rem; font-weight: 600;">${item.bookings.length}</span>
                </div>
              </div>
              <span id="dashboard-${item.id}-toggle" style="font-size: 0.95rem;">â–¼</span>
            </div>
            <div id="dashboard-${item.id}" style="display: none; margin-top: 1rem;">
              ${item.bookings.map((b, idx) => renderBookingRow(b, idx)).join('')}
            </div>
          </div>
        `;
      } else if (item.type === 'private_tour_scheduled') {
        return `
          <div class="draggable-booking-group" draggable="true" data-item-id="${item.id}" style="border-bottom: 1px solid #e0e0e0; padding: 1rem; cursor: move; background: white;">
            <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleEventBookings('dashboard-${item.id}')">
              <div style="display: flex; align-items: center; gap: 0.75rem;">
                <span style="font-size: 1.25rem;">â‹®â‹®</span>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <span style="background: #3498db; color: white; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.75rem; font-weight: 600;">PRIVATE TOUR</span>
                  <h3 style="margin: 0;">Scheduled Tours</h3>
                  <span style="background: #e0e0e0; color: #333; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.875rem; font-weight: 600;">${item.bookings.length}</span>
                </div>
              </div>
              <span id="dashboard-${item.id}-toggle" style="font-size: 0.95rem;">â–¼</span>
            </div>
            <div id="dashboard-${item.id}" style="display: none; margin-top: 1rem;">
              ${item.bookings.map((b, idx) => renderBookingRow(b, idx)).join('')}
            </div>
          </div>
        `;
      } else if (item.type === 'private_tour_completed') {
        return `
          <div class="draggable-booking-group" draggable="true" data-item-id="${item.id}" style="border-bottom: 1px solid #e0e0e0; padding: 1rem; cursor: move; background: white;">
            <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleEventBookings('dashboard-${item.id}')">
              <div style="display: flex; align-items: center; gap: 0.75rem;">
                <span style="font-size: 1.25rem;">â‹®â‹®</span>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <span style="background: #3498db; color: white; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.75rem; font-weight: 600;">PRIVATE TOUR</span>
                  <h3 style="margin: 0;">Completed Tours</h3>
                  <span style="background: #e0e0e0; color: #333; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.875rem; font-weight: 600;">${item.bookings.length}</span>
                </div>
              </div>
              <span id="dashboard-${item.id}-toggle" style="font-size: 0.95rem;">â–¼</span>
            </div>
            <div id="dashboard-${item.id}" style="display: none; margin-top: 1rem;">
              ${item.bookings.map((b, idx) => renderBookingRow(b, idx)).join('')}
            </div>
          </div>
        `;
      } else if (item.type === 'private_tour_other') {
        return `
          <div class="draggable-booking-group" draggable="true" data-item-id="${item.id}" style="border-bottom: 1px solid #e0e0e0; padding: 1rem; cursor: move; background: white;">
            <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleEventBookings('dashboard-${item.id}')">
              <div style="display: flex; align-items: center; gap: 0.75rem;">
                <span style="font-size: 1.25rem;">â‹®â‹®</span>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <span style="background: #3498db; color: white; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.75rem; font-weight: 600;">PRIVATE TOUR</span>
                  <h3 style="margin: 0;">Declined/Cancelled</h3>
                  <span style="background: #e0e0e0; color: #333; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.875rem; font-weight: 600;">${item.bookings.length}</span>
                </div>
              </div>
              <span id="dashboard-${item.id}-toggle" style="font-size: 0.95rem;">â–¼</span>
            </div>
            <div id="dashboard-${item.id}" style="display: none; margin-top: 1rem;">
              ${item.bookings.map((b, idx) => renderBookingRow(b, idx)).join('')}
            </div>
          </div>
        `;
      } else if (item.type === 'taster_day_pending') {
        return `
          <div class="draggable-booking-group" draggable="true" data-item-id="${item.id}" style="border-bottom: 1px solid #e0e0e0; padding: 1rem; cursor: move; background: white;">
            <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleEventBookings('dashboard-${item.id}')">
              <div style="display: flex; align-items: center; gap: 0.75rem;">
                <span style="font-size: 1.25rem;">â‹®â‹®</span>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <span style="background: #9b59b6; color: white; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.75rem; font-weight: 600;">TASTER DAY</span>
                  <h3 style="margin: 0;">Pending Taster Days</h3>
                  <span style="background: #e0e0e0; color: #333; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.875rem; font-weight: 600;">${item.bookings.length}</span>
                </div>
              </div>
              <span id="dashboard-${item.id}-toggle" style="font-size: 0.95rem;">â–¼</span>
            </div>
            <div id="dashboard-${item.id}" style="display: none; margin-top: 1rem;">
              ${item.bookings.map((b, idx) => renderBookingRow(b, idx)).join('')}
            </div>
          </div>
        `;
      } else if (item.type === 'taster_day_scheduled') {
        return `
          <div class="draggable-booking-group" draggable="true" data-item-id="${item.id}" style="border-bottom: 1px solid #e0e0e0; padding: 1rem; cursor: move; background: white;">
            <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleEventBookings('dashboard-${item.id}')">
              <div style="display: flex; align-items: center; gap: 0.75rem;">
                <span style="font-size: 1.25rem;">â‹®â‹®</span>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <span style="background: #9b59b6; color: white; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.75rem; font-weight: 600;">TASTER DAY</span>
                  <h3 style="margin: 0;">Scheduled Taster Days</h3>
                  <span style="background: #e0e0e0; color: #333; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.875rem; font-weight: 600;">${item.bookings.length}</span>
                </div>
              </div>
              <span id="dashboard-${item.id}-toggle" style="font-size: 0.95rem;">â–¼</span>
            </div>
            <div id="dashboard-${item.id}" style="display: none; margin-top: 1rem;">
              ${item.bookings.map((b, idx) => renderBookingRow(b, idx)).join('')}
            </div>
          </div>
        `;
      } else if (item.type === 'taster_day_completed') {
        return `
          <div class="draggable-booking-group" draggable="true" data-item-id="${item.id}" style="border-bottom: 1px solid #e0e0e0; padding: 1rem; cursor: move; background: white;">
            <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleEventBookings('dashboard-${item.id}')">
              <div style="display: flex; align-items: center; gap: 0.75rem;">
                <span style="font-size: 1.25rem;">â‹®â‹®</span>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <span style="background: #9b59b6; color: white; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.75rem; font-weight: 600;">TASTER DAY</span>
                  <h3 style="margin: 0;">Completed Taster Days</h3>
                  <span style="background: #e0e0e0; color: #333; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.875rem; font-weight: 600;">${item.bookings.length}</span>
                </div>
              </div>
              <span id="dashboard-${item.id}-toggle" style="font-size: 0.95rem;">â–¼</span>
            </div>
            <div id="dashboard-${item.id}" style="display: none; margin-top: 1rem;">
              ${item.bookings.map((b, idx) => renderBookingRow(b, idx)).join('')}
            </div>
          </div>
        `;
      } else if (item.type === 'taster_day_other') {
        return `
          <div class="draggable-booking-group" draggable="true" data-item-id="${item.id}" style="border-bottom: 1px solid #e0e0e0; padding: 1rem; cursor: move; background: white;">
            <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleEventBookings('dashboard-${item.id}')">
              <div style="display: flex; align-items: center; gap: 0.75rem;">
                <span style="font-size: 1.25rem;">â‹®â‹®</span>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <span style="background: #9b59b6; color: white; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.75rem; font-weight: 600;">TASTER DAY</span>
                  <h3 style="margin: 0;">Declined/Cancelled</h3>
                  <span style="background: #e0e0e0; color: #333; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.875rem; font-weight: 600;">${item.bookings.length}</span>
                </div>
              </div>
              <span id="dashboard-${item.id}-toggle" style="font-size: 0.95rem;">â–¼</span>
            </div>
            <div id="dashboard-${item.id}" style="display: none; margin-top: 1rem;">
              ${item.bookings.map((b, idx) => renderBookingRow(b, idx)).join('')}
            </div>
          </div>
        `;
      }
    }

    // Drag and drop functionality for bookings
    let draggedBookingGroup = null;

    function addDragAndDropListeners() {
      const draggables = document.querySelectorAll('.draggable-booking-group');

      draggables.forEach(draggable => {
        draggable.addEventListener('dragstart', (e) => {
          draggedBookingGroup = draggable;
          draggable.style.opacity = '0.5';
          e.dataTransfer.effectAllowed = 'move';
        });

        draggable.addEventListener('dragend', (e) => {
          draggable.style.opacity = '1';
          draggedBookingGroup = null;
        });

        draggable.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';

          if (draggedBookingGroup && draggedBookingGroup !== draggable) {
            const container = draggable.parentNode;
            const afterElement = getDragAfterElement(container, e.clientY);

            if (afterElement == null) {
              container.appendChild(draggedBookingGroup);
            } else {
              container.insertBefore(draggedBookingGroup, afterElement);
            }
          }
        });

        draggable.addEventListener('drop', (e) => {
          e.preventDefault();
          saveDragOrder();
        });
      });
    }

    function getDragAfterElement(container, y) {
      const draggableElements = [...container.querySelectorAll('.draggable-booking-group:not(.dragging)')];

      return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;

        if (offset < 0 && offset > closest.offset) {
          return { offset: offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    function saveDragOrder() {
      const container = document.getElementById('dashboard-unified-list');
      const items = container.querySelectorAll('.draggable-booking-group');
      const order = Array.from(items).map(item => item.getAttribute('data-item-id'));
      localStorage.setItem('dashboard_booking_order', JSON.stringify(order));
    }

    // Handle booking URL parameter - auto-expand and scroll to specific booking
    function handleBookingURLParameter() {
      const urlParams = new URLSearchParams(window.location.search);
      const bookingId = urlParams.get('booking');

      if (!bookingId) return;

      console.log('[BOOKING URL] Looking for booking ID:', bookingId);

      // Use setTimeout to ensure DOM is fully rendered
      setTimeout(() => {
        const bookingDetailsElement = document.getElementById(`booking-${bookingId}-details`);

        if (!bookingDetailsElement) {
          console.log('[BOOKING URL] Booking details element not found:', bookingId);
          return;
        }

        console.log('[BOOKING URL] Found booking details, expanding and scrolling to:', bookingId);

        // Find the parent section that contains this booking (the collapsible event/tour group)
        // Look for parent divs with IDs like "dashboard-event-123" or "dashboard-private-pending"
        let parentSection = bookingDetailsElement.parentElement;
        while (parentSection && parentSection.id !== 'dashboard-unified-list') {
          if (parentSection.id && parentSection.id.startsWith('dashboard-') && !parentSection.id.includes('booking-')) {
            // Found a parent section (event or private tour group)
            console.log('[BOOKING URL] Expanding parent section:', parentSection.id);

            // Expand the parent section first
            parentSection.style.display = 'block';
            const toggleIcon = document.getElementById(`${parentSection.id}-toggle`);
            if (toggleIcon) toggleIcon.textContent = 'â–²';

            break;
          }
          parentSection = parentSection.parentElement;
        }

        // Wait a bit for the section to expand before expanding the booking
        setTimeout(() => {
          expandAndScrollToBooking(bookingId);
        }, 150);
      }, 500);
    }

    // Helper function to expand a specific booking and scroll to it with highlighting
    function expandAndScrollToBooking(bookingId) {
      const bookingElement = document.getElementById(`booking-${bookingId}-details`);
      const bookingHeader = bookingElement?.previousElementSibling;

      if (!bookingElement || !bookingHeader) {
        console.log('[BOOKING URL] Could not find booking elements');
        return;
      }

      // Expand the booking details using the existing toggle function
      if (window.toggleBookingDetails) {
        window.toggleBookingDetails(bookingId);
      } else {
        // Fallback: manually expand
        bookingElement.style.display = 'block';
        const toggle = document.getElementById(`booking-${bookingId}-toggle`);
        if (toggle) toggle.textContent = 'â–²';
      }

      // Scroll to the booking with smooth animation
      setTimeout(() => {
        bookingHeader.scrollIntoView({
          behavior: 'smooth',
          block: 'center'
        });

        // Highlight the booking temporarily
        const bookingCard = bookingHeader.parentElement;
        const originalBackground = bookingCard.style.background;

        // Apply highlight effect
        bookingCard.style.transition = 'background 0.3s ease';
        bookingCard.style.background = '#FFF9E6';
        bookingCard.style.boxShadow = '0 0 0 3px #FF9F1C';

        // Remove highlight after 3 seconds
        setTimeout(() => {
          bookingCard.style.background = originalBackground || 'white';
          bookingCard.style.boxShadow = '';
        }, 3000);

        console.log('[BOOKING URL] Successfully scrolled to and highlighted booking:', bookingId);
      }, 200);
    }

    // Archive
    async function loadArchive() {
      try {
        // Fetch both bookings and events in parallel
        // Include soft-deleted events in archive
        const [bookingsRes, eventsRes] = await Promise.all([
          fetch(`${API_URL}/api/bookings?schoolId=${SCHOOL_ID}`),
          fetch(`${API_URL}/api/events?schoolId=${SCHOOL_ID}&includeDeleted=true`)
        ]);

        const bookingsData = await bookingsRes.json();
        const eventsData = await eventsRes.json();

        renderArchiveBookings(bookingsData.bookings || [], eventsData.events || []);
      } catch (error) {
        console.error('Archive load error:', error);
      }
    }

    function renderArchiveBookings(bookings, events) {
      console.log('[ARCHIVE] renderArchiveBookings called with', bookings.length, 'bookings and', events.length, 'events');

      // Filter for archived items
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      // Filter events - only show past events
      const archivedEvents = events.filter(e => {
        const eventDate = new Date(e.event_date);
        eventDate.setHours(0, 0, 0, 0);
        return eventDate < today;
      });

      // Filter bookings - include declined/cancelled and completed past private tours/taster days
      const archivedBookings = bookings.filter(b => {
        // Include declined and cancelled
        if (b.status === 'declined' || b.status === 'cancelled') return true;

        // For private tours and taster days, check if completed and past
        if ((b.booking_type === 'private_tour' || b.booking_type === 'taster_day') && b.scheduled_date && b.checked_in_at) {
          const scheduledDate = new Date(b.scheduled_date);
          scheduledDate.setHours(0, 0, 0, 0);
          return scheduledDate < today;
        }

        return false;
      });

      console.log('[ARCHIVE] Filtered to', archivedEvents.length, 'archived events and', archivedBookings.length, 'archived bookings');

      // Separate bookings by type
      const openDayBookings = archivedBookings.filter(b => b.booking_type === 'open_day');
      const tasterDayBookings = archivedBookings.filter(b => b.booking_type === 'taster_day');
      const privateTourBookings = archivedBookings.filter(b => b.booking_type === 'private_tour');

      // Calculate summary stats
      const totalArchived = archivedBookings.length;
      const completedCount = archivedBookings.filter(b => b.checked_in_at).length;
      const declinedCount = archivedBookings.filter(b => b.status === 'declined').length;
      const cancelledCount = archivedBookings.filter(b => b.status === 'cancelled').length;

      // Render summary stats
      document.getElementById('archive-summary').innerHTML = `
        <div class="card" style="padding: 1rem; text-align: center;">
          <h3 style="margin: 0; font-size: 2rem; font-weight: 700; color: var(--blazer-navy);">${totalArchived}</h3>
          <p style="margin: 0; color: #666;">Total Archived</p>
        </div>
        <div class="card" style="padding: 1rem; text-align: center;">
          <h3 style="margin: 0; font-size: 2rem; font-weight: 700; color: #10B981;">${completedCount}</h3>
          <p style="margin: 0; color: #666;">Completed</p>
        </div>
        <div class="card" style="padding: 1rem; text-align: center;">
          <h3 style="margin: 0; font-size: 2rem; font-weight: 700; color: #EF4444;">${declinedCount}</h3>
          <p style="margin: 0; color: #666;">Declined</p>
        </div>
        <div class="card" style="padding: 1rem; text-align: center;">
          <h3 style="margin: 0; font-size: 2rem; font-weight: 700; color: #F59E0B;">${cancelledCount}</h3>
          <p style="margin: 0; color: #666;">Cancelled</p>
        </div>
      `;

      // Render unified archive list (reusing the same render function)
      const container = document.getElementById('archive-unified-list');

      if (totalArchived === 0) {
        container.innerHTML = '<div class="empty-state"><p>No archived bookings yet</p></div>';
        return;
      }

      // Reuse renderUnifiedDashboardBookings but target archive container
      const oldContainer = document.getElementById('dashboard-unified-list');
      const tempContainer = document.getElementById('archive-unified-list');

      // Temporarily swap IDs to reuse the render function
      oldContainer.id = 'temp-dash';
      tempContainer.id = 'dashboard-unified-list';

      renderUnifiedDashboardBookings(openDayBookings, tasterDayBookings, privateTourBookings, archivedEvents);

      // Swap back
      tempContainer.id = 'archive-unified-list';
      oldContainer.id = 'dashboard-unified-list';
    }

    // Archive search filter
    function filterArchive(searchTerm) {
      const term = searchTerm.toLowerCase().trim();
      const allGroups = document.querySelectorAll('#archive-unified-list .draggable-booking-group');

      console.log('[ARCHIVE SEARCH] Search term:', term);
      console.log('[ARCHIVE SEARCH] Found groups:', allGroups.length);

      // Remove any existing "no results" message first
      const existingMessage = document.querySelector('#archive-unified-list #no-search-results');
      if (existingMessage) {
        existingMessage.remove();
      }

      if (!term) {
        // Show all groups and reset highlighting
        allGroups.forEach(group => {
          group.style.display = 'block';
          const allDivs = group.querySelectorAll('div');
          allDivs.forEach(div => {
            if (div.style.border && div.style.border.includes('solid')) {
              div.style.border = '1px solid #e0e0e0';
              div.style.background = '';
              div.style.display = '';
            }
          });
        });
        return;
      }

      let hasMatches = false;

      allGroups.forEach(group => {
        const contentDivs = group.querySelectorAll('[id^="dashboard-"]');
        let groupHasMatch = false;

        contentDivs.forEach(contentDiv => {
          const bookingDivs = contentDiv.querySelectorAll('div[style*="border"][style*="margin-bottom"]');

          if (bookingDivs.length === 0) return;

          bookingDivs.forEach(bookingDiv => {
            const text = bookingDiv.textContent.toLowerCase();
            const matches = text.includes(term);

            if (matches) {
              bookingDiv.style.display = 'block';
              bookingDiv.style.border = '3px solid #6B7280';
              bookingDiv.style.background = '#F3F4F6';
              groupHasMatch = true;
              hasMatches = true;

              // Auto-expand the parent section
              contentDiv.style.display = 'block';
              const toggle = document.getElementById(contentDiv.id + '-toggle');
              if (toggle) {
                toggle.textContent = 'â–²';
              }
            } else {
              bookingDiv.style.display = 'none';
            }
          });
        });

        group.style.display = groupHasMatch ? 'block' : 'none';
      });

      // Show message if no matches found
      if (!hasMatches) {
        const container = document.getElementById('archive-unified-list');
        const messageDiv = document.createElement('div');
        messageDiv.id = 'no-search-results';
        messageDiv.style.cssText = 'padding: 2rem; text-align: center; color: #6B7280; font-size: 0.95rem;';
        messageDiv.innerHTML = `
          <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ”</div>
          <p style="margin: 0; font-weight: 600; font-size: 1.1rem; color: var(--blazer-navy);">No archived bookings found</p>
          <p style="margin: 0.5rem 0 0 0;">Try searching for a different name or email</p>
        `;
        container.insertBefore(messageDiv, container.firstChild);
      }
    }
    // Make globally accessible
    window.filterArchive = filterArchive;

    // Events
    async function loadEvents() {
      console.log('[EVENTS] loadEvents() called');
      try {
        const url = `${API_URL}/api/events?schoolId=${SCHOOL_ID}`;
        console.log('[EVENTS] Fetching from:', url);
        const res = await fetch(url);
        console.log('[EVENTS] Response status:', res.status, res.ok);
        const data = await res.json();
        console.log('[EVENTS] Response data:', data);
        console.log('[EVENTS] Events array:', data.events);
        console.log('[EVENTS] Events count:', (data.events || []).length);
        renderEvents(data.events || []);
      } catch (error) {
        console.error('Load events error:', error);
      }
    }

    function renderEvents(events) {
      console.log('[EVENTS] renderEvents() called with', events.length, 'events');
      const container = document.getElementById('events-list');
      console.log('[EVENTS] Container element:', container);

      if (events.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>No events created yet</p></div>';
        return;
      }

      container.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Title</th>
              <th>Type</th>
              <th>Date</th>
              <th>Time</th>
              <th>Bookings</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${events.map(e => `
              <tr>
                <td>${e.title}</td>
                <td>${e.event_type.replace('_', ' ')}</td>
                <td>${new Date(e.event_date).toLocaleDateString()}</td>
                <td>${e.start_time} - ${e.end_time}</td>
                <td>${e.current_bookings} / ${e.max_capacity}</td>
                <td><span class="badge badge-${e.status}">${e.status}</span></td>
                <td>
                  <button class="btn btn-sm" onclick="window.open('/briefing-cards.html?eventId=${e.id}', '_blank')" style="margin-right: 0.5rem; background: #10B981; color: white;" title="Print briefing packs for tour guides">Print Packs</button>
                  <button class="btn btn-sm btn-primary" onclick="showEditEventModal(${e.id})" style="margin-right: 0.5rem;">Edit</button>
                  <button class="btn btn-sm btn-danger" onclick="deleteEvent(${e.id})">Delete</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    // Create event
    document.getElementById('createEventForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(e.target);
      const data = {
        school_id: SCHOOL_ID,
        event_type: formData.get('event_type'),
        title: formData.get('title'),
        description: formData.get('description'),
        event_date: formData.get('event_date'),
        start_time: formData.get('start_time'),
        end_time: formData.get('end_time'),
        location: formData.get('location'),
        max_capacity: parseInt(formData.get('max_capacity'))
      };

      try {
        const res = await fetch(`${API_URL}/api/events`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (res.ok) {
          closeModal('createEventModal');
          e.target.reset();
          loadEvents();
        } else {
          alert('Failed to create event');
        }
      } catch (error) {
        console.error('Create event error:', error);
        alert('Error creating event');
      }
    });

    // Delete event
    async function deleteEvent(id) {
      if (!confirm('Are you sure you want to delete this event?')) return;

      try {
        const res = await fetch(`${API_URL}/api/events/${id}`, {
          method: 'DELETE'
        });

        if (res.ok) {
          loadEvents();
        } else {
          alert('Failed to delete event');
        }
      } catch (error) {
        console.error('Delete event error:', error);
      }
    }

    // Edit event functions
    async function showEditEventModal(eventId) {
      try {
        // Fetch the event data
        const res = await fetch(`${API_URL}/api/events/${eventId}`);
        const data = await res.json();

        if (!data.success || !data.event) {
          alert('Failed to load event data');
          return;
        }

        const event = data.event;

        // Populate the form fields
        document.getElementById('edit-event-id').value = event.id;
        document.getElementById('edit-event-type').value = event.event_type;
        document.getElementById('edit-event-title').value = event.title;
        document.getElementById('edit-event-description').value = event.description || '';
        document.getElementById('edit-event-date').value = event.event_date;
        document.getElementById('edit-event-start-time').value = event.start_time;
        document.getElementById('edit-event-end-time').value = event.end_time;
        document.getElementById('edit-event-location').value = event.location || '';
        document.getElementById('edit-event-max-capacity').value = event.max_capacity;
        document.getElementById('edit-event-status').value = event.status;

        // Show the modal
        document.getElementById('editEventModal').classList.add('show');
      } catch (error) {
        console.error('Load event error:', error);
        alert('Failed to load event data. Please try again.');
      }
    }

    async function saveEventEdits() {
      try {
        const eventId = document.getElementById('edit-event-id').value;
        const eventData = {
          event_type: document.getElementById('edit-event-type').value,
          title: document.getElementById('edit-event-title').value,
          description: document.getElementById('edit-event-description').value,
          event_date: document.getElementById('edit-event-date').value,
          start_time: document.getElementById('edit-event-start-time').value,
          end_time: document.getElementById('edit-event-end-time').value,
          location: document.getElementById('edit-event-location').value,
          max_capacity: parseInt(document.getElementById('edit-event-max-capacity').value),
          status: document.getElementById('edit-event-status').value
        };

        const res = await fetch(`${API_URL}/api/events/${eventId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(eventData)
        });

        const data = await res.json();

        if (data.success) {
          closeModal('editEventModal');
          await loadEvents();
          alert('Event updated successfully!');
        } else {
          console.error('Update failed with data:', data);
          alert('Failed to update event: ' + (data.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Update event error:', error);
        console.error('Error details:', error.message, error.stack);
        alert('Failed to update event. Please try again.');
      }
    }

    // Edit Event Form Submit
    document.getElementById('editEventForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      await saveEventEdits();
    });

    // Bookings
    function renderBookingRow(b, index) {
      const bookingNumber = index !== undefined ? index + 1 : '';
      return `
        <div style="border: 1px solid #e0e0e0; border-radius: 4px; margin-bottom: 0.5rem; overflow: hidden;">
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f8f9fa; cursor: pointer;" onclick="toggleBookingDetails(${b.id})">
            <div style="display: grid; grid-template-columns: auto 1fr auto; gap: 1.5rem; align-items: center; flex: 1;">
              ${bookingNumber ? `<span style="font-weight: 700; color: #333; font-size: 1.05rem;">${bookingNumber}</span>` : ''}

              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                <div>
                  <div style="font-weight: 600; font-size: 0.95rem; margin-bottom: 0.25rem;">Student</div>
                  <div style="color: #333; font-weight: 600; font-size: 0.95rem;">${b.student_first_name || 'N/A'} ${b.student_last_name || ''}</div>
                  <div style="color: #666; font-size: 0.875rem;">${b.age_group || ''}</div>
                </div>

                <div>
                  <div style="font-weight: 600; font-size: 0.95rem; margin-bottom: 0.25rem;">Parent Contact</div>
                  <div style="color: #333; font-size: 0.95rem;">${b.parent_first_name} ${b.parent_last_name}</div>
                  <div style="color: #666; font-size: 0.875rem;">${b.email}</div>
                  ${b.phone ? `<div style="color: #666; font-size: 0.875rem;">${b.phone}</div>` : ''}
                </div>

                <div>
                  <div style="font-weight: 600; font-size: 0.95rem; margin-bottom: 0.25rem;">Details</div>
                  <div style="color: #333; font-size: 0.95rem;">${b.num_attendees} attendee${b.num_attendees !== 1 ? 's' : ''}</div>
                  ${b.preferred_language ? `<div style="color: #666; font-size: 0.875rem;">Language: ${b.preferred_language}</div>` : ''}
                  ${(() => {
                    if (!b.special_requirements || !b.special_requirements.trim()) return '';
                    // Check if it's just the standard private tour request format
                    const lines = b.special_requirements.split('\\n').map(l => l.trim()).filter(l => l);
                    const hasActualRequirements = lines.some(line =>
                      !line.startsWith('PRIVATE TOUR REQUEST') &&
                      !line.startsWith('Preferred Date:') &&
                      !line.startsWith('Preferred Time:') &&
                      line.length > 0
                    );
                    return hasActualRequirements ? '<div style="color: #e67e22; font-size: 0.875rem; font-weight: 600;">âš  Special Requirements</div>' : '';
                  })()}
                </div>
              </div>

              <div style="display: flex; gap: 0.5rem; align-items: center;">
                <span class="badge badge-${b.status}">${b.status}</span>
                ${b.checked_in_at ? '<span class="badge badge-primary">Checked In</span>' : b.no_show_at ? '<span class="badge badge-no-show">No Show</span>' : ''}
              </div>
            </div>

            <div style="display: flex; gap: 0.5rem; align-items: center; margin-left: 1rem;">
              ${getBookingActionButtons(b)}
              <span id="booking-${b.id}-toggle" style="font-size: 0.875rem; color: #666;">â–¼</span>
            </div>
          </div>
          <div id="booking-${b.id}-details" style="display: none; padding: 1rem; background: white; border-top: 1px solid #e0e0e0;">
            ${renderBookingDetails(b)}
          </div>
        </div>
      `;
    }

    function renderBookingDetails(b) {
      // Build interests arrays
      const subjectInterests = [];
      if (b.sciences) subjectInterests.push('Sciences');
      if (b.mathematics) subjectInterests.push('Mathematics');
      if (b.english) subjectInterests.push('English');
      if (b.languages) subjectInterests.push('Languages');
      if (b.humanities) subjectInterests.push('Humanities');
      if (b.business) subjectInterests.push('Business');
      if (b.drama) subjectInterests.push('Drama');
      if (b.music) subjectInterests.push('Music');
      if (b.art) subjectInterests.push('Art');
      if (b.creative_writing) subjectInterests.push('Creative Writing');
      if (b.sport) subjectInterests.push('Sport');

      const priorities = [];
      if (b.leadership) priorities.push('Leadership');
      if (b.community_service) priorities.push('Community Service');
      if (b.outdoor_education) priorities.push('Outdoor Education');
      if (b.academic_excellence) priorities.push('Academic Excellence');
      if (b.pastoral_care) priorities.push('Pastoral Care');
      if (b.university_preparation) priorities.push('University Preparation');
      if (b.personal_development) priorities.push('Personal Development');
      if (b.career_guidance) priorities.push('Career Guidance');
      if (b.extracurricular_opportunities) priorities.push('Extracurricular Opportunities');

      return `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; font-size: 0.875rem;">
          ${b.entry_year || ((b.booking_type === 'private_tour' || b.booking_type === 'taster_day') && b.scheduled_date) || b.guide_name ? `
            <div>
              <h4 style="margin: 0 0 0.75rem 0; color: #555; border-bottom: 2px solid #e0e0e0; padding-bottom: 0.5rem; font-size: 1rem;">Additional Details</h4>
              <div style="display: grid; gap: 0.5rem;">
                ${b.entry_year ? `<div><strong>Entry Year:</strong> ${b.entry_year}</div>` : ''}
                ${(b.booking_type === 'private_tour' || b.booking_type === 'taster_day') && b.scheduled_date ? `
                  <div><strong>Scheduled:</strong> ${new Date(b.scheduled_date).toLocaleDateString('en-GB')} at ${b.scheduled_time}</div>
                ` : ''}
                ${b.guide_name ? `<div><strong>Tour Guide:</strong> ${b.guide_name}</div>` : ''}
              </div>
            </div>
          ` : ''}

          <div>
            <h4 style="margin: 0 0 0.75rem 0; color: #555; border-bottom: 2px solid #e0e0e0; padding-bottom: 0.5rem; font-size: 1rem;">Timeline</h4>
            <div style="display: grid; gap: 0.5rem;">
              <div><strong>Booked:</strong> ${new Date(b.booked_at).toLocaleString('en-GB')}</div>
              ${b.checked_in_at ? `<div><strong>Checked In:</strong> ${new Date(b.checked_in_at).toLocaleString('en-GB')}</div>` : ''}
              ${b.cancelled_at ? `<div><strong>Cancelled:</strong> ${new Date(b.cancelled_at).toLocaleString('en-GB')}</div>` : ''}
              ${b.no_show_at ? `<div><strong>Marked No Show:</strong> ${new Date(b.no_show_at).toLocaleString('en-GB')}</div>` : ''}
            </div>
          </div>
        </div>

        ${subjectInterests.length > 0 ? `
          <div style="margin-top: 1.5rem;">
            <h4 style="margin: 0 0 0.75rem 0; color: #555; border-bottom: 2px solid #e0e0e0; padding-bottom: 0.5rem; font-size: 1rem;">Subject Interests</h4>
            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
              ${subjectInterests.map(interest => `<span style="background: #e3f2fd; color: #1976d2; padding: 0.4rem 0.8rem; border-radius: 20px; font-size: 0.875rem;">${interest}</span>`).join('')}
            </div>
          </div>
        ` : ''}

        ${priorities.length > 0 ? `
          <div style="margin-top: 1.5rem;">
            <h4 style="margin: 0 0 0.75rem 0; color: #555; border-bottom: 2px solid #e0e0e0; padding-bottom: 0.5rem; font-size: 1rem;">Priorities & Values</h4>
            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
              ${priorities.map(priority => `<span style="background: #e3f2fd; color: #034674; padding: 0.4rem 0.8rem; border-radius: 20px; font-size: 0.875rem;">${priority}</span>`).join('')}
            </div>
          </div>
        ` : ''}

        ${b.special_requirements ? `
          <div style="margin-top: 1.5rem;">
            <h4 style="margin: 0 0 0.75rem 0; color: #555; border-bottom: 2px solid #e0e0e0; padding-bottom: 0.5rem; font-size: 1rem;">Special Requirements</h4>
            <p style="margin: 0; padding: 0.75rem; background: #f8f9fa; border-radius: 4px; font-size: 0.875rem;">${b.special_requirements}</p>
          </div>
        ` : ''}

        ${b.decline_reason ? `
          <div style="margin-top: 1.5rem;">
            <h4 style="margin: 0 0 0.75rem 0; color: #555; border-bottom: 2px solid #e0e0e0; padding-bottom: 0.5rem;">Decline Reason</h4>
            <p style="margin: 0; padding: 0.75rem; background: #fff3cd; border-radius: 4px;">${b.decline_reason}</p>
          </div>
        ` : ''}

        ${b.cancellation_reason ? `
          <div style="margin-top: 1.5rem;">
            <h4 style="margin: 0 0 0.75rem 0; color: #555; border-bottom: 2px solid #e0e0e0; padding-bottom: 0.5rem;">Cancellation Reason</h4>
            <p style="margin: 0; padding: 0.75rem; background: #f8d7da; border-radius: 4px;">${b.cancellation_reason}</p>
          </div>
        ` : ''}

        <!-- CRM Data Sections -->
        <div style="margin-top: 1.5rem;">
          <h4 style="margin: 0 0 0.75rem 0; color: #555; border-bottom: 2px solid #e0e0e0; padding-bottom: 0.5rem; font-size: 1rem;">
            Admin Notes
          </h4>
          <div id="booking-${b.id}-notes-container" style="min-height: 50px;">
            <div style="text-align: center; padding: 1rem; color: #999;">Loading notes...</div>
          </div>
          <div style="margin-top: 1rem;">
            <textarea id="booking-${b.id}-new-note" placeholder="Add a new note..." style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; min-height: 60px;"></textarea>
            <button class="btn btn-sm btn-primary" style="margin-top: 0.5rem;" onclick="addBookingNote(${b.id})">Add Note</button>
          </div>
        </div>

        <div style="margin-top: 1.5rem;">
          <h4 style="margin: 0 0 0.75rem 0; color: #555; border-bottom: 2px solid #e0e0e0; padding-bottom: 0.5rem; font-size: 1rem;">
            Email History
          </h4>
          <div id="booking-${b.id}-emails-container" style="min-height: 50px;">
            <div style="text-align: center; padding: 1rem; color: #999;">Loading email history...</div>
          </div>
        </div>

        <div style="margin-top: 1.5rem;">
          <h4 style="margin: 0 0 0.75rem 0; color: #555; border-bottom: 2px solid #e0e0e0; padding-bottom: 0.5rem; font-size: 1rem;">
            Prospectus Viewing History
          </h4>
          <div id="booking-${b.id}-sessions-container" style="min-height: 50px;">
            <div style="text-align: center; padding: 1rem; color: #999;">Loading session history...</div>
          </div>
        </div>

        <div style="margin-top: 1.5rem;">
          <h4 style="margin: 0 0 0.75rem 0; color: #555; border-bottom: 2px solid #FF9F1C; padding-bottom: 0.5rem; font-size: 1rem;">
            ðŸ“ <span style="color: #FF9F1C; font-weight: 600;">SMART</span> Feedback
          </h4>
          <div id="booking-${b.id}-feedback-container" style="min-height: 50px;">
            <div style="text-align: center; padding: 1rem; color: #999;">Loading SMART feedback...</div>
          </div>
        </div>
      `;
    }

    function getBookingActionButtons(b) {
      let buttons = '';

      // Always show Edit button
      buttons += `
        <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); showEditBookingModal(${b.id})">Edit</button>
      `;

      if (b.status === 'pending' && (b.booking_type === 'private_tour' || b.booking_type === 'taster_day')) {
        buttons += `
          <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); showScheduleModal(${b.id}, '${b.parent_first_name} ${b.parent_last_name}')">Schedule</button>
          <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); showDeclineModal(${b.id}, '${b.parent_first_name} ${b.parent_last_name}')">Decline</button>
        `;
      }

      if (b.status === 'pending' && b.booking_type === 'open_day') {
        buttons += `
          <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); updateBookingStatus(${b.id}, 'confirmed')">Approve</button>
          <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); updateBookingStatus(${b.id}, 'cancelled')">Reject</button>
        `;
      }

      if (b.status === 'confirmed' && !b.checked_in_at) {
        buttons += `
          <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); checkInBooking(${b.id})">Check In</button>
        `;
      }

      if (b.status === 'confirmed' && !b.checked_in_at && !b.no_show_at) {
        buttons += `
          <button class="btn btn-sm btn-warning" onclick="event.stopPropagation(); markAsNoShow(${b.id})">No Show</button>
        `;
      }

      if ((b.booking_type === 'open_day' || b.booking_type === 'taster_day') && b.status === 'confirmed' && !b.checked_in_at && !b.assigned_guide_id) {
        const studentName = `${b.student_first_name} ${b.student_last_name}`.replace(/'/g, "\\'");
        buttons += `
          <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); showAssignGuideModal(${b.id}, '${studentName}')" style="background: #034674;">Assign Guide</button>
        `;
      }

      return buttons;
    }

    function toggleEventBookings(eventId) {
      const element = document.getElementById(eventId);
      const toggle = document.getElementById(eventId + '-toggle');

      if (element.style.display === 'none') {
        element.style.display = 'block';
        toggle.textContent = 'â–²';
      } else {
        element.style.display = 'none';
        toggle.textContent = 'â–¼';
      }
    }
    // Make globally accessible for onclick handlers
    window.toggleEventBookings = toggleEventBookings;

    // Search/Filter function for bookings
    function filterBookings(searchTerm) {
      const term = searchTerm.toLowerCase().trim();
      const allGroups = document.querySelectorAll('.draggable-booking-group');

      console.log('[SEARCH] Search term:', term);
      console.log('[SEARCH] Found groups:', allGroups.length);

      // Remove any existing "no results" message first
      const existingMessage = document.getElementById('no-search-results');
      if (existingMessage) {
        existingMessage.remove();
      }

      if (!term) {
        // Show all groups and reset highlighting
        allGroups.forEach(group => {
          group.style.display = 'block';
          // Reset all child divs to original state
          const allDivs = group.querySelectorAll('div');
          allDivs.forEach(div => {
            if (div.style.border && div.style.border.includes('solid')) {
              div.style.border = '1px solid #e0e0e0';
              div.style.background = '';
              div.style.display = '';
            }
          });
        });
        return;
      }

      let hasMatches = false;

      allGroups.forEach(group => {
        // Find the collapsible content div (contains all bookings for this event/group)
        const contentDivs = group.querySelectorAll('[id^="dashboard-"]');
        let groupHasMatch = false;

        contentDivs.forEach(contentDiv => {
          // Find all booking rows within this content div
          // Each booking is wrapped in a div with border styling
          const bookingDivs = contentDiv.querySelectorAll('div[style*="border"][style*="margin-bottom"]');

          console.log('[SEARCH] Group has bookings:', bookingDivs.length);

          if (bookingDivs.length === 0) return;

          bookingDivs.forEach(bookingDiv => {
            const text = bookingDiv.textContent.toLowerCase();
            const matches = text.includes(term);

            if (matches) {
              console.log('[SEARCH] MATCH found in:', text.substring(0, 50));
              bookingDiv.style.display = 'block';
              bookingDiv.style.border = '3px solid var(--award-gold)';
              bookingDiv.style.background = '#FFF9E6';
              groupHasMatch = true;
              hasMatches = true;

              // Auto-expand the parent section
              contentDiv.style.display = 'block';
              const toggle = document.getElementById(contentDiv.id + '-toggle');
              if (toggle) {
                toggle.textContent = 'â–²';
              }
            } else {
              bookingDiv.style.display = 'none';
            }
          });
        });

        // Show/hide the entire group based on matches
        group.style.display = groupHasMatch ? 'block' : 'none';
      });

      console.log('[SEARCH] Total matches:', hasMatches);

      // Show message if no matches found
      if (!hasMatches) {
        const container = document.getElementById('dashboard-unified-list');
        const messageDiv = document.createElement('div');
        messageDiv.id = 'no-search-results';
        messageDiv.style.cssText = 'padding: 2rem; text-align: center; color: #6B7280; font-size: 0.95rem;';
        messageDiv.innerHTML = `
          <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ”</div>
          <p style="margin: 0; font-weight: 600; font-size: 1.1rem; color: var(--blazer-navy);">No bookings found</p>
          <p style="margin: 0.5rem 0 0 0;">Try searching for a different name or email</p>
        `;
        container.insertBefore(messageDiv, container.firstChild);
      }
    }
    // Make globally accessible
    window.filterBookings = filterBookings;

    async function toggleBookingDetails(bookingId) {
      const element = document.getElementById(`booking-${bookingId}-details`);
      const toggle = document.getElementById(`booking-${bookingId}-toggle`);

      if (element.style.display === 'none') {
        element.style.display = 'block';
        toggle.textContent = 'â–²';

        // Load CRM data if not already loaded
        if (!element.dataset.crmLoaded) {
          element.dataset.crmLoaded = 'true';
          await loadBookingCRMData(bookingId);
        }
      } else {
        element.style.display = 'none';
        toggle.textContent = 'â–¼';
      }
    }
    // Make globally accessible for onclick handlers
    window.toggleBookingDetails = toggleBookingDetails;

    async function loadBookingCRMData(bookingId) {
      // Load all CRM data in parallel
      await Promise.all([
        loadBookingNotes(bookingId),
        loadBookingEmails(bookingId),
        loadBookingSessions(bookingId),
        loadBookingTourFeedback(bookingId)
      ]);
    }

    async function loadBookingNotes(bookingId) {
      const container = document.getElementById(`booking-${bookingId}-notes-container`);
      try {
        const res = await fetch(`${API_URL}/api/bookings/${bookingId}/notes`);
        const data = await res.json();

        if (data.success) {
          if (data.notes.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 1rem; color: #999;">No notes yet</div>';
          } else {
            container.innerHTML = data.notes.map(note => `
              <div style="background: #f8f9fa; padding: 0.75rem; border-left: 3px solid #034674; margin-bottom: 0.75rem; border-radius: 4px;">
                <div style="font-size: 0.875rem; color: #333;">${note.content.replace(/\n/g, '<br>')}</div>
                <div style="margin-top: 0.5rem; font-size: 0.75rem; color: #666;">
                  <strong>${note.admin_email || 'Admin'}</strong> â€¢ ${new Date(note.created_at).toLocaleString('en-GB')}
                </div>
              </div>
            `).join('');
          }
        }
      } catch (error) {
        console.error('Load notes error:', error);
        container.innerHTML = '<div style="text-align: center; padding: 1rem; color: #dc3545;">Failed to load notes</div>';
      }
    }

    async function loadBookingEmails(bookingId) {
      const container = document.getElementById(`booking-${bookingId}-emails-container`);
      try {
        const res = await fetch(`${API_URL}/api/bookings/${bookingId}/email-history`);
        const data = await res.json();

        if (data.success) {
          if (data.emails.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 1rem; color: #999;">No email history found</div>';
          } else {
            container.innerHTML = data.emails.map(email => {
              const isAI = email.direction === 'ai-generated';

              if (isAI) {
                // Use same format as smart CRM email history
                const date = new Date(email.sent_at).toLocaleDateString('en-GB', {
                  day: 'numeric',
                  month: 'short',
                  year: 'numeric',
                  hour: '2-digit',
                  minute: '2-digit'
                });

                const sentimentColor = email.sentiment_score >= 7 ? '#10B981' :
                                       email.sentiment_score >= 4 ? '#F59E0B' : '#EF4444';

                return `
                  <div style="background:white;border:1px solid #E5E7EB;border-radius:6px;padding:15px;margin-bottom:10px;">
                    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:10px;">
                      <div>
                        <div style="font-weight:600;color:#1e3a5f;margin-bottom:5px;">From: ${email.from_name || 'Parent'}</div>
                        <div style="font-size:13px;color:#64748b;">${date}</div>
                      </div>
                      ${email.sentiment_score ? `
                        <div style="text-align:right;">
                          <div style="font-size:11px;color:#64748b;text-transform:uppercase;margin-bottom:3px;">Sentiment</div>
                          <div style="display:inline-block;padding:4px 10px;background:${sentimentColor};color:white;border-radius:12px;font-size:13px;font-weight:600;">
                            ${email.sentiment_score}/10 ${email.sentiment_label || ''}
                          </div>
                        </div>
                      ` : ''}
                    </div>

                    <div style="background:#F8FAFC;border-left:3px solid #034674;padding:12px;margin-bottom:10px;border-radius:4px;">
                      <div style="font-size:12px;font-weight:600;color:#64748b;margin-bottom:5px;">PARENT EMAIL:</div>
                      <div style="font-size:14px;line-height:1.6;white-space:pre-wrap;">${email.original_text}</div>
                    </div>

                    <div style="background:#FFFBEB;border-left:3px solid #FF9F1C;padding:12px;border-radius:4px;">
                      <div style="font-size:12px;font-weight:600;color:#64748b;margin-bottom:5px;">OUR RESPONSE:</div>
                      <div style="font-size:14px;line-height:1.6;white-space:pre-wrap;">${email.body_text}</div>
                    </div>

                    ${email.sentiment_reasoning ? `
                      <div style="margin-top:10px;font-size:13px;color:#64748b;font-style:italic;">
                        ${email.sentiment_reasoning}
                      </div>
                    ` : ''}
                  </div>
                `;
              } else {
                // Regular email
                const isIncoming = email.direction === 'received';
                const directionColor = isIncoming ? '#1976d2' : '#2e7d32';
                const directionLabel = isIncoming ? 'FROM PARENT' : 'FROM SCHOOL';
                const timestamp = email.sent_at || email.received_at;

                return `
                  <div style="background: #f8f9fa; padding: 0.75rem; border-left: 3px solid ${directionColor}; margin-bottom: 0.75rem; border-radius: 4px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                      <div>
                        <span style="background: ${directionColor}; color: white; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.75rem; text-transform: uppercase;">${directionLabel}</span>
                        ${email.admin_email ? `<span style="background: #FF9F1C; color: white; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.75rem; margin-left: 0.5rem;">${email.admin_email}</span>` : ''}
                      </div>
                      <span style="font-size: 0.75rem; color: #666;">${new Date(timestamp).toLocaleString('en-GB')}</span>
                    </div>
                    <div style="font-size: 0.875rem; color: #666; margin-bottom: 0.5rem;">
                      <strong>From:</strong> ${email.from_name || email.from_email || 'Unknown'}
                      ${email.to_name ? ` | <strong>To:</strong> ${email.to_name || email.to_email}` : ''}
                    </div>
                    ${email.subject ? `<div style="font-size: 0.875rem; color: #333; margin-bottom: 0.5rem;"><strong>Subject:</strong> ${email.subject}</div>` : ''}
                    <details style="margin-top: 0.5rem;">
                      <summary style="cursor: pointer; font-size: 0.875rem; color: #034674;">View email content</summary>
                      <div style="margin-top: 0.5rem; padding: 0.75rem; background: white; border-radius: 4px; font-size: 0.875rem; max-height: 300px; overflow-y: auto;">
                        ${email.body_text ? email.body_text.replace(/\n/g, '<br>') : 'No content available'}
                      </div>
                    </details>
                  </div>
                `;
              }
            }).join('');
          }
        }
      } catch (error) {
        console.error('Load emails error:', error);
        container.innerHTML = '<div style="text-align: center; padding: 1rem; color: #dc3545;">Failed to load email history</div>';
      }
    }

    // Format section names to human-readable (same as admin app)
    function formatSectionName(section) {
      const SECTION_NAMES = {
        cover_page: 'Welcome Page',
        heads_welcome: "Head's Welcome",
        academic_excellence: 'Academic Excellence',
        about_more_house: 'About More House',
        day_in_the_life: 'A Day at More House',
        creative_arts_hero: 'Creative Arts',
        your_journey: 'Your Journey',
        london_extended_classroom: 'London Extended Classroom',
        city_curriculum_days: 'City Curriculum Days',
        values_hero: 'Values & Faith',
        ethical_leaders: 'Ethical Leaders',
        discover_video: 'Discover Video',
        cta_begin_your_journey: 'Begin Your Journey'
      };
      return SECTION_NAMES[section] || (section ? section.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase()) : 'Unknown Section');
    }

    // Format time in seconds to human-readable
    function formatDuration(seconds) {
      seconds = Math.round(seconds || 0);
      if (seconds < 60) return `${seconds}s`;
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return secs > 0 ? `${mins}m ${secs}s` : `${mins}m`;
    }

    async function loadBookingSessions(bookingId) {
      const container = document.getElementById(`booking-${bookingId}-sessions-container`);
      try {
        const res = await fetch(`${API_URL}/api/bookings/${bookingId}/sessions`);
        const data = await res.json();

        if (data.success) {
          if (!data.visits || data.visits.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 1rem; color: #999;">No prospectus viewing activity found</div>';
          } else {
            // Display visits like admin app SMART Tracking
            let html = `<div style="margin-bottom: 0.75rem; font-size: 0.85rem; color: #666;">${data.total_visits} visit${data.total_visits > 1 ? 's' : ''} recorded</div>`;

            html += data.visits.map(visit => {
              const visitDate = new Date(visit.started_at);
              const dateStr = visitDate.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' });
              const timeStr = visitDate.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
              const sectionsCount = visit.sections.length;

              // Build section items
              const sectionsHtml = visit.sections.length > 0
                ? visit.sections.map(s => {
                    const maxTime = Math.max(...visit.sections.map(sec => sec.time_spent), 1);
                    const barWidth = Math.min(100, (s.time_spent / maxTime) * 100);
                    return `
                      <div style="display: flex; align-items: center; padding: 0.5rem; background: #f8f9fa; border-radius: 4px; margin-bottom: 0.25rem;">
                        <div style="width: 20px; height: 20px; background: #1a2b5c; border-radius: 4px; display: flex; align-items: center; justify-content: center; margin-right: 0.75rem;">
                          <span style="color: white; font-size: 10px;">ðŸ“–</span>
                        </div>
                        <div style="flex: 1;">
                          <div style="font-weight: 500; font-size: 0.85rem;">${formatSectionName(s.section)}</div>
                          <div style="font-size: 0.75rem; color: #666;">Time spent: ${formatDuration(s.time_spent)}</div>
                          <div style="height: 4px; background: #e0e0e0; border-radius: 2px; margin-top: 4px;">
                            <div style="height: 100%; width: ${barWidth}%; background: linear-gradient(90deg, #1a2b5c, #FF6B9D); border-radius: 2px;"></div>
                          </div>
                        </div>
                      </div>
                    `;
                  }).join('')
                : '<div style="padding: 0.5rem; color: #999; font-size: 0.85rem;">Started visit (no sections viewed)</div>';

              return `
                <div style="border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 1rem; overflow: hidden;">
                  <div style="background: #1a2b5c; color: white; padding: 0.75rem 1rem; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                      <strong>Visit ${visit.visit_number}</strong>
                      <div style="font-size: 0.75rem; opacity: 0.9;">${dateStr}, ${timeStr} â€¢ ${visit.country || 'GB'}</div>
                    </div>
                  </div>
                  <div style="padding: 0.75rem;">
                    <div style="padding: 0.5rem; background: #f8fafc; border-radius: 6px; margin-bottom: 0.75rem; font-size: 0.85rem;">
                      <strong>Visit Summary:</strong> ${sectionsCount} section${sectionsCount !== 1 ? 's' : ''} viewed â€¢ Total time: ${formatDuration(visit.total_time)}
                    </div>
                    ${sectionsHtml}
                  </div>
                </div>
              `;
            }).join('');

            container.innerHTML = html;
          }
        }
      } catch (error) {
        console.error('Load sessions error:', error);
        container.innerHTML = '<div style="text-align: center; padding: 1rem; color: #dc3545;">Failed to load session history</div>';
      }
    }

    async function loadBookingTourFeedback(bookingId) {
      const container = document.getElementById(`booking-${bookingId}-feedback-container`);
      try {
        const res = await fetch(`${API_URL}/api/bookings/${bookingId}/tour-feedback`);
        const data = await res.json();

        if (data.success) {
          if (data.feedback.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 1rem; color: #999;">No SMART feedback submitted yet</div>';
          } else {
            container.innerHTML = data.feedback.map(feedback => {
              const responses = feedback.responses;
              const submittedDate = new Date(feedback.submitted_at).toLocaleString('en-GB');

              return `
                <div style="background: #f8f9fa; padding: 1rem; border-left: 3px solid #FF9F1C; margin-bottom: 1rem; border-radius: 4px;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; padding-bottom: 0.75rem; border-bottom: 2px solid #e0e0e0;">
                    <div>
                      <strong style="color: #FF9F1C; font-size: 1rem;">Submission #${feedback.submission_number}</strong>
                      <div style="font-size: 0.75rem; color: #666; margin-top: 0.25rem;">
                        By ${feedback.guide_name || 'Tour Guide'} â€¢ ${submittedDate}
                      </div>
                    </div>
                  </div>

                  <div style="display: grid; gap: 0.75rem;">
                    ${Object.entries(responses).map(([key, value]) => {
                      const label = key.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                      let displayValue = value;

                      // Format arrays (checkboxes)
                      if (Array.isArray(value)) {
                        displayValue = value.join(', ');
                      }

                      // Format ratings
                      if (key.includes('rating') && !isNaN(value)) {
                        displayValue = 'â­'.repeat(parseInt(value)) + ` (${value}/5)`;
                      }

                      return `
                        <div style="padding: 0.5rem 0; border-bottom: 1px solid #e0e0e0;">
                          <div style="font-weight: 600; color: #555; font-size: 0.85rem; margin-bottom: 0.25rem;">${label}</div>
                          <div style="color: #333; font-size: 0.875rem;">${displayValue || '-'}</div>
                        </div>
                      `;
                    }).join('')}
                  </div>
                </div>
              `;
            }).join('');
          }
        }
      } catch (error) {
        console.error('Load tour feedback error:', error);
        container.innerHTML = '<div style="text-align: center; padding: 1rem; color: #dc3545;">Failed to load SMART feedback</div>';
      }
    }

    async function addBookingNote(bookingId) {
      const textarea = document.getElementById(`booking-${bookingId}-new-note`);
      const note = textarea.value.trim();

      if (!note) {
        alert('Please enter a note');
        return;
      }

      try {
        const res = await fetch(`${API_URL}/api/bookings/${bookingId}/notes`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ note })
        });

        const data = await res.json();

        if (data.success) {
          textarea.value = '';
          await loadBookingNotes(bookingId);
        } else {
          alert('Failed to add note: ' + (data.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Add note error:', error);
        alert('Failed to add note');
      }
    }

    async function updateBookingStatus(id, status) {
      try {
        const res = await fetch(`${API_URL}/api/bookings/${id}/status`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status })
        });

        if (res.ok) {
          loadDashboard();
        } else {
          alert('Failed to update booking');
        }
      } catch (error) {
        console.error('Update booking error:', error);
      }
    }

    async function checkInBooking(id) {
      try {
        const res = await fetch(`${API_URL}/api/bookings/${id}/checkin`, {
          method: 'POST'
        });

        if (res.ok) {
          loadDashboard();
        } else {
          alert('Failed to check in');
        }
      } catch (error) {
        console.error('Check-in error:', error);
      }
    }

    async function markAsNoShow(id) {
      if (!confirm('Mark this booking as a no-show? A follow-up email will be sent to the parent.')) {
        return;
      }

      try {
        const res = await fetch(`${API_URL}/api/bookings/${id}/no-show`, {
          method: 'PUT'
        });

        if (res.ok) {
          loadDashboard();
        } else {
          alert('Failed to mark as no-show');
        }
      } catch (error) {
        console.error('Mark as no-show error:', error);
      }
    }

    // Private Tour Scheduling Functions
    async function showScheduleModal(bookingId, parentName) {
      document.getElementById('schedule-booking-id').value = bookingId;
      document.getElementById('schedule-parent-name').textContent = parentName;

      // Fetch the booking details to show parent's request
      try {
        const bookingRes = await fetch(`${API_URL}/api/bookings/${bookingId}`);
        const bookingData = await bookingRes.json();

        if (bookingData.booking && bookingData.booking.special_requirements) {
          const specialReqs = bookingData.booking.special_requirements;

          // Parse the special requirements for PRIVATE TOUR REQUEST
          const lines = specialReqs.split('\n');
          let preferredDate = '';
          let preferredTime = '';
          let additionalNotes = '';
          let isParsingRequest = false;

          for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();

            if (line === 'PRIVATE TOUR REQUEST') {
              isParsingRequest = true;
              continue;
            }

            if (line.startsWith('Preferred Date:')) {
              preferredDate = line.replace('Preferred Date:', '').trim();
            } else if (line.startsWith('Preferred Time:')) {
              preferredTime = line.replace('Preferred Time:', '').trim();
            } else if (isParsingRequest && line && !line.startsWith('Preferred')) {
              additionalNotes += line + ' ';
            }
          }

          // Display the parent's request if we found any info
          if (preferredDate || preferredTime || additionalNotes) {
            const requestInfoDiv = document.getElementById('parent-request-info');
            const requestDetailsDiv = document.getElementById('request-details');

            let requestHTML = '';
            if (preferredDate && preferredDate !== 'Flexible') {
              requestHTML += `<p style="margin: 0.5rem 0;"><strong>Preferred Date:</strong> ${preferredDate}</p>`;
            }
            if (preferredTime && preferredTime !== 'Flexible') {
              requestHTML += `<p style="margin: 0.5rem 0;"><strong>Preferred Time:</strong> ${preferredTime}</p>`;
            }
            if (additionalNotes.trim()) {
              requestHTML += `<p style="margin: 0.5rem 0;"><strong>Notes:</strong> ${additionalNotes.trim()}</p>`;
            }

            requestDetailsDiv.innerHTML = requestHTML;
            requestInfoDiv.style.display = 'block';
          } else {
            document.getElementById('parent-request-info').style.display = 'none';
          }
        } else {
          document.getElementById('parent-request-info').style.display = 'none';
        }
      } catch (error) {
        console.error('Load booking details error:', error);
        document.getElementById('parent-request-info').style.display = 'none';
      }

      // Load tour guides for the dropdown
      try {
        const res = await fetch(`${API_URL}/api/tour-guides?schoolId=${SCHOOL_ID}`);
        const data = await res.json();
        const guides = data.guides || [];

        const guideSelect = document.getElementById('schedule-guide');
        guideSelect.innerHTML = '<option value="">No guide assigned</option>';
        guides.forEach(guide => {
          if (guide.is_active) {
            guideSelect.innerHTML += `<option value="${guide.id}">${guide.name} (${guide.type})</option>`;
          }
        });
      } catch (error) {
        console.error('Load guides error:', error);
      }

      document.getElementById('scheduleTourModal').classList.add('show');
    }

    async function showAssignGuideModal(bookingId, studentName) {
      document.getElementById('assign-booking-id').value = bookingId;
      document.getElementById('assign-student-name').textContent = studentName;

      // Load tour guides for the dropdown
      try {
        const res = await fetch(`${API_URL}/api/tour-guides?schoolId=${SCHOOL_ID}`);
        const data = await res.json();
        const guides = data.guides || [];

        const guideSelect = document.getElementById('assign-guide-select');
        guideSelect.innerHTML = '<option value="">Select a tour guide</option>';
        guides.forEach(guide => {
          if (guide.is_active) {
            guideSelect.innerHTML += `<option value="${guide.id}">${guide.name} (${guide.type})</option>`;
          }
        });
      } catch (error) {
        console.error('Load guides error:', error);
      }

      document.getElementById('assignGuideModal').classList.add('show');
    }

    async function submitAssignGuide() {
      const bookingId = document.getElementById('assign-booking-id').value;
      const guideId = document.getElementById('assign-guide-select').value;

      if (!guideId) {
        alert('Please select a tour guide');
        return;
      }

      try {
        const res = await fetch(`${API_URL}/api/bookings/${bookingId}/assign-guide`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ guideId })
        });

        const data = await res.json();

        if (data.success) {
          closeModal('assignGuideModal');
          await loadDashboard();
          alert('Tour guide assigned successfully!');
        } else {
          alert('Failed to assign guide: ' + (data.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Assign guide error:', error);
        alert('Failed to assign guide. Please try again.');
      }
    }

    async function showPrintGuideAssignmentsModal() {
      try {
        // Load open day events (all upcoming events)
        const eventsRes = await fetch(`${API_URL}/api/events?schoolId=${SCHOOL_ID}&eventType=open_day`);
        const eventsData = await eventsRes.json();
        let events = eventsData.events || [];

        // Sort by date and show upcoming/recent events
        events = events.sort((a, b) => new Date(b.event_date) - new Date(a.event_date));

        const eventSelect = document.getElementById('print-event-select');
        eventSelect.innerHTML = '<option value="">Select an event</option>';

        if (events.length === 0) {
          eventSelect.innerHTML += '<option value="" disabled>No open day events found</option>';
        } else {
          events.forEach(event => {
            const dateStr = new Date(event.event_date).toLocaleDateString('en-GB', {
              weekday: 'long',
              day: 'numeric',
              month: 'long',
              year: 'numeric'
            });
            eventSelect.innerHTML += `<option value="${event.id}">${event.title} - ${dateStr}</option>`;
          });
        }

        // Load tour guides
        const guidesRes = await fetch(`${API_URL}/api/tour-guides?schoolId=${SCHOOL_ID}`);
        const guidesData = await guidesRes.json();
        const guides = guidesData.guides || [];

        const guideSelect = document.getElementById('print-guide-select');
        guideSelect.innerHTML = '<option value="">All Guides</option>';
        guides.forEach(guide => {
          if (guide.is_active) {
            guideSelect.innerHTML += `<option value="${guide.id}">${guide.name} (${guide.type})</option>`;
          }
        });

        document.getElementById('printGuideAssignmentsModal').classList.add('show');
      } catch (error) {
        console.error('Load print modal error:', error);
        alert('Failed to load events and guides. Please try again.');
      }
    }

    async function printGuideAssignments() {
      const eventId = document.getElementById('print-event-select').value;
      const guideId = document.getElementById('print-guide-select').value;

      if (!eventId) {
        alert('Please select an event');
        return;
      }

      try {
        // Fetch bookings for the selected event with assigned guides
        let url = API_URL + '/api/bookings?schoolId=' + SCHOOL_ID + '&eventId=' + eventId + '&status=confirmed';
        console.log('Fetching bookings from:', url);
        const res = await fetch(url);
        const data = await res.json();
        console.log('Received data:', data);
        let bookings = data.bookings || [];

        // Filter by assigned guides only
        bookings = bookings.filter(b => b.assigned_guide_id);

        // If specific guide selected, filter further
        if (guideId) {
          bookings = bookings.filter(b => b.assigned_guide_id == guideId);
        }

        if (bookings.length === 0) {
          alert('No assigned tours found for the selected criteria');
          return;
        }

        // Group bookings by guide
        const byGuide = {};
        bookings.forEach(b => {
          const gName = b.guide_name || 'Unassigned';
          if (!byGuide[gName]) {
            byGuide[gName] = [];
          }
          byGuide[gName].push(b);
        });

        // Generate printable HTML
        const eventName = document.getElementById('print-event-select').selectedOptions[0].text;
        let html = `
          <!DOCTYPE html>
          <html>
          <head>
            <title>Guide Assignments - ${eventName}</title>
            <style>
              @media print {
                @page { margin: 1cm; }
                body { margin: 0; }
                .page-break { page-break-before: always; }
              }
              body {
                font-family: Arial, sans-serif;
                font-size: 12pt;
                line-height: 1.4;
                color: #000;
              }
              h1 {
                font-size: 20pt;
                margin-bottom: 0.5cm;
                border-bottom: 3px solid #1a365d;
                padding-bottom: 0.3cm;
              }
              h2 {
                font-size: 16pt;
                margin-top: 0.8cm;
                margin-bottom: 0.4cm;
                color: #1a365d;
              }
              .tour-card {
                border: 2px solid #e0e0e0;
                padding: 0.5cm;
                margin-bottom: 0.5cm;
                border-radius: 8px;
                background: #f9f9f9;
                break-inside: avoid;
              }
              .tour-header {
                font-weight: bold;
                font-size: 14pt;
                margin-bottom: 0.3cm;
                color: #1a365d;
              }
              .tour-details {
                margin-left: 0.3cm;
              }
              .tour-details div {
                margin-bottom: 0.2cm;
              }
              .label {
                font-weight: 600;
                display: inline-block;
                width: 150px;
              }
              .badge {
                display: inline-block;
                padding: 0.1cm 0.3cm;
                margin: 0.1cm;
                background: #e3f2fd;
                border-radius: 4px;
                font-size: 10pt;
              }
              .interests {
                margin-top: 0.3cm;
              }
            </style>
          </head>
          <body>
            <h1>Tour Guide Assignments</h1>
            <div style="margin-bottom: 0.8cm;">
              <strong>Event:</strong> ${eventName}<br>
              <strong>Generated:</strong> ${new Date().toLocaleString('en-GB')}
            </div>
        `;

        // Generate cards for each guide
        Object.keys(byGuide).sort().forEach((guideName, index) => {
          if (index > 0) {
            html += '<div class="page-break"></div>';
          }
          html += `<h2>Tour Guide: ${guideName}</h2>`;
          html += `<div style="margin-bottom: 0.3cm;"><strong>${byGuide[guideName].length}</strong> tour(s) assigned</div>`;

          byGuide[guideName].forEach((booking, i) => {
            const studentName = `${booking.student_first_name || ''} ${booking.student_last_name || ''}`.trim() || 'N/A';
            const parentName = `${booking.parent_first_name} ${booking.parent_last_name}`;
            const ageGroup = booking.age_group || '';
            const entryYear = booking.entry_year || '';

            // Collect interests
            const interests = [];
            if (booking.sciences) interests.push('Sciences');
            if (booking.mathematics) interests.push('Mathematics');
            if (booking.english) interests.push('English');
            if (booking.languages) interests.push('Languages');
            if (booking.humanities) interests.push('Humanities');
            if (booking.business) interests.push('Business');
            if (booking.drama) interests.push('Drama');
            if (booking.music) interests.push('Music');
            if (booking.art) interests.push('Art');
            if (booking.creative_writing) interests.push('Creative Writing');
            if (booking.sport) interests.push('Sport');

            const priorities = [];
            if (booking.leadership) priorities.push('Leadership');
            if (booking.community_service) priorities.push('Community Service');
            if (booking.outdoor_education) priorities.push('Outdoor Education');
            if (booking.academic_excellence) priorities.push('Academic Excellence');
            if (booking.pastoral_care) priorities.push('Pastoral Care');
            if (booking.university_preparation) priorities.push('University Preparation');
            if (booking.personal_development) priorities.push('Personal Development');
            if (booking.career_guidance) priorities.push('Career Guidance');
            if (booking.extracurricular_opportunities) priorities.push('Extracurricular Opportunities');

            html += `
              <div class="tour-card">
                <div class="tour-header">Tour ${i + 1}: ${studentName}</div>
                <div class="tour-details">
                  <div><span class="label">Student:</span>${studentName}${ageGroup ? ` (${ageGroup})` : ''}</div>
                  <div><span class="label">Parent:</span>${parentName}</div>
                  <div><span class="label">Contact:</span>${booking.email}${booking.phone ? ' â€¢ ' + booking.phone : ''}</div>
                  ${entryYear ? `<div><span class="label">Entry Year:</span>${entryYear}</div>` : ''}
                  <div><span class="label">Attendees:</span>${booking.num_attendees}</div>
                  ${interests.length > 0 ? `
                    <div class="interests">
                      <span class="label">Subject Interests:</span><br>
                      ${interests.map(i => `<span class="badge">${i}</span>`).join('')}
                    </div>
                  ` : ''}
                  ${priorities.length > 0 ? `
                    <div class="interests">
                      <span class="label">Priorities:</span><br>
                      ${priorities.map(p => `<span class="badge">${p}</span>`).join('')}
                    </div>
                  ` : ''}
                  ${booking.special_requirements ? `
                    <div style="margin-top: 0.3cm; padding: 0.2cm; background: #fff3cd; border-radius: 4px;">
                      <strong>Special Requirements:</strong><br>
                      ${booking.special_requirements}
                    </div>
                  ` : ''}
                </div>
              </div>
            `;
          });
        });

        html += `
          </body>
          </html>
        `;

        // Create a hidden iframe for printing
        let printFrame = document.getElementById('printFrame');
        if (!printFrame) {
          printFrame = document.createElement('iframe');
          printFrame.id = 'printFrame';
          printFrame.style.position = 'absolute';
          printFrame.style.width = '0';
          printFrame.style.height = '0';
          printFrame.style.border = 'none';
          document.body.appendChild(printFrame);
        }

        // Write content to iframe
        const frameDoc = printFrame.contentWindow.document;
        frameDoc.open();
        frameDoc.write(html);
        frameDoc.close();

        // Wait a moment for content to load, then print
        setTimeout(() => {
          printFrame.contentWindow.focus();
          printFrame.contentWindow.print();
        }, 500);

        closeModal('printGuideAssignmentsModal');
      } catch (error) {
        console.error('Print guide assignments error:', error);
        alert('Failed to generate print view: ' + error.message + '. Check console for details.');
      }
    }

    async function showDeclineModal(bookingId, parentName) {
      document.getElementById('decline-booking-id').value = bookingId;
      document.getElementById('decline-parent-name').textContent = parentName;

      // Reset alternative dates to just one row
      document.getElementById('alternative-dates-container').innerHTML = `
        <div class="alternative-date-row" style="display: flex; gap: 10px; margin-bottom: 10px;">
          <input type="date" class="form-input alt-date" style="flex: 1;">
          <input type="time" class="form-input alt-time" style="flex: 1;">
        </div>
      `;

      document.getElementById('declineTourModal').classList.add('show');
    }

    function addAlternativeDateRow() {
      const container = document.getElementById('alternative-dates-container');
      const newRow = document.createElement('div');
      newRow.className = 'alternative-date-row';
      newRow.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px;';
      newRow.innerHTML = `
        <input type="date" class="form-input alt-date" style="flex: 1;">
        <input type="time" class="form-input alt-time" style="flex: 1;">
        <button type="button" onclick="this.parentElement.remove()" class="btn btn-sm btn-danger" style="width: auto;">Remove</button>
      `;
      container.appendChild(newRow);
    }

    // Schedule Tour Form Submit
    document.getElementById('scheduleTourForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const bookingId = document.getElementById('schedule-booking-id').value;
      const scheduledDate = document.getElementById('schedule-date').value;
      const scheduledTime = document.getElementById('schedule-time').value;
      const assignedGuideId = document.getElementById('schedule-guide').value || null;

      try {
        const res = await fetch(`${API_URL}/api/bookings/${bookingId}/schedule`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            scheduled_date: scheduledDate,
            scheduled_time: scheduledTime,
            assigned_guide_id: assignedGuideId
          })
        });

        if (res.ok) {
          alert('Tour scheduled successfully! Confirmation email sent to parent.');
          closeModal('scheduleTourModal');
          e.target.reset();
          loadDashboard();
        } else {
          const error = await res.json();
          alert('Failed to schedule tour: ' + (error.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Schedule tour error:', error);
        alert('Failed to schedule tour. Please try again.');
      }
    });

    // Decline Tour Form Submit
    document.getElementById('declineTourForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const bookingId = document.getElementById('decline-booking-id').value;
      const declineReason = document.getElementById('decline-reason').value;

      // Collect alternative dates
      const altDateInputs = document.querySelectorAll('.alt-date');
      const altTimeInputs = document.querySelectorAll('.alt-time');
      const alternativeDates = [];

      for (let i = 0; i < altDateInputs.length; i++) {
        const date = altDateInputs[i].value;
        const time = altTimeInputs[i].value;
        if (date && time) {
          alternativeDates.push({ date, time });
        }
      }

      try {
        const res = await fetch(`${API_URL}/api/bookings/${bookingId}/decline`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            decline_reason: declineReason,
            alternative_dates: alternativeDates
          })
        });

        if (res.ok) {
          alert('Tour declined. Email sent to parent with alternative dates.');
          closeModal('declineTourModal');
          e.target.reset();
          loadDashboard();
        } else {
          const error = await res.json();
          alert('Failed to decline tour: ' + (error.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Decline tour error:', error);
        alert('Failed to decline tour. Please try again.');
      }
    });

    // Edit Booking Functions
    async function showEditBookingModal(bookingId) {
      try {
        // Fetch the booking data and tour guides in parallel
        const [bookingRes, guidesRes] = await Promise.all([
          fetch(`${API_URL}/api/bookings/${bookingId}`),
          fetch(`${API_URL}/api/tour-guides?schoolId=${SCHOOL_ID}`)
        ]);

        const data = await bookingRes.json();
        const guidesData = await guidesRes.json();

        if (!data.success || !data.booking) {
          alert('Failed to load booking data');
          return;
        }

        const booking = data.booking;
        const guides = guidesData.guides || [];

        // Populate the modal form with current values
        document.getElementById('edit-booking-id').value = booking.id;
        document.getElementById('edit-booking-reference').textContent = `#${booking.id}`;
        document.getElementById('edit-parent-first-name').value = booking.parent_first_name || '';
        document.getElementById('edit-parent-last-name').value = booking.parent_last_name || '';
        document.getElementById('edit-email').value = booking.email || '';
        document.getElementById('edit-phone').value = booking.phone || '';
        document.getElementById('edit-student-first-name').value = booking.student_first_name || '';
        document.getElementById('edit-student-last-name').value = booking.student_last_name || '';
        // Use age_group if available, fallback to student_year_group for old bookings
        document.getElementById('edit-age-group').value = booking.age_group || booking.student_year_group || '';
        document.getElementById('edit-num-attendees').value = booking.num_attendees || 1;
        document.getElementById('edit-special-requirements').value = booking.special_requirements || '';
        document.getElementById('edit-preferred-language').value = booking.preferred_language || '';

        // Populate tour guides dropdown
        const guideSelect = document.getElementById('edit-assigned-guide');
        guideSelect.innerHTML = '<option value="">No guide assigned</option>';
        guides.filter(g => g.is_active).forEach(guide => {
          const option = document.createElement('option');
          option.value = guide.id;
          option.textContent = `${guide.name} (${guide.type})`;
          guideSelect.appendChild(option);
        });

        // Set current guide and store original (convert to string for comparison)
        const currentGuideId = booking.assigned_guide_id ? String(booking.assigned_guide_id) : '';
        console.log('Setting guide dropdown to:', currentGuideId, 'from booking:', booking.assigned_guide_id);
        guideSelect.value = currentGuideId;
        document.getElementById('edit-original-guide-id').value = currentGuideId;
        console.log('Dropdown value after setting:', guideSelect.value);

        // Load outcome data
        const outcomeRes = await fetch(`${API_URL}/api/bookings/${bookingId}/outcome`);
        if (outcomeRes.ok) {
          const outcomeData = await outcomeRes.json();
          if (outcomeData.success && outcomeData.outcome) {
            document.getElementById('edit-outcome-status').value = outcomeData.outcome.outcome_status || '';
            document.getElementById('edit-enrollment-year').value = outcomeData.outcome.enrollment_year || '';
            document.getElementById('edit-outcome-notes').value = outcomeData.outcome.notes || '';

            // Show/hide enrollment year based on status
            if (outcomeData.outcome.outcome_status === 'enrolled') {
              document.getElementById('enrollment-year-group').style.display = 'block';
            }
          }
        }

        // Show the modal
        document.getElementById('editBookingModal').classList.add('show');
      } catch (error) {
        console.error('Load booking for edit error:', error);
        alert('Failed to load booking. Please try again.');
      }
    }

    async function saveBookingEdits() {
      const bookingId = document.getElementById('edit-booking-id').value;
      const originalGuideId = document.getElementById('edit-original-guide-id').value;
      const newGuideId = document.getElementById('edit-assigned-guide').value;

      console.log('Saving booking edits:', { bookingId, originalGuideId, newGuideId });

      const updateData = {
        parent_first_name: document.getElementById('edit-parent-first-name').value,
        parent_last_name: document.getElementById('edit-parent-last-name').value,
        email: document.getElementById('edit-email').value,
        phone: document.getElementById('edit-phone').value,
        student_first_name: document.getElementById('edit-student-first-name').value,
        student_last_name: document.getElementById('edit-student-last-name').value,
        num_attendees: parseInt(document.getElementById('edit-num-attendees').value),
        special_requirements: document.getElementById('edit-special-requirements').value || null,
        preferred_language: document.getElementById('edit-preferred-language').value || null,
        assigned_guide_id: newGuideId ? parseInt(newGuideId) : null
      };

      console.log('Update data:', updateData);

      try {
        console.log('Sending update request for booking:', bookingId);
        console.log('Update data:', updateData);

        const res = await fetch(`${API_URL}/api/bookings/${bookingId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updateData)
        });

        console.log('Response status:', res.status);
        console.log('Response ok:', res.ok);

        const data = await res.json();
        console.log('Response data:', data);

        if (data.success) {
          // Check if tour guide changed and handle email notifications
          const guideChanged = originalGuideId !== newGuideId;
          if (guideChanged) {
            console.log('Tour guide changed from', originalGuideId, 'to', newGuideId);
            try {
              const emailRes = await fetch(`${API_URL}/api/bookings/${bookingId}/reassign-guide`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  oldGuideId: originalGuideId || null,
                  newGuideId: newGuideId || null
                })
              });
              const emailData = await emailRes.json();
              console.log('Reassign guide response:', emailData);
              if (!emailRes.ok) {
                console.error('Reassign guide failed:', emailData);
              }
            } catch (emailError) {
              console.error('Failed to send guide notification emails:', emailError);
              // Don't fail the whole update if emails fail
            }
          }

          // Also update outcome if status is set
          const outcomeStatus = document.getElementById('edit-outcome-status').value;
          if (outcomeStatus) {
            const outcomeData = {
              outcome_status: outcomeStatus,
              enrollment_year: document.getElementById('edit-enrollment-year').value || null,
              notes: document.getElementById('edit-outcome-notes').value || null,
              outcome_date: new Date().toISOString().split('T')[0]
            };

            await fetch(`${API_URL}/api/bookings/${bookingId}/outcome`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(outcomeData)
            });
          }

          closeModal('editBookingModal');
          await loadDashboard();
          alert('Booking updated successfully!');
        } else {
          console.error('Update failed with data:', data);
          alert('Failed to update booking: ' + (data.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Update booking error:', error);
        console.error('Error details:', error.message, error.stack);
        alert('Failed to update booking. Please try again.');
      }
    }

    // Handle outcome status change to show/hide enrollment year
    document.addEventListener('DOMContentLoaded', () => {
      const outcomeStatusSelect = document.getElementById('edit-outcome-status');
      if (outcomeStatusSelect) {
        outcomeStatusSelect.addEventListener('change', (e) => {
          const enrollmentYearGroup = document.getElementById('enrollment-year-group');
          if (e.target.value === 'enrolled') {
            enrollmentYearGroup.style.display = 'block';
          } else {
            enrollmentYearGroup.style.display = 'none';
          }
        });
      }
    });

    // Edit Booking Form Submit
    document.getElementById('editBookingForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      await saveBookingEdits();
    });

    // Tour Guides
    async function loadGuides() {
      try {
        const res = await fetch(`${API_URL}/api/tour-guides?schoolId=${SCHOOL_ID}`);
        const data = await res.json();
        renderGuides(data.guides || []);
      } catch (error) {
        console.error('Load guides error:', error);
      }
    }

    function renderGuides(guides) {
      const container = document.getElementById('guides-list');

      if (guides.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>No tour guides added yet</p></div>';
        return;
      }

      container.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Type</th>
              <th>Email</th>
              <th>Phone</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${guides.map(g => `
              <tr>
                <td>${g.name}</td>
                <td>${g.type}</td>
                <td>${g.email || 'N/A'}</td>
                <td>${g.phone || 'N/A'}</td>
                <td>${g.is_active ? 'Active' : 'Inactive'}</td>
                <td>
                  <button class="btn btn-sm btn-secondary" onclick="showEditGuideModal(${g.id})">Edit</button>
                  <button class="btn btn-sm btn-danger" onclick="deleteGuide(${g.id})">Delete</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    // Create guide
    document.getElementById('createGuideForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(e.target);
      const data = {
        school_id: SCHOOL_ID,
        name: formData.get('name'),
        email: formData.get('email'),
        phone: formData.get('phone'),
        type: formData.get('type')
      };

      try {
        const res = await fetch(`${API_URL}/api/tour-guides`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (res.ok) {
          closeModal('createGuideModal');
          e.target.reset();
          loadGuides();
        } else {
          alert('Failed to add guide');
        }
      } catch (error) {
        console.error('Create guide error:', error);
      }
    });

    async function deleteGuide(id) {
      if (!confirm('Are you sure you want to delete this guide?')) return;

      try {
        const res = await fetch(`${API_URL}/api/tour-guides/${id}`, {
          method: 'DELETE'
        });

        if (res.ok) {
          loadGuides();
        } else {
          alert('Failed to delete guide');
        }
      } catch (error) {
        console.error('Delete guide error:', error);
      }
    }

    // Edit guide
    async function showEditGuideModal(guideId) {
      try {
        const res = await fetch(`${API_URL}/api/tour-guides?schoolId=${SCHOOL_ID}`);
        const data = await res.json();
        const guide = data.guides.find(g => g.id === guideId);

        if (!guide) {
          alert('Guide not found');
          return;
        }

        // Populate the form
        document.getElementById('edit-guide-id').value = guide.id;
        document.getElementById('edit-guide-name').value = guide.name;
        document.getElementById('edit-guide-email').value = guide.email || '';
        document.getElementById('edit-guide-phone').value = guide.phone || '';
        document.getElementById('edit-guide-type').value = guide.type;
        document.getElementById('edit-guide-active').checked = guide.is_active;

        // Show the modal
        document.getElementById('editGuideModal').classList.add('show');
      } catch (error) {
        console.error('Load guide error:', error);
        alert('Failed to load guide details');
      }
    }

    document.getElementById('editGuideForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const guideId = document.getElementById('edit-guide-id').value;
      const data = {
        name: document.getElementById('edit-guide-name').value,
        email: document.getElementById('edit-guide-email').value || null,
        phone: document.getElementById('edit-guide-phone').value || null,
        type: document.getElementById('edit-guide-type').value,
        is_active: document.getElementById('edit-guide-active').checked
      };

      try {
        const res = await fetch(`${API_URL}/api/tour-guides/${guideId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (res.ok) {
          closeModal('editGuideModal');
          loadGuides();
        } else {
          alert('Failed to update guide');
        }
      } catch (error) {
        console.error('Update guide error:', error);
        alert('Failed to update guide');
      }
    });

    // Email Templates
    async function loadEmailTemplates() {
      try {
        const res = await fetch(`${API_URL}/api/email-templates?schoolId=${SCHOOL_ID}`);
        const data = await res.json();
        renderEmailTemplates(data.templates || []);
      } catch (error) {
        console.error('Load email templates error:', error);
      }
    }

    function renderEmailTemplates(templates) {
      const container = document.getElementById('email-templates-list');

      if (templates.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>No email templates created yet</p></div>';
        return;
      }

      // Separate templates by booking type
      const openDayTemplates = templates.filter(t => t.booking_type === 'open_day' || t.booking_type === 'both');
      const privateTourTemplates = templates.filter(t => t.booking_type === 'private_tour' || t.booking_type === 'both');
      const tasterDayTemplates = templates.filter(t => t.booking_type === 'taster_day' || t.booking_type === 'both');

      const renderTemplateTable = (templateList, emptyMessage) => {
        if (templateList.length === 0) {
          return `<div class="empty-state" style="padding: 1rem; background: #F9FAFB; border-radius: 6px;"><p style="margin: 0; color: #6B7280;">${emptyMessage}</p></div>`;
        }

        return `
          <table>
            <thead>
              <tr>
                <th>Template Name</th>
                <th>Type</th>
                <th>Subject</th>
                <th>Status</th>
                <th>Automation</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${templateList.map(t => `
                <tr>
                  <td>${t.name}</td>
                  <td>${formatTemplateType(t.template_type)}</td>
                  <td>${t.subject}</td>
                  <td>${t.is_active ? '<span style="color: var(--success);">Active</span>' : '<span style="color: #9CA3AF;">Inactive</span>'}</td>
                  <td>${t.enable_automation ? '<span style="color: var(--award-gold);">Enabled</span>' : 'Manual'}</td>
                  <td>
                    <button class="btn btn-sm" onclick="editEmailTemplate(${t.id})" style="background: var(--sport-blue); color: white; margin-right: 0.5rem;">Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteEmailTemplate(${t.id})">Delete</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      };

      container.innerHTML = `
        <div style="margin-bottom: 2rem;">
          <div style="background: var(--blazer-navy); color: white; padding: 1rem 1.5rem; border-radius: 8px 8px 0 0; margin-bottom: 0;">
            <h3 style="margin: 0; font-size: 1.1rem; font-weight: 600;">Open Day Email Templates</h3>
          </div>
          <div style="background: white; padding: 1.5rem; border-radius: 0 0 8px 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
            ${renderTemplateTable(openDayTemplates, 'No Open Day templates created yet')}
          </div>
        </div>

        <div style="margin-bottom: 2rem;">
          <div style="background: #9b59b6; color: white; padding: 1rem 1.5rem; border-radius: 8px 8px 0 0; margin-bottom: 0;">
            <h3 style="margin: 0; font-size: 1.1rem; font-weight: 600;">Taster Day Email Templates</h3>
          </div>
          <div style="background: white; padding: 1.5rem; border-radius: 0 0 8px 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
            ${renderTemplateTable(tasterDayTemplates, 'No Taster Day templates created yet')}
          </div>
        </div>

        <div>
          <div style="background: var(--sport-blue); color: white; padding: 1rem 1.5rem; border-radius: 8px 8px 0 0; margin-bottom: 0;">
            <h3 style="margin: 0; font-size: 1.1rem; font-weight: 600;">Private Tour Email Templates</h3>
          </div>
          <div style="background: white; padding: 1.5rem; border-radius: 0 0 8px 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
            ${renderTemplateTable(privateTourTemplates, 'No Private Tour templates created yet')}
          </div>
        </div>
      `;
    }

    function formatTemplateType(type) {
      const types = {
        'booking_confirmation': 'Booking Confirmation',
        'tour_scheduled': 'Tour Scheduled',
        'tour_declined': 'Tour Declined',
        'tour_reminder': 'Tour Reminder',
        'no_show': 'No Show Follow Up',
        'follow_up': 'Follow Up',
        'custom': 'Custom'
      };
      return types[type] || type;
    }

    // Email template form submit handler
    document.getElementById('emailTemplateForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const id = document.getElementById('template-id').value;
      const data = {
        schoolId: SCHOOL_ID,
        name: document.getElementById('template-name').value,
        bookingType: document.getElementById('template-booking-type').value,
        templateType: document.getElementById('template-type').value,
        subject: document.getElementById('template-subject').value,
        body: document.getElementById('template-body').value,
        isActive: document.getElementById('template-active').checked,
        enableAutomation: document.getElementById('enable-automation').checked,
        automationTrigger: document.getElementById('automation-trigger').value || null,
        automationDays: parseInt(document.getElementById('automation-days').value) || null,
        automationTiming: document.getElementById('automation-timing').value || null
      };

      try {
        const url = id ? `${API_URL}/api/email-templates/${id}` : `${API_URL}/api/email-templates`;
        const method = id ? 'PUT' : 'POST';

        const res = await fetch(url, {
          method: method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (res.ok) {
          closeModal('emailTemplateModal');
          e.target.reset();
          loadEmailTemplates();
        } else {
          alert('Failed to save email template');
        }
      } catch (error) {
        console.error('Save email template error:', error);
      }
    });

    // Email template automation toggle
    document.getElementById('enable-automation').addEventListener('change', function() {
      const automationSettings = document.getElementById('automation-settings');
      automationSettings.style.display = this.checked ? 'block' : 'none';
    });

    // Email template trigger change handler
    document.getElementById('automation-trigger').addEventListener('change', function() {
      const timingGroup = document.getElementById('timing-group');
      const value = this.value;
      // Show timing options only for before_tour and after_tour
      timingGroup.style.display = (value === 'before_tour' || value === 'after_tour') ? 'block' : 'none';
    });

    async function editEmailTemplate(id) {
      try {
        const res = await fetch(`${API_URL}/api/email-templates?schoolId=${SCHOOL_ID}`);
        const data = await res.json();
        const template = data.templates.find(t => t.id === id);

        if (template) {
          document.getElementById('template-id').value = template.id;
          document.getElementById('template-name').value = template.name;
          document.getElementById('template-booking-type').value = template.booking_type || 'both';
          document.getElementById('template-type').value = template.template_type;
          document.getElementById('template-subject').value = template.subject;
          document.getElementById('template-body').value = template.body;
          document.getElementById('template-active').checked = template.is_active;
          document.getElementById('enable-automation').checked = template.enable_automation;

          if (template.enable_automation) {
            document.getElementById('automation-settings').style.display = 'block';
            document.getElementById('automation-trigger').value = template.automation_trigger || '';
            document.getElementById('automation-days').value = template.automation_days || 1;
            document.getElementById('automation-timing').value = template.automation_timing || 'before';

            const trigger = template.automation_trigger;
            document.getElementById('timing-group').style.display =
              (trigger === 'before_tour' || trigger === 'after_tour') ? 'block' : 'none';
          }

          document.getElementById('emailTemplateModalTitle').textContent = 'Edit Email Template';
          document.getElementById('emailTemplateModal').classList.add('show');
        }
      } catch (error) {
        console.error('Load template for edit error:', error);
      }
    }

    async function deleteEmailTemplate(id) {
      if (!confirm('Are you sure you want to delete this email template?')) return;

      try {
        const res = await fetch(`${API_URL}/api/email-templates/${id}`, {
          method: 'DELETE'
        });

        if (res.ok) {
          loadEmailTemplates();
        } else {
          alert('Failed to delete email template');
        }
      } catch (error) {
        console.error('Delete email template error:', error);
      }
    }

    // Form Builder
    let formTemplate = null;
    let formFields = [];
    let formSections = [];

    async function loadFormBuilder() {
      try {
        const res = await fetch(`${API_URL}/api/form-template/manage`);
        const data = await res.json();

        formTemplate = data.template;
        formFields = data.fields || [];

        // Load sections
        if (formTemplate) {
          const sectionsRes = await fetch(`${API_URL}/api/form-sections/${formTemplate.id}`);
          const sectionsData = await sectionsRes.json();
          formSections = sectionsData.sections || [];
        }

        renderFormBuilder();
      } catch (error) {
        console.error('Load form builder error:', error);
      }
    }

    function renderFormBuilder() {
      const container = document.getElementById('form-builder-container');

      if (!formTemplate) {
        container.innerHTML = '<p style="color: #6B7280;">No form template found. Please contact support.</p>';
        return;
      }

      container.innerHTML = `
        <div style="margin-bottom: 2rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; border-bottom: 2px solid var(--award-gold); padding-bottom: 0.5rem;">
            <h3 style="color: var(--blazer-navy); margin: 0;">Form Sections</h3>
            <button class="btn btn-primary" onclick="showAddSectionModal()">+ Add Section</button>
          </div>
          <div id="form-sections-list"></div>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 2px solid var(--award-gold); padding-bottom: 0.5rem;">
          <h3 style="color: var(--blazer-navy); margin: 0;">Form Fields</h3>
          <div style="display: flex; gap: 0.5rem;">
            <button class="btn btn-secondary" onclick="showPreviewFormModal()">Preview Form</button>
            <button class="btn btn-primary" onclick="showAddFieldModal()">+ Add Field</button>
          </div>
        </div>

        <div id="form-fields-list"></div>
      `;

      renderSectionsList();
      renderFormFieldsList();
    }

    function renderFormFieldsList() {
      const listContainer = document.getElementById('form-fields-list');

      if (formFields.length === 0) {
        listContainer.innerHTML = '<p style="color: #6B7280; text-align: center; padding: 2rem;">No fields added yet. Click "Add Field" to create your first field.</p>';
        return;
      }

      listContainer.innerHTML = formFields
        .sort((a, b) => a.display_order - b.display_order)
        .map(field => `
          <div class="card" style="margin-bottom: 1rem; background: #F8FAFC;">
            <div class="card-body">
              <div style="display: flex; justify-content: space-between; align-items: start;">
                <div style="flex: 1;">
                  <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                    <span style="background: var(--blazer-navy); color: white; padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.875rem; font-weight: 600;">#${field.display_order}</span>
                    <h4 style="margin: 0; color: var(--blazer-navy);">${field.field_label}${field.is_required ? ' <span style="color: var(--danger);">*</span>' : ''}</h4>
                    <span style="background: var(--award-gold); color: var(--blazer-navy); padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.875rem; font-weight: 600;">${field.field_type}</span>
                  </div>
                  <div style="color: #6B7280; font-size: 0.875rem; margin-top: 0.5rem;">
                    ${field.placeholder ? `<p style="margin: 0.25rem 0;"><strong>Placeholder:</strong> ${field.placeholder}</p>` : ''}
                    ${field.help_text ? `<p style="margin: 0.25rem 0;"><strong>Help Text:</strong> ${field.help_text}</p>` : ''}
                    ${field.field_options ? `<p style="margin: 0.25rem 0;"><strong>Options:</strong> ${field.field_options}</p>` : ''}
                  </div>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                  <button class="btn btn-secondary" onclick="showEditFieldModal(${field.id})" style="padding: 0.5rem 1rem;">Edit</button>
                  <button class="btn btn-danger" onclick="deleteFormField(${field.id})" style="padding: 0.5rem 1rem;">Delete</button>
                </div>
              </div>
            </div>
          </div>
        `).join('');
    }

    function renderSectionsList() {
      const listContainer = document.getElementById('form-sections-list');

      if (formSections.length === 0) {
        listContainer.innerHTML = '<p style="color: #6B7280; text-align: center; padding: 1rem;">No sections added yet. Click "+ Add Section" to create sections for your form.</p>';
        return;
      }

      listContainer.innerHTML = formSections
        .sort((a, b) => a.display_order - b.display_order)
        .map(section => `
          <div class="card" style="margin-bottom: 0.75rem; background: #F0F9FF; border-left: 4px solid var(--award-gold);">
            <div class="card-body" style="padding: 1rem;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="flex: 1;">
                  <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <span style="background: var(--award-gold); color: var(--blazer-navy); padding: 0.2rem 0.6rem; border-radius: 4px; font-size: 0.875rem; font-weight: 600;">#${section.display_order}</span>
                    <h4 style="margin: 0; color: var(--blazer-navy); font-size: 1rem;">${section.section_label}</h4>
                  </div>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                  <button class="btn btn-secondary" onclick="showEditSectionModal(${section.id})" style="padding: 0.4rem 0.8rem; font-size: 0.875rem;">Edit</button>
                  <button class="btn btn-danger" onclick="deleteSection(${section.id})" style="padding: 0.4rem 0.8rem; font-size: 0.875rem;">Delete</button>
                </div>
              </div>
            </div>
          </div>
        `).join('');
    }

    function showAddSectionModal() {
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h3 style="color: var(--blazer-navy); margin: 0;">Add New Section</h3>
            <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 0.875rem; cursor: pointer; color: #6B7280;">&times;</button>
          </div>
          <form id="add-section-form">
            <div class="form-group">
              <label class="form-label">Section Label</label>
              <input type="text" class="form-input" name="section_label" placeholder="e.g., Family Details, Academic Interests" required>
              <small style="color: #6B7280; display: block; margin-top: 0.25rem;">This will be displayed as a heading in the form</small>
            </div>
            <div class="form-group">
              <label class="form-label">Display Order</label>
              <input type="number" class="form-input" name="display_order" value="${formSections.length + 1}" min="1" required>
              <small style="color: #6B7280; display: block; margin-top: 0.25rem;">Controls the order sections appear in the form</small>
            </div>
            <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
              <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
              <button type="submit" class="btn btn-primary">Add Section</button>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);
      modal.style.display = 'flex';

      document.getElementById('add-section-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const section_label = formData.get('section_label').trim();
        const display_order = parseInt(formData.get('display_order'));
        const section_name = section_label.toLowerCase().replace(/[^a-z0-9]+/g, '_');

        try {
          const res = await fetch(`${API_URL}/api/form-section`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              template_id: formTemplate.id,
              section_name,
              section_label,
              display_order
            })
          });

          if (res.ok) {
            modal.remove();
            loadFormBuilder();
          } else {
            alert('Failed to create section');
          }
        } catch (error) {
          console.error('Create section error:', error);
          alert('Failed to create section');
        }
      });
    }

    function showEditSectionModal(sectionId) {
      const section = formSections.find(s => s.id === sectionId);
      if (!section) return;

      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h3 style="color: var(--blazer-navy); margin: 0;">Edit Section</h3>
            <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 0.875rem; cursor: pointer; color: #6B7280;">&times;</button>
          </div>
          <form id="edit-section-form">
            <div class="form-group">
              <label class="form-label">Section Label</label>
              <input type="text" class="form-input" name="section_label" value="${section.section_label}" required>
            </div>
            <div class="form-group">
              <label class="form-label">Display Order</label>
              <input type="number" class="form-input" name="display_order" value="${section.display_order}" min="1" required>
            </div>
            <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
              <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
              <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);
      modal.style.display = 'flex';

      document.getElementById('edit-section-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const section_label = formData.get('section_label').trim();
        const display_order = parseInt(formData.get('display_order'));

        try {
          const res = await fetch(`${API_URL}/api/form-section/${sectionId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ section_label, display_order })
          });

          if (res.ok) {
            modal.remove();
            loadFormBuilder();
          } else {
            alert('Failed to update section');
          }
        } catch (error) {
          console.error('Update section error:', error);
          alert('Failed to update section');
        }
      });
    }

    async function deleteSection(sectionId) {
      if (!confirm('Are you sure you want to delete this section? Fields in this section will become unsectioned.')) {
        return;
      }

      try {
        const res = await fetch(`${API_URL}/api/form-section/${sectionId}`, {
          method: 'DELETE'
        });

        if (res.ok) {
          loadFormBuilder();
        } else {
          alert('Failed to delete section');
        }
      } catch (error) {
        console.error('Delete section error:', error);
        alert('Failed to delete section');
      }
    }

    function showAddFieldModal() {
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h3 style="color: var(--blazer-navy); margin: 0;">Add New Field</h3>
            <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 0.875rem; cursor: pointer; color: #6B7280;">&times;</button>
          </div>
          <form id="add-field-form">
            <div class="form-group">
              <label class="form-label">Field Label *</label>
              <input type="text" class="form-input" name="field_label" required placeholder="e.g., Interested in Scholarships">
              <small style="color: #6B7280; display: block; margin-top: 0.25rem;">This is what parents will see on the form</small>
            </div>
            <div class="form-group">
              <label class="form-label">Field Type *</label>
              <select class="form-input" name="field_type" required>
                <option value="">-- Select Type --</option>
                <option value="text">Text</option>
                <option value="email">Email</option>
                <option value="tel">Phone</option>
                <option value="textarea">Text Area</option>
                <option value="select">Dropdown Select</option>
                <option value="checkbox">Checkbox</option>
              </select>
            </div>
            <div class="form-group" id="field-options-group" style="display: none;">
              <label class="form-label">Options (one per line)</label>
              <textarea class="form-input" name="field_options" rows="6" placeholder="Football&#10;Rugby&#10;Cricket&#10;Hockey"></textarea>
              <small style="color: #6B7280; display: block; margin-top: 0.25rem;">Enter each option on a new line - required for dropdown fields</small>
            </div>
            <div class="form-group">
              <label class="form-label">Placeholder</label>
              <input type="text" class="form-input" name="placeholder" placeholder="e.g., Enter your name">
            </div>
            <div class="form-group">
              <label class="form-label">Help Text</label>
              <input type="text" class="form-input" name="help_text" placeholder="Additional instructions for the user">
            </div>
            <div class="form-group">
              <label class="form-label">Display Order *</label>
              <input type="number" class="form-input" name="display_order" required value="${formFields.length + 1}" min="1">
            </div>
            <div class="form-group">
              <label class="form-label">Show for Gender</label>
              <select class="form-input" name="show_for_gender">
                <option value="both">Both</option>
                <option value="male">Male only</option>
                <option value="female">Female only</option>
              </select>
              <small style="color: #6B7280; display: block; margin-top: 0.25rem;">Only show this field for specific gender (requires Gender field on form)</small>
            </div>
            <div class="form-group">
              <label class="form-label">Section (optional)</label>
              <select class="form-input" name="section_id">
                <option value="">No Section</option>
                ${formSections.sort((a, b) => a.display_order - b.display_order).map(section => `
                  <option value="${section.id}">${section.section_label}</option>
                `).join('')}
              </select>
              <small style="color: #6B7280; display: block; margin-top: 0.25rem;">Group this field under a specific section</small>
            </div>
            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" name="is_required" value="true">
                <span>Required field</span>
              </label>
            </div>
            <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1.5rem;">
              <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
              <button type="submit" class="btn btn-primary">Add Field</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);
      setTimeout(() => modal.classList.add('show'), 10);

      // Add event listener for field type change
      const fieldTypeSelect = modal.querySelector('select[name="field_type"]');
      fieldTypeSelect.addEventListener('change', function() {
        toggleFieldOptionsInModal(this.value, modal);
      });

      document.getElementById('add-field-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        await addFormField(e.target);
      });
    }

    function toggleFieldOptionsInModal(fieldType, modalElement) {
      const optionsGroup = modalElement.querySelector('#field-options-group');
      if (fieldType === 'select') {
        optionsGroup.style.display = 'block';
      } else {
        optionsGroup.style.display = 'none';
      }
    }

    async function addFormField(form) {
      const formData = new FormData(form);
      const section_id = formData.get('section_id');
      const data = {
        template_id: formTemplate.id,
        // field_name will be auto-generated by the backend
        field_label: formData.get('field_label'),
        field_type: formData.get('field_type'),
        field_options: formData.get('field_options') || null,
        is_required: formData.get('is_required') === 'true',
        placeholder: formData.get('placeholder') || null,
        help_text: formData.get('help_text') || null,
        display_order: parseInt(formData.get('display_order')),
        maps_to_inquiry_column: null, // Always null now
        show_for_gender: formData.get('show_for_gender') || 'both',
        section_id: section_id && section_id !== '' ? parseInt(section_id) : null
      };

      try {
        const res = await fetch(`${API_URL}/api/form-field`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (res.ok) {
          alert('Field added successfully');
          document.querySelector('.modal').remove();
          loadFormBuilder(); // Reload to show new field
        } else {
          alert('Failed to add field');
        }
      } catch (error) {
        console.error('Add form field error:', error);
        alert('Failed to add field');
      }
    }

    function showEditFieldModal(fieldId) {
      const field = formFields.find(f => f.id === fieldId);
      if (!field) return;

      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h3 style="color: var(--blazer-navy); margin: 0;">Edit Field</h3>
            <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 0.875rem; cursor: pointer; color: #6B7280;">&times;</button>
          </div>
          <form id="edit-field-form">
            <input type="hidden" name="field_id" value="${field.id}">
            <div class="form-group">
              <label class="form-label">Field Label *</label>
              <input type="text" class="form-input" name="field_label" required value="${field.field_label}">
              <small style="color: #6B7280; display: block; margin-top: 0.25rem;">This is what parents will see on the form</small>
            </div>
            <div class="form-group">
              <label class="form-label">Field Type *</label>
              <select class="form-input" name="field_type" required>
                <option value="text" ${field.field_type === 'text' ? 'selected' : ''}>Text</option>
                <option value="email" ${field.field_type === 'email' ? 'selected' : ''}>Email</option>
                <option value="tel" ${field.field_type === 'tel' ? 'selected' : ''}>Phone</option>
                <option value="textarea" ${field.field_type === 'textarea' ? 'selected' : ''}>Text Area</option>
                <option value="select" ${field.field_type === 'select' ? 'selected' : ''}>Dropdown Select</option>
                <option value="checkbox" ${field.field_type === 'checkbox' ? 'selected' : ''}>Checkbox</option>
              </select>
            </div>
            <div class="form-group" id="field-options-group" style="display: ${field.field_type === 'select' ? 'block' : 'none'};">
              <label class="form-label">Options (one per line)</label>
              <textarea class="form-input" name="field_options" rows="6" placeholder="Football&#10;Rugby&#10;Cricket&#10;Hockey">${field.field_options || ''}</textarea>
              <small style="color: #6B7280; display: block; margin-top: 0.25rem;">Enter each option on a new line</small>
            </div>
            <div class="form-group">
              <label class="form-label">Placeholder</label>
              <input type="text" class="form-input" name="placeholder" value="${field.placeholder || ''}">
            </div>
            <div class="form-group">
              <label class="form-label">Help Text</label>
              <input type="text" class="form-input" name="help_text" value="${field.help_text || ''}">
            </div>
            <div class="form-group">
              <label class="form-label">Display Order *</label>
              <input type="number" class="form-input" name="display_order" required value="${field.display_order}" min="1">
            </div>
            <div class="form-group">
              <label class="form-label">Show for Gender</label>
              <select class="form-input" name="show_for_gender">
                <option value="both" ${field.show_for_gender === 'both' || !field.show_for_gender ? 'selected' : ''}>Both</option>
                <option value="male" ${field.show_for_gender === 'male' ? 'selected' : ''}>Male only</option>
                <option value="female" ${field.show_for_gender === 'female' ? 'selected' : ''}>Female only</option>
              </select>
              <small style="color: #6B7280; display: block; margin-top: 0.25rem;">Only show this field for specific gender (requires Gender field on form)</small>
            </div>
            <div class="form-group">
              <label class="form-label">Section (optional)</label>
              <select class="form-input" name="section_id">
                <option value="">No Section</option>
                ${formSections.sort((a, b) => a.display_order - b.display_order).map(section => `
                  <option value="${section.id}" ${field.section_id === section.id ? 'selected' : ''}>${section.section_label}</option>
                `).join('')}
              </select>
              <small style="color: #6B7280; display: block; margin-top: 0.25rem;">Group this field under a specific section</small>
            </div>
            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" name="is_required" value="true" ${field.is_required ? 'checked' : ''}>
                <span>Required field</span>
              </label>
            </div>
            <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1.5rem;">
              <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
              <button type="submit" class="btn btn-primary">Update Field</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);
      setTimeout(() => modal.classList.add('show'), 10);

      // Add event listener for field type change
      const fieldTypeSelect = modal.querySelector('select[name="field_type"]');
      fieldTypeSelect.addEventListener('change', function() {
        toggleFieldOptionsInModal(this.value, modal);
      });

      document.getElementById('edit-field-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        await updateFormField(e.target);
      });
    }

    async function updateFormField(form) {
      const formData = new FormData(form);
      const fieldId = formData.get('field_id');
      const section_id = formData.get('section_id');
      const data = {
        // field_name is not editable, backend keeps it unchanged
        field_label: formData.get('field_label'),
        field_type: formData.get('field_type'),
        field_options: formData.get('field_options') || null,
        is_required: formData.get('is_required') === 'true',
        placeholder: formData.get('placeholder') || null,
        help_text: formData.get('help_text') || null,
        display_order: parseInt(formData.get('display_order')),
        maps_to_inquiry_column: null, // Always null now
        show_for_gender: formData.get('show_for_gender') || 'both',
        section_id: section_id && section_id !== '' ? parseInt(section_id) : null
      };

      try {
        const res = await fetch(`${API_URL}/api/form-field/${fieldId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (res.ok) {
          alert('Field updated successfully');
          document.querySelector('.modal').remove();
          loadFormBuilder(); // Reload to show updated field
        } else {
          alert('Failed to update field');
        }
      } catch (error) {
        console.error('Update form field error:', error);
        alert('Failed to update field');
      }
    }

    async function deleteFormField(fieldId) {
      if (!confirm('Are you sure you want to delete this field?')) return;

      try {
        const res = await fetch(`${API_URL}/api/form-field/${fieldId}`, {
          method: 'DELETE'
        });

        if (res.ok) {
          alert('Field deleted successfully');
          loadFormBuilder(); // Reload to update list
        } else {
          alert('Failed to delete field');
        }
      } catch (error) {
        console.error('Delete form field error:', error);
        alert('Failed to delete field');
      }
    }

    // Preview Form
    async function showPreviewFormModal() {
      try {
        // Fetch current settings for branding
        const settingsRes = await fetch(`${API_URL}/api/booking-settings/${SCHOOL_ID}`);

        if (!settingsRes.ok) {
          console.error('Failed to fetch settings:', settingsRes.status, settingsRes.statusText);
          alert('Failed to load branding settings');
          return;
        }

        const settingsData = await settingsRes.json();
        const settings = settingsData.settings;

        const primaryColour = settings.primary_colour || '#091825';
        const secondaryColour = settings.secondary_colour || '#FF9F1C';
        // Use logo_data (base64) if available, otherwise logo_url
        const logoUrl = settings.logo_data || (settings.logo_url ? settings.logo_url.trim() : null);
        const logoSize = settings.logo_size || 'medium';

        // Map logo size to pixel width
        const logoSizeMap = {
          small: '150px',
          medium: '200px',
          large: '300px',
          xlarge: '400px'
        };
        const logoMaxWidth = logoSizeMap[logoSize];

        const modal = document.createElement('div');
        modal.className = 'modal';

        // Group fields by section
        const fieldsWithoutSection = formFields.filter(f => !f.section_id).sort((a, b) => a.display_order - b.display_order);
        const fieldsBySection = {};

        formFields.filter(f => f.section_id).forEach(field => {
          if (!fieldsBySection[field.section_id]) {
            fieldsBySection[field.section_id] = [];
          }
          fieldsBySection[field.section_id].push(field);
        });

        // Render fields grouped by sections
        let fieldsHtml = '';

        // First render fields without section
        if (fieldsWithoutSection.length > 0) {
          fieldsHtml += fieldsWithoutSection.map(field => renderPreviewField(field, settings)).join('');
        }

        // Then render sections with their fields
        formSections.sort((a, b) => a.display_order - b.display_order).forEach(section => {
          if (fieldsBySection[section.id] && fieldsBySection[section.id].length > 0) {
            const sectionFields = fieldsBySection[section.id].sort((a, b) => a.display_order - b.display_order);
            fieldsHtml += `
              <div style="margin-top: 2rem; margin-bottom: 1.5rem;">
                <h3 style="color: ${primaryColour}; border-bottom: 2px solid ${secondaryColour}; padding-bottom: 0.5rem; margin-bottom: 1rem; font-family: 'Playfair Display', serif;">
                  ${section.section_label}
                </h3>
                ${sectionFields.map(field => renderPreviewField(field, settings)).join('')}
              </div>
            `;
          }
        });

        let logoHtml = logoUrl ?
          `<div style="text-align: center; margin-bottom: 2rem; padding: 1.5rem 0;">
            <img src="${logoUrl}" alt="School Logo" style="max-width: ${logoMaxWidth}; max-height: ${logoMaxWidth}; object-fit: contain;">
          </div>`
          : '';

        modal.innerHTML = `
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; position: sticky; top: 0; background: white; padding-bottom: 1rem; border-bottom: 2px solid ${secondaryColour};">
            <h3 style="color: ${primaryColour}; margin: 0;">Form Preview</h3>
            <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 0.875rem; cursor: pointer; color: #6B7280;">&times;</button>
          </div>

          <div style="background: ${primaryColour}; padding: 2rem; border-radius: 8px;">
            ${logoHtml}

            <h2 style="color: white; text-align: center; margin-bottom: 0.5rem; font-family: 'Playfair Display', serif;">${settings.form_heading || 'Enquiry Form'}</h2>
            <p style="text-align: center; color: white; margin-bottom: 2rem;">${settings.form_subtitle || 'Please complete the form below'}</p>

            <form style="background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              ${fieldsHtml}

              <button type="button" style="width: 100%; padding: 1rem; background: ${primaryColour}; color: white; border: none; border-radius: 4px; font-size: 0.875rem; font-weight: 600; cursor: not-allowed; opacity: 0.7; margin-top: 1.5rem;">
                Submit Enquiry (Preview Only)
              </button>
            </form>
          </div>
        </div>
        `;
        document.body.appendChild(modal);
        setTimeout(() => modal.classList.add('show'), 10);
      } catch (error) {
        console.error('Preview modal error:', error);
        alert('Error loading preview: ' + error.message);
      }
    }
    // Make globally accessible for onclick handlers
    window.showPreviewFormModal = showPreviewFormModal;

    function renderPreviewField(field, settings) {
      const primaryColour = settings.primary_colour || '#091825';
      const labelStyle = `display: block; margin-bottom: 0.5rem; font-weight: 500; color: ${primaryColour};`;
      const inputStyle = `width: 100%; padding: 0.75rem; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 0.875rem; transition: all 0.2s; font-family: inherit;`;
      const selectStyle = `width: 100%; padding: 0.75rem 2.5rem 0.75rem 0.75rem; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 0.875rem; background: white; cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='${primaryColour.replace('#', '%23')}' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 1.25rem; transition: all 0.2s; font-family: inherit;`;
      const helpStyle = `display: block; margin-top: 0.25rem; font-size: 0.875rem; color: #6B7280;`;
      const focusEvents = `onmouseover="this.style.borderColor='${primaryColour}'; this.style.boxShadow='0 0 0 3px ${primaryColour}22';" onmouseout="this.style.borderColor='#E5E7EB'; this.style.boxShadow='none';" onfocus="this.style.borderColor='${primaryColour}'; this.style.boxShadow='0 0 0 3px ${primaryColour}22'; this.style.outline='none';" onblur="this.style.borderColor='#E5E7EB'; this.style.boxShadow='none';"`;

      // Add data attributes for conditional display
      const showForGender = field.show_for_gender || 'both';
      const dataAttrs = `data-field-id="${field.id}" data-show-for-gender="${showForGender}"`;

      let fieldHtml = `<div style="margin-bottom: 1.5rem;" ${dataAttrs} class="preview-field">`;

      if (field.field_type === 'checkbox') {
        fieldHtml += `
          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
            <input type="checkbox" ${field.is_required ? 'required' : ''}>
            <span style="font-weight: 500; color: ${settings.primary_colour || '#091825'};">${field.field_label}${field.is_required ? ' <span style="color: #EF4444;">*</span>' : ''}</span>
          </label>
        `;
      } else {
        fieldHtml += `
          <label style="${labelStyle}">
            ${field.field_label}${field.is_required ? ' <span style="color: #EF4444;">*</span>' : ''}
          </label>
        `;

        if (field.field_type === 'textarea') {
          fieldHtml += `<textarea style="${inputStyle}" rows="4" placeholder="${field.placeholder || ''}" ${field.is_required ? 'required' : ''} ${focusEvents}></textarea>`;
        } else if (field.field_type === 'select') {
          const options = field.field_options ? field.field_options.split(/\r?\n/).map(o => o.trim()).filter(o => o) : [];
          // Check if this is a gender field (by label)
          const isGenderField = field.field_label.toLowerCase().includes('gender');
          const genderId = isGenderField ? 'id="preview-gender-field"' : '';
          const onChangeEvent = isGenderField ? 'onchange="handlePreviewGenderChange(this.value)"' : '';

          fieldHtml += `
            <select
              style="${selectStyle}"
              ${field.is_required ? 'required' : ''}
              ${genderId}
              ${onChangeEvent}
              ${focusEvents}
            >
              <option value="" style="color: #9CA3AF;">-- Please Select --</option>
              ${options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
            </select>
          `;
        } else {
          fieldHtml += `<input type="${field.field_type}" style="${inputStyle}" placeholder="${field.placeholder || ''}" ${field.is_required ? 'required' : ''} ${focusEvents}>`;
        }
      }

      if (field.help_text) {
        fieldHtml += `<small style="${helpStyle}">${field.help_text}</small>`;
      }

      fieldHtml += `</div>`;
      return fieldHtml;
    }

    // Handle gender change in preview
    function handlePreviewGenderChange(selectedGender) {
      // Get all fields with conditional gender visibility
      const allFields = document.querySelectorAll('.preview-field');

      allFields.forEach(fieldDiv => {
        const showForGender = fieldDiv.getAttribute('data-show-for-gender');

        if (!showForGender || showForGender === 'both') {
          // Always show fields that are for both genders
          fieldDiv.style.display = 'block';
        } else if (!selectedGender) {
          // If no gender selected, show all fields
          fieldDiv.style.display = 'block';
        } else {
          // Check if the selected gender matches the field's requirement
          const selectedLower = selectedGender.toLowerCase();
          const shouldShow = showForGender === 'both' ||
                           (showForGender === 'male' && (selectedLower === 'male' || selectedLower === 'boy' || selectedLower === 'man')) ||
                           (showForGender === 'female' && (selectedLower === 'female' || selectedLower === 'girl' || selectedLower === 'woman'));

          fieldDiv.style.display = shouldShow ? 'block' : 'none';
        }
      });
    }

    // Settings
    async function loadSettings() {
      try {
        const res = await fetch(`${API_URL}/api/booking-settings/${SCHOOL_ID}`);
        const data = await res.json();
        currentSettings = data.settings; // Store for use in saveSettings
        renderSettings(data.settings);
      } catch (error) {
        console.error('Load settings error:', error);
      }
    }

    function renderSettings(settings) {
      const container = document.getElementById('settings-form');
      container.innerHTML = `
        <form id="settingsForm">
          <h3 style="color: var(--blazer-navy); margin-bottom: 1.5rem; border-bottom: 2px solid var(--award-gold); padding-bottom: 0.5rem;">General Settings</h3>

          <div class="form-group">
            <label class="form-label">School Name</label>
            <input type="text" class="form-input" name="school_name" value="${settings.school_name || 'More House School'}" required>
            <small style="display: block; margin-top: 0.5rem; color: #6B7280;">This name will be used in email templates and communications</small>
          </div>
          <div class="form-group">
            <label class="form-label">Default Tour Duration (minutes)</label>
            <input type="number" class="form-input" name="default_tour_duration" value="${settings.default_tour_duration}" required>
          </div>
          <div class="form-group">
            <label class="form-label">Booking Window (days ahead)</label>
            <input type="number" class="form-input" name="booking_window_days" value="${settings.booking_window_days}" required>
          </div>
          <div class="form-group">
            <label class="form-label">Cancellation Window (hours before)</label>
            <input type="number" class="form-input" name="cancellation_window_hours" value="${settings.cancellation_window_hours}" required>
          </div>
          <div class="form-group">
            <label class="form-label">Max Concurrent Tours</label>
            <input type="number" class="form-input" name="max_concurrent_tours" value="${settings.max_concurrent_tours}" required>
          </div>
          <div class="form-group">
            <label class="form-label">
              <input type="checkbox" name="requires_approval" ${settings.requires_approval ? 'checked' : ''}>
              Require approval for open day bookings
            </label>
          </div>
          <div class="form-group">
            <label class="form-label">
              <input type="checkbox" name="allow_waitlist" ${settings.allow_waitlist ? 'checked' : ''}>
              Allow waitlist when full
            </label>
          </div>

          <h3 style="color: var(--blazer-navy); margin: 2rem 0 1.5rem; border-bottom: 2px solid var(--award-gold); padding-bottom: 0.5rem;">Private Tour Settings</h3>

          <div class="form-group">
            <label class="form-label">
              <input type="checkbox" name="private_tour_enabled" ${settings.private_tour_enabled !== false ? 'checked' : ''}>
              Enable Private Tour Bookings
            </label>
            <small style="display: block; margin-top: 0.5rem; color: #6B7280;">Allow parents to request private tours</small>
          </div>

          <div class="form-group">
            <label class="form-label">Private Tour Duration (minutes)</label>
            <input type="number" class="form-input" name="private_tour_duration_minutes" value="${settings.private_tour_duration_minutes || 90}" required>
            <small style="display: block; margin-top: 0.5rem; color: #6B7280;">Default duration for private tours</small>
          </div>

          <div class="form-group">
            <label class="form-label">Minimum Notice (days)</label>
            <input type="number" class="form-input" name="private_tour_min_notice_days" value="${settings.private_tour_min_notice_days || 3}" required>
            <small style="display: block; margin-top: 0.5rem; color: #6B7280;">Minimum days in advance for private tour requests</small>
          </div>

          <div class="form-group">
            <label class="form-label">Maximum Advance Booking (days)</label>
            <input type="number" class="form-input" name="private_tour_max_advance_days" value="${settings.private_tour_max_advance_days || 90}" required>
            <small style="display: block; margin-top: 0.5rem; color: #6B7280;">How far ahead parents can book</small>
          </div>

          <div class="form-group">
            <label class="form-label">Maximum Attendees</label>
            <input type="number" class="form-input" name="private_tour_max_attendees" value="${settings.private_tour_max_attendees || 6}" required>
            <small style="display: block; margin-top: 0.5rem; color: #6B7280;">Maximum number of attendees per private tour</small>
          </div>

          <div class="form-group">
            <label class="form-label">Buffer Between Tours (minutes)</label>
            <input type="number" class="form-input" name="private_tour_buffer_minutes" value="${settings.private_tour_buffer_minutes || 30}" required>
            <small style="display: block; margin-top: 0.5rem; color: #6B7280;">Time buffer between consecutive private tours</small>
          </div>

          <div class="form-group">
            <label class="form-label">Tour Start Time</label>
            <input type="time" class="form-input" name="private_tour_start_time" value="${settings.private_tour_start_time || '09:00'}" required>
          </div>

          <div class="form-group">
            <label class="form-label">Tour End Time</label>
            <input type="time" class="form-input" name="private_tour_end_time" value="${settings.private_tour_end_time || '15:00'}" required>
          </div>

          <button type="submit" class="btn btn-primary">Save Booking Settings</button>
        </form>
      `;

      document.getElementById('settingsForm').addEventListener('submit', saveSettings);
    }

    let currentSettings = null; // Store current settings for reference

    async function saveSettings(e) {
      e.preventDefault();
      const formData = new FormData(e.target);

      const data = {
        // Include required fields from current settings (not in form)
        tour_duration_options: currentSettings?.tour_duration_options || null,
        available_days: currentSettings?.available_days || null,
        tour_start_time: currentSettings?.tour_start_time || null,
        tour_end_time: currentSettings?.tour_end_time || null,
        // Preserve prospectus and branding settings
        has_prospectus_app: currentSettings?.has_prospectus_app,
        prospectus_url: currentSettings?.prospectus_url,
        logo_url: currentSettings?.logo_url,
        logo_size: currentSettings?.logo_size,
        form_heading: currentSettings?.form_heading,
        form_subtitle: currentSettings?.form_subtitle,
        primary_colour: currentSettings?.primary_colour,
        secondary_colour: currentSettings?.secondary_colour,
        // Form fields
        school_name: formData.get('school_name'),
        default_tour_duration: parseInt(formData.get('default_tour_duration')),
        booking_window_days: parseInt(formData.get('booking_window_days')),
        cancellation_window_hours: parseInt(formData.get('cancellation_window_hours')),
        max_concurrent_tours: parseInt(formData.get('max_concurrent_tours')),
        requires_approval: formData.get('requires_approval') === 'on',
        allow_waitlist: formData.get('allow_waitlist') === 'on',
        // Private tour settings
        private_tour_enabled: formData.get('private_tour_enabled') === 'on',
        private_tour_duration_minutes: parseInt(formData.get('private_tour_duration_minutes')),
        private_tour_min_notice_days: parseInt(formData.get('private_tour_min_notice_days')),
        private_tour_max_advance_days: parseInt(formData.get('private_tour_max_advance_days')),
        private_tour_max_attendees: parseInt(formData.get('private_tour_max_attendees')),
        private_tour_buffer_minutes: parseInt(formData.get('private_tour_buffer_minutes')),
        private_tour_start_time: formData.get('private_tour_start_time'),
        private_tour_end_time: formData.get('private_tour_end_time')
      };

      try {
        const res = await fetch(`${API_URL}/api/booking-settings/${SCHOOL_ID}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (res.ok) {
          alert('Booking settings saved successfully');
          // Reload settings tab to show updated values
          loadSettings();
        } else {
          alert('Failed to save booking settings');
        }
      } catch (error) {
        console.error('Save settings error:', error);
        alert('Failed to save booking settings');
      }
    }

    // ====================
    // PROSPECTUS INTEGRATION SETTINGS
    // ====================

    function renderProspectusSettings(settings) {
      const container = document.getElementById('prospectus-form');
      container.innerHTML = `
        <form id="prospectusForm">
          <div class="form-group">
            <label class="form-label">
              <input type="checkbox" name="has_prospectus_app" ${settings.has_prospectus_app ? 'checked' : ''}>
              School uses Personalised Prospectus App
            </label>
            <small style="display: block; margin-top: 0.5rem; color: #6B7280;">Enable this if your school uses the personalised prospectus enquiry form</small>
          </div>

          <div class="form-group">
            <label class="form-label">Prospectus Form URL</label>
            <input type="url" class="form-input" name="prospectus_url" value="${settings.prospectus_url || ''}" placeholder="http://localhost:3000/">
            <small style="display: block; margin-top: 0.5rem; color: #6B7280;">URL to your personalised prospectus enquiry form (new users will be redirected here to complete their details)</small>
          </div>

          <button type="submit" class="btn btn-primary">Save Prospectus Settings</button>
        </form>
      `;

      document.getElementById('prospectusForm').addEventListener('submit', saveProspectusSettings);
    }

    async function saveProspectusSettings(e) {
      e.preventDefault();
      const formData = new FormData(e.target);

      const data = {
        // Preserve all other settings
        ...currentSettings,
        // Update prospectus fields
        has_prospectus_app: formData.get('has_prospectus_app') === 'on',
        prospectus_url: formData.get('prospectus_url') || null
      };

      try {
        const res = await fetch(`${API_URL}/api/booking-settings/${SCHOOL_ID}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (res.ok) {
          alert('Prospectus settings saved successfully');
          // Reload to update current settings
          const resData = await fetch(`${API_URL}/api/booking-settings/${SCHOOL_ID}`);
          const updatedData = await resData.json();
          currentSettings = updatedData.settings;
          renderProspectusSettings(currentSettings);
        } else {
          alert('Failed to save prospectus settings');
        }
      } catch (error) {
        console.error('Save prospectus settings error:', error);
        alert('Failed to save prospectus settings');
      }
    }

    // ====================
    // BRANDING SETTINGS
    // ====================

    function renderBrandingSettings(settings) {
      const container = document.getElementById('branding-form');
      // Use logo_data (base64) if available, otherwise fall back to logo_url
      const currentLogo = settings.logo_data || settings.logo_url || '';
      const isFromDatabase = settings.logo_data ? true : false;
      container.innerHTML = `
        <form id="brandingForm">
          <div class="form-group">
            <label class="form-label">School Logo</label>
            ${currentLogo ? `
              <div style="margin-bottom: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; text-align: center;">
                <img src="${currentLogo}" alt="Current logo" style="max-width: 200px; max-height: 100px; object-fit: contain;">
                <p style="margin-top: 0.5rem; font-size: 0.8rem; color: #666;">Current logo ${isFromDatabase ? '(stored in database)' : ''}</p>
              </div>
            ` : ''}
            <div style="display: flex; gap: 1rem; align-items: flex-start; flex-wrap: wrap;">
              <div style="flex: 1; min-width: 200px;">
                <label style="display: block; padding: 2rem; border: 2px dashed #d1d5db; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s;"
                       onmouseover="this.style.borderColor='#FF6B9D'; this.style.background='#fff5f8';"
                       onmouseout="this.style.borderColor='#d1d5db'; this.style.background='transparent';">
                  <input type="file" id="logoUpload" accept="image/*" style="display: none;" onchange="uploadLogo(this)">
                  <div style="font-size: 2rem; margin-bottom: 0.5rem;">ðŸ“¤</div>
                  <div style="font-weight: 500; color: #374151;">Click to upload logo</div>
                  <div style="font-size: 0.8rem; color: #6B7280; margin-top: 0.25rem;">PNG, JPG, SVG up to 5MB</div>
                </label>
              </div>
              <div style="flex: 1; min-width: 200px;">
                <label class="form-label" style="margin-bottom: 0.5rem;">Or enter logo path/URL</label>
                <input type="text" class="form-input" name="logo_url" value="${isFromDatabase ? '' : (settings.logo_url || '')}" placeholder="/morehouse-logo.jpg or https://...">
                <small style="display: block; margin-top: 0.25rem; color: #6B7280;">Leave blank to use uploaded logo</small>
              </div>
            </div>
            <div id="uploadStatus" style="margin-top: 0.5rem;"></div>
            <small style="display: block; margin-top: 0.5rem; color: #6B7280;">Logo will be displayed on the enquiry form and briefing packs</small>
          </div>

          <div class="form-group">
            <label class="form-label">Logo Size</label>
            <select class="form-input" name="logo_size">
              <option value="small" ${settings.logo_size === 'small' ? 'selected' : ''}>Small (150px)</option>
              <option value="medium" ${settings.logo_size === 'medium' || !settings.logo_size ? 'selected' : ''}>Medium (200px)</option>
              <option value="large" ${settings.logo_size === 'large' ? 'selected' : ''}>Large (300px)</option>
              <option value="xlarge" ${settings.logo_size === 'xlarge' ? 'selected' : ''}>Extra Large (400px)</option>
            </select>
            <small style="display: block; margin-top: 0.5rem; color: #6B7280;">Maximum width of the logo on the enquiry form</small>
          </div>

          <div class="form-group">
            <label class="form-label">Form Heading</label>
            <input type="text" class="form-input" name="form_heading" value="${settings.form_heading || 'Enquiry Form'}" placeholder="Enquiry Form">
            <small style="display: block; margin-top: 0.5rem; color: #6B7280;">Main heading displayed at the top of the enquiry form</small>
          </div>

          <div class="form-group">
            <label class="form-label">Form Subtitle</label>
            <input type="text" class="form-input" name="form_subtitle" value="${settings.form_subtitle || 'Please complete the form below'}" placeholder="Please complete the form below">
            <small style="display: block; margin-top: 0.5rem; color: #6B7280;">Subtitle text shown below the heading</small>
          </div>

          <div class="form-group">
            <label class="form-label">Primary Brand Colour</label>
            <div style="display: flex; gap: 1rem; align-items: center;">
              <input type="color" id="primary_colour_picker" value="${settings.primary_colour || '#091825'}" style="width: 60px; height: 40px; padding: 2px; border: 1px solid #E5E7EB; border-radius: 4px; cursor: pointer;">
              <input type="text" class="form-input" id="primary_colour_text" name="primary_colour" value="${settings.primary_colour || '#091825'}" placeholder="#091825" pattern="^#[0-9A-Fa-f]{6}$" style="flex: 1;">
            </div>
            <small style="display: block; margin-top: 0.5rem; color: #6B7280;">Main colour for headers and buttons (hex format: #RRGGBB)</small>
          </div>

          <div class="form-group">
            <label class="form-label">Secondary Brand Colour</label>
            <div style="display: flex; gap: 1rem; align-items: center;">
              <input type="color" id="secondary_colour_picker" value="${settings.secondary_colour || '#FF9F1C'}" style="width: 60px; height: 40px; padding: 2px; border: 1px solid #E5E7EB; border-radius: 4px; cursor: pointer;">
              <input type="text" class="form-input" id="secondary_colour_text" name="secondary_colour" value="${settings.secondary_colour || '#FF9F1C'}" placeholder="#FF9F1C" pattern="^#[0-9A-Fa-f]{6}$" style="flex: 1;">
            </div>
            <small style="display: block; margin-top: 0.5rem; color: #6B7280;">Accent colour for highlights and borders (hex format: #RRGGBB)</small>
          </div>

          <button type="submit" class="btn btn-primary">Save Branding Settings</button>
        </form>
      `;

      // Add event listeners to sync colour pickers with text fields
      const primaryColourPicker = document.getElementById('primary_colour_picker');
      const primaryColourText = document.getElementById('primary_colour_text');
      const secondaryColourPicker = document.getElementById('secondary_colour_picker');
      const secondaryColourText = document.getElementById('secondary_colour_text');

      primaryColourPicker.addEventListener('input', (e) => {
        primaryColourText.value = e.target.value.toUpperCase();
      });

      secondaryColourPicker.addEventListener('input', (e) => {
        secondaryColourText.value = e.target.value.toUpperCase();
      });

      primaryColourText.addEventListener('input', (e) => {
        if (/^#[0-9A-Fa-f]{6}$/.test(e.target.value)) {
          primaryColourPicker.value = e.target.value;
        }
      });

      secondaryColourText.addEventListener('input', (e) => {
        if (/^#[0-9A-Fa-f]{6}$/.test(e.target.value)) {
          secondaryColourPicker.value = e.target.value;
        }
      });

      document.getElementById('brandingForm').addEventListener('submit', saveBrandingSettings);
    }

    // Upload logo file (global function for inline handler)
    window.uploadLogo = async function(input) {
      const file = input.files[0];
      if (!file) return;

      const statusDiv = document.getElementById('uploadStatus');
      statusDiv.innerHTML = '<span style="color: #6B7280;">Uploading...</span>';

      const formData = new FormData();
      formData.append('logo', file);

      try {
        const res = await fetch(`${API_URL}/api/settings/upload-logo`, {
          method: 'POST',
          body: formData
        });

        const data = await res.json();

        if (data.success) {
          statusDiv.innerHTML = '<span style="color: #10B981;">Logo uploaded successfully!</span>';
          // Update the URL input and preview
          document.querySelector('input[name="logo_url"]').value = data.logo_url;
          // Reload branding settings to show new logo
          const resData = await fetch(`${API_URL}/api/booking-settings/${SCHOOL_ID}`);
          const updatedData = await resData.json();
          currentSettings = updatedData.settings;
          renderBrandingSettings(currentSettings);
        } else {
          statusDiv.innerHTML = `<span style="color: #EF4444;">Upload failed: ${data.error}</span>`;
        }
      } catch (error) {
        console.error('Upload error:', error);
        statusDiv.innerHTML = '<span style="color: #EF4444;">Upload failed. Please try again.</span>';
      }
    }

    async function saveBrandingSettings(e) {
      e.preventDefault();
      const formData = new FormData(e.target);

      const data = {
        // Preserve all other settings
        ...currentSettings,
        // Update branding fields
        logo_url: formData.get('logo_url') || null,
        logo_size: formData.get('logo_size') || 'medium',
        form_heading: formData.get('form_heading') || 'Enquiry Form',
        form_subtitle: formData.get('form_subtitle') || 'Please complete the form below',
        primary_colour: formData.get('primary_colour') || '#091825',
        secondary_colour: formData.get('secondary_colour') || '#FF9F1C'
      };

      try {
        const res = await fetch(`${API_URL}/api/booking-settings/${SCHOOL_ID}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (res.ok) {
          alert('Branding settings saved successfully');
          // Reload to update current settings
          const resData = await fetch(`${API_URL}/api/booking-settings/${SCHOOL_ID}`);
          const updatedData = await resData.json();
          currentSettings = updatedData.settings;
          renderBrandingSettings(currentSettings);
        } else {
          alert('Failed to save branding settings');
        }
      } catch (error) {
        console.error('Save branding settings error:', error);
        alert('Failed to save branding settings');
      }
    }

    // ====================
    // EMAIL SETTINGS
    // ====================

    // Load email settings when tab is shown
    document.querySelectorAll('[data-tab="email-settings"]').forEach(btn => {
      btn.addEventListener('click', loadEmailSettings);
    });

    async function loadEmailSettings() {
      try {
        const res = await fetch(`${API_URL}/api/email-settings/${SCHOOL_ID}`);
        const data = await res.json();

        if (res.ok && data.settings) {
          // Populate email config form
          const emailForm = document.getElementById('email-settings-form');
          if (emailForm) {
            emailForm.smtp_host.value = data.settings.smtp_host || '';
            emailForm.smtp_port.value = data.settings.smtp_port || 587;
            emailForm.smtp_username.value = data.settings.smtp_username || '';
            emailForm.smtp_password.value = data.settings.smtp_password || '';
            emailForm.smtp_from_email.value = data.settings.smtp_from_email || '';
            emailForm.smtp_from_name.value = data.settings.smtp_from_name || 'School Bookings';
            emailForm.smtp_use_tls.checked = data.settings.smtp_use_tls !== false;
          }

          // Populate email timing form
          const timingForm = document.getElementById('email-timing-form');
          if (timingForm) {
            timingForm.reminder_days_before_1.value = data.settings.reminder_days_before_1 || 7;
            timingForm.reminder_days_before_2.value = data.settings.reminder_days_before_2 || 1;
            timingForm.followup_days_after.value = data.settings.followup_days_after || 1;
            timingForm.guide_reminder_days_before_1.value = data.settings.guide_reminder_days_before_1 || 3;
            timingForm.guide_reminder_days_before_2.value = data.settings.guide_reminder_days_before_2 || 1;
          }
        }
      } catch (error) {
        console.error('Load email settings error:', error);
      }
    }

    // Save email settings
    document.getElementById('email-settings-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);

      const data = {
        smtp_host: formData.get('smtp_host'),
        smtp_port: parseInt(formData.get('smtp_port')),
        smtp_username: formData.get('smtp_username'),
        smtp_password: formData.get('smtp_password'),
        smtp_from_email: formData.get('smtp_from_email'),
        smtp_from_name: formData.get('smtp_from_name'),
        smtp_use_tls: formData.get('smtp_use_tls') === 'on'
      };

      try {
        const res = await fetch(`${API_URL}/api/email-settings/${SCHOOL_ID}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (res.ok) {
          showEmailAlert('Email settings saved successfully!', 'success');
        } else {
          const error = await res.json();
          showEmailAlert('Failed to save email settings: ' + (error.error || 'Unknown error'), 'error');
        }
      } catch (error) {
        console.error('Save email settings error:', error);
        showEmailAlert('Failed to save email settings', 'error');
      }
    });

    // Save email timing settings
    document.getElementById('email-timing-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);

      const data = {
        reminder_days_before_1: parseInt(formData.get('reminder_days_before_1')),
        reminder_days_before_2: parseInt(formData.get('reminder_days_before_2')),
        followup_days_after: parseInt(formData.get('followup_days_after')),
        guide_reminder_days_before_1: parseInt(formData.get('guide_reminder_days_before_1')),
        guide_reminder_days_before_2: parseInt(formData.get('guide_reminder_days_before_2'))
      };

      try {
        const res = await fetch(`${API_URL}/api/email-settings/${SCHOOL_ID}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (res.ok) {
          showEmailAlert('Email timing settings saved successfully!', 'success');
        } else {
          const error = await res.json();
          showEmailAlert('Failed to save email timing settings: ' + (error.error || 'Unknown error'), 'error');
        }
      } catch (error) {
        console.error('Save email timing settings error:', error);
        showEmailAlert('Failed to save email timing settings', 'error');
      }
    });

    // Test email functionality
    async function testEmailSettings() {
      const form = document.getElementById('email-settings-form');
      const formData = new FormData(form);

      const data = {
        smtp_host: formData.get('smtp_host'),
        smtp_port: parseInt(formData.get('smtp_port')),
        smtp_username: formData.get('smtp_username'),
        smtp_password: formData.get('smtp_password'),
        smtp_from_email: formData.get('smtp_from_email'),
        smtp_from_name: formData.get('smtp_from_name'),
        smtp_use_tls: formData.get('smtp_use_tls') === 'on',
        test_email: formData.get('smtp_from_email') // Send test to same email
      };

      if (!data.smtp_host || !data.smtp_username || !data.smtp_password) {
        showEmailAlert('Please fill in all required fields first', 'error');
        return;
      }

      showEmailAlert('Sending test email...', 'info');

      try {
        const url = `${API_URL}/api/email-settings/test`;
        console.log('ðŸ” Test email URL:', url);
        console.log('ðŸ” Test email data:', data);

        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const result = await res.json();

        if (res.ok) {
          showEmailAlert(`Test email sent successfully to ${data.test_email}!`, 'success');
        } else {
          showEmailAlert('Failed to send test email: ' + (result.error || 'Unknown error'), 'error');
        }
      } catch (error) {
        console.error('Test email error:', error);
        showEmailAlert('Failed to send test email', 'error');
      }
    }

    // Show alert message
    function showEmailAlert(message, type) {
      const alert = document.getElementById('email-settings-alert');
      const colors = {
        success: { bg: '#D1FAE5', border: '#10B981', text: '#065F46' },
        error: { bg: '#FEE2E2', border: '#EF4444', text: '#991B1B' },
        info: { bg: '#DBEAFE', border: '#3B82F6', text: '#1E40AF' }
      };
      const color = colors[type] || colors.info;

      alert.innerHTML = message;
      alert.style.display = 'block';
      alert.style.padding = '1rem';
      alert.style.borderRadius = '8px';
      alert.style.backgroundColor = color.bg;
      alert.style.border = `2px solid ${color.border}`;
      alert.style.color = color.text;
      alert.style.fontWeight = '600';

      if (type === 'success' || type === 'error') {
        setTimeout(() => {
          alert.style.display = 'none';
        }, 5000);
      }
    }

    // Make all functions globally accessible for onclick handlers
    window.closeModal = closeModal;
    window.showCreateEmailTemplateModal = showCreateEmailTemplateModal;
    window.showCreateEventModal = showCreateEventModal;
    window.showCreateGuideModal = showCreateGuideModal;
    window.showEditEventModal = showEditEventModal;
    window.showEditGuideModal = showEditGuideModal;
    window.showPrintGuideAssignmentsModal = showPrintGuideAssignmentsModal;
    window.showAddFieldModal = showAddFieldModal;
    window.showAddSectionModal = showAddSectionModal;
    window.showEditFieldModal = showEditFieldModal;
    window.showEditSectionModal = showEditSectionModal;
    window.addBookingNote = addBookingNote;
    window.deleteEmailTemplate = deleteEmailTemplate;
    window.deleteEvent = deleteEvent;
    window.deleteFormField = deleteFormField;
    window.deleteGuide = deleteGuide;
    window.deleteSection = deleteSection;
    window.editEmailTemplate = editEmailTemplate;
    window.addAlternativeDateRow = addAlternativeDateRow;
    window.testEmailSettings = testEmailSettings;
    window.showScheduleModal = showScheduleModal;
    window.showDeclineModal = showDeclineModal;
    window.showEditBookingModal = showEditBookingModal;
    window.checkInBooking = checkInBooking;
    window.markAsNoShow = markAsNoShow;
    window.updateBookingStatus = updateBookingStatus;
    window.showAssignGuideModal = showAssignGuideModal;
    window.submitAssignGuide = submitAssignGuide;
    window.printGuideAssignments = printGuideAssignments;
    window.showPreviewFormModal = showPreviewFormModal;

    // Initial load
    loadDashboard();
  } // End of init() function
  </script>

  <!-- Footer -->
  <div class="footer-badge">
    Powered by <span class="bsmart-text">bSMART</span> ai
  </div>
</body>
</html>
